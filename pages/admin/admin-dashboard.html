<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - WATER WORLD</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
    <!-- Reuse site design system and header styles to match index color scheme -->
    <link rel="stylesheet" href="/WRSOMS/assets/css/design-system.css">
    <link rel="stylesheet" href="/WRSOMS/assets/css/header.css">
    <link rel="stylesheet" href="/WRSOMS/assets/css/admin.css">
    
</head>
<body>
    <nav class="sidebar" aria-label="Main navigation">
        <div class="logo-container nav-brand">
            <img src="/WRSOMS/assets/images/ww_logo.png" alt="Water World Logo" class="nav-logo logo-img">
            <span class="brand-name">Water World</span>
        </div>
        <ul>
            <li class="active"><button type="button" onclick="showDashboard()"><i class="fa fa-tachometer"></i> Dashboard</button></li>
            <li><a href="manage_orders.php"><i class="fa fa-shopping-cart"></i> Manage Orders</a></li>
            <li><a href="status.php"><i class="fa fa-list"></i> Manage Status</a></li>
            <li><button type="button" onclick="showDailyReport()"><i class="fa fa-calendar"></i> Daily Report</button></li>
        </ul>
    </nav>
    <div class="sidebar-report" id="reportSidebar">
        <span class="close-btn" onclick="toggleReportSidebar()">&times;</span>
        <ul id="reportDates"></ul>
    </div>
    <main class="content" aria-label="Dashboard content" id="mainContent">
        <div class="dashboard-inner">
        <header class="header">
            <h1 class="title">Dashboard</h1>
            <div class="date-time" aria-live="polite">Date:  | Time: </div>
        </header>
        <section class="quick-actions" aria-label="Quick actions">
            <button type="button" onclick="location.reload();" aria-label="Refresh dashboard data">Refresh Data</button>
        </section>
        <section class="metrics" aria-label="Key metrics">
            <div class="metric-card" data-color="blue" role="region" aria-label="Total Orders">
                <div class="metric-card-inner">
                    <span class="metric-icon"><i class="fa fa-list-alt"></i></span>
                    <div class="metric-text"><h3>Total Orders</h3><p id="totalOrdersVal">—</p></div>
                </div>
            </div>
            <div class="metric-card" data-color="green" role="region" aria-label="Pending Orders">
                <div class="metric-card-inner">
                    <span class="metric-icon"><i class="fa fa-clock-o"></i></span>
                    <div class="metric-text"><h3>Pending Orders</h3><p id="pendingOrdersVal">—</p></div>
                </div>
            </div>
            <div class="metric-card" data-color="purple" role="region" aria-label="Completed Orders">
                <div class="metric-card-inner">
                    <span class="metric-icon"><i class="fa fa-check-circle"></i></span>
                    <div class="metric-text"><h3>Completed Orders</h3><p id="completedOrdersVal">—</p></div>
                </div>
            </div>
            <div class="metric-card" data-color="teal" role="region" aria-label="Total Revenue">
                <div class="metric-card-inner">
                    <span class="metric-icon"><i class="fa fa-money"></i></span>
                    <div class="metric-text"><h3>Total Revenue</h3><p id="totalRevenueVal">—</p></div>
                </div>
            </div>
            <div class="metric-card" data-color="pink" role="region" aria-label="Average Order Value">
                <div class="metric-card-inner">
                    <span class="metric-icon"><i class="fa fa-calculator"></i></span>
                    <div class="metric-text"><h3>Avg Order Value</h3><p id="avgOrderVal">—</p></div>
                </div>
            </div>
            <div class="metric-card" data-color="gray" role="region" aria-label="Pending Deliveries">
                <div class="metric-card-inner">
                    <span class="metric-icon"><i class="fa fa-truck"></i></span>
                    <div class="metric-text"><h3>Pending Deliveries</h3><p id="pendingDeliveriesVal">—</p></div>
                </div>
            </div>
        </section>
        <section class="metric-card" role="region" aria-label="Batch Overview">
            <h3>Batch Overview</h3>
            <table class="batch-table" aria-describedby="batch-table-desc">
                <caption id="batch-table-desc" class="sr-only">Overview of batches by vehicle type, batch number, order count, and status</caption>
                <thead>
                    <tr>
                        <th scope="col">Vehicle Type</th>
                        <th scope="col">Batch #</th>
                        <th scope="col">Orders</th>
                        <th scope="col">Status</th>
                    </tr>
                </thead>
                <tbody id="batchBody">
                    <!-- Populated by client-side JS -->
                </tbody>
            </table>
        </section>
        <section class="metric-card" role="region" aria-label="Recent Orders">
            <h3>Recent Orders</h3>
            <table class="recent-orders-table" aria-describedby="recent-orders-table-desc">
                <caption id="recent-orders-table-desc" class="sr-only">List of recent orders with order ID, date, amount, and status</caption>
                <thead>
                    <tr>
                        <th scope="col">Order ID</th>
                        <th scope="col">Date</th>
                        <th scope="col">Amount</th>
                        <th scope="col">Status</th>
                    </tr>
                </thead>
                <tbody id="recentOrdersBody">
                    <!-- Populated by client-side JS -->
                </tbody>
            </table>
        </section>
        </div>
    </main>
    <script>
        let originalContent = document.getElementById('mainContent').innerHTML;

        function showDashboard() {
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = '';
            mainContent.innerHTML = originalContent;
            document.getElementById('reportSidebar').classList.remove('active');
            document.querySelector('.sidebar li.active').classList.remove('active');
            document.querySelector('.sidebar li button[onclick="showDashboard()"]').parentElement.classList.add('active');
        }

        function toggleReportSidebar() {
            document.getElementById('reportSidebar').classList.toggle('active');
        }

        function showDailyReport(date = '') {
            fetch('daily_report.php?date=' + encodeURIComponent(date))
                .then(response => response.text())
                .then(data => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(data, 'text/html');
                    const content = doc.querySelector('.container').outerHTML;
                    const scripts = Array.from(doc.querySelectorAll('script')).map(script => script.textContent).join('\n');
                    document.getElementById('mainContent').innerHTML = content;

                    const scriptElement = document.createElement('script');
                    scriptElement.textContent = scripts;
                    document.getElementById('mainContent').appendChild(scriptElement);

                    document.querySelector('.sidebar li.active').classList.remove('active');
                    document.querySelector('.sidebar li button[onclick="showDailyReport()"]').parentElement.classList.add('active');

                    fetchDates();
                })
                .catch(error => {
                    console.error('Error fetching daily report:', error);
                    document.getElementById('mainContent').innerHTML = '<p>Error loading daily report. Please try again.</p>';
                });
        }

        function fetchDates() {
            fetch('daily_report.php?get_dates=true')
                .then(response => response.json())
                .then(dates => {
                    const ul = document.getElementById('reportDates');
                    ul.innerHTML = '';
                    dates.forEach(d => {
                        const li = document.createElement('li');
                        const a = document.createElement('a');
                        a.href = '#';
                        a.textContent = d;
                        a.onclick = () => showDailyReport(d);
                        li.appendChild(a);
                        ul.appendChild(li);
                    });
                })
                .catch(error => console.error('Error fetching dates:', error));
        }

        const bootstrapScript = document.createElement('script');
        bootstrapScript.src = 'https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js';
        document.body.appendChild(bootstrapScript);
    
    // Fetch dashboard data from API and populate UI
    (function loadDashboard() {
        const apiUrl = '/WRSOMS/api/admin/dashboard.php';

        function money(v) {
            return '₱' + Number(v).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        fetch(apiUrl, { credentials: 'same-origin' })
            .then(r => r.json())
            .then(res => {
                if (!res.success) throw new Error(res.message || 'Failed to load');
                const data = res.data || {};
                const stats = data.stats || {};

                document.getElementById('totalOrdersVal').textContent = stats.total_orders ?? '0';
                document.getElementById('pendingOrdersVal').textContent = stats.pending_orders ?? '0';
                document.getElementById('completedOrdersVal').textContent = stats.completed_orders ?? '0';
                document.getElementById('totalRevenueVal').textContent = money(stats.total_revenue ?? 0);
                document.getElementById('avgOrderVal').textContent = money(stats.avg_order_value ?? 0);
                document.getElementById('pendingDeliveriesVal').textContent = stats.pending_deliveries ?? '0';

                // Batch details
                const batchBody = document.getElementById('batchBody');
                batchBody.innerHTML = '';
                // Build a map for quick lookup
                const batches = {};
                (data.batch_details || []).forEach(b => {
                    const key = b.vehicle_type + '-' + b.batch_number;
                    batches[key] = b;
                });
                for (let i = 1; i <= 3; i++) {
                    ['Tricycle', 'Car'].forEach(vehicle_type => {
                        const key = vehicle_type + '-' + i;
                        const b = batches[key] || { vehicle_type, batch_number: i, order_count: 0, batch_status: 'N/A' };
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${escapeHtml(b.vehicle_type)}</td>
                            <td>#${escapeHtml(b.batch_number)}</td>
                            <td>${escapeHtml(b.order_count)}</td>
                            <td>${escapeHtml(b.batch_status)}</td>
                        `;
                        batchBody.appendChild(tr);
                    });
                }

                // Recent orders
                const recentBody = document.getElementById('recentOrdersBody');
                recentBody.innerHTML = '';
                (data.recent_orders || []).forEach(o => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${escapeHtml(o.reference_id)}</td>
                        <td>${escapeHtml(o.order_date)}</td>
                        <td>${escapeHtml(Number(o.total_amount).toFixed(2))}</td>
                        <td>${escapeHtml(o.order_status || '')}</td>
                    `;
                    recentBody.appendChild(tr);
                });

                // Update header date/time
                const dt = new Date();
                const dateTime = document.querySelector('.header .date-time');
                if (dateTime) dateTime.textContent = `Date: ${dt.toLocaleDateString()} | Time: ${dt.toLocaleTimeString()}`;
            })
            .catch(err => {
                console.error('Dashboard load error', err);
            });

        function escapeHtml(s) {
            if (s === null || s === undefined) return '';
            return String(s)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }
    })();
    </script>
</body>
</html>