<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - WATER WORLD</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
    <!-- Reuse site design system and header styles to match index color scheme -->
    <link rel="stylesheet" href="/WRSOMS/assets/css/design-system.css">
    <link rel="stylesheet" href="/WRSOMS/assets/css/header.css">
    <link rel="stylesheet" href="/WRSOMS/assets/css/admin.css">
    
</head>
<body>
    <nav class="sidebar" aria-label="Main navigation">
        <div class="logo-container nav-brand">
            <img src="/WRSOMS/assets/images/ww_logo.png" alt="Water World Logo" class="nav-logo logo-img">
            <span class="brand-name">Water World</span>
        </div>
        <div class="admin-info">
            <i class="fa fa-user-circle"></i>
            <span class="admin-name">Admin Panel</span>
        </div>
        <ul class="nav-menu">
            <li class="nav-item active">
                <button type="button" onclick="showDashboard()" class="nav-link">
                    <i class="fa fa-tachometer nav-icon"></i>
                    <span class="nav-text">Dashboard</span>
                </button>
            </li>
            <li class="nav-item">
                <a href="#" onclick="loadManageOrders(event)" class="nav-link">
                    <i class="fa fa-shopping-cart nav-icon"></i>
                    <span class="nav-text">Manage Orders</span>
                </a>
            </li>
            <li class="nav-item">
                <button type="button" onclick="showOrderHistory()" class="nav-link">
                    <i class="fa fa-history nav-icon"></i>
                    <span class="nav-text">Order History</span>
                </button>
            </li>
            <li class="nav-item">
                <button type="button" onclick="showInventoryManagement()" class="nav-link">
                    <i class="fa fa-cubes nav-icon"></i>
                    <span class="nav-text">Inventory</span>
                </button>
            </li>
            <li class="nav-item">
                <button type="button" onclick="showDailyReport()" class="nav-link">
                    <i class="fa fa-calendar nav-icon"></i>
                    <span class="nav-text">Daily Report</span>
                </button>
            </li>
        </ul>
        <div class="sidebar-footer">
            <button type="button" onclick="logout()" class="logout-btn">
                <i class="fa fa-sign-out"></i>
                <span>Logout</span>
            </button>
        </div>
    </nav>
    <div class="sidebar-report" id="reportSidebar">
        <span class="close-btn" onclick="toggleReportSidebar()">&times;</span>
        <ul id="reportDates"></ul>
    </div>
    <main class="content" aria-label="Dashboard content" id="mainContent">
        <div class="dashboard-inner">
        <header class="header">
            <h1 class="title">Dashboard</h1>
            <div class="date-time" aria-live="polite">Date:  | Time: </div>
        </header>
        <section class="quick-actions" aria-label="Quick actions">
            <button type="button" onclick="location.reload();" aria-label="Refresh dashboard data">Refresh Data</button>
        </section>
        <section class="metrics" aria-label="Key metrics">
            <div class="metric-card" data-color="blue" role="region" aria-label="Total Orders">
                <div class="metric-card-inner">
                    <span class="metric-icon"><i class="fa fa-list-alt"></i></span>
                    <div class="metric-text"><h3>Total Orders</h3><p id="totalOrdersVal">—</p></div>
                </div>
            </div>
            <div class="metric-card" data-color="green" role="region" aria-label="Pending Orders">
                <div class="metric-card-inner">
                    <span class="metric-icon"><i class="fa fa-clock-o"></i></span>
                    <div class="metric-text"><h3>Pending Orders</h3><p id="pendingOrdersVal">—</p></div>
                </div>
            </div>
            <div class="metric-card" data-color="purple" role="region" aria-label="Completed Orders">
                <div class="metric-card-inner">
                    <span class="metric-icon"><i class="fa fa-check-circle"></i></span>
                    <div class="metric-text"><h3>Completed Orders</h3><p id="completedOrdersVal">—</p></div>
                </div>
            </div>
            <div class="metric-card" data-color="teal" role="region" aria-label="Total Revenue">
                <div class="metric-card-inner">
                    <span class="metric-icon"><i class="fa fa-money"></i></span>
                    <div class="metric-text"><h3>Total Revenue</h3><p id="totalRevenueVal">—</p></div>
                </div>
            </div>
            <div class="metric-card" data-color="pink" role="region" aria-label="Average Order Value">
                <div class="metric-card-inner">
                    <span class="metric-icon"><i class="fa fa-calculator"></i></span>
                    <div class="metric-text"><h3>Avg Order Value</h3><p id="avgOrderVal">—</p></div>
                </div>
            </div>
            <div class="metric-card" data-color="gray" role="region" aria-label="Pending Deliveries">
                <div class="metric-card-inner">
                    <span class="metric-icon"><i class="fa fa-truck"></i></span>
                    <div class="metric-text"><h3>Pending Deliveries</h3><p id="pendingDeliveriesVal">—</p></div>
                </div>
            </div>
        </section>
        <section class="metric-card" role="region" aria-label="Batch Overview">
            <h3>Batch Overview (Pending Orders Only)</h3>
            <table class="batch-table" aria-describedby="batch-table-desc">
                <caption id="batch-table-desc" class="sr-only">Overview of batches by vehicle type, batch number, order count, and status</caption>
                <thead>
                    <tr>
                        <th scope="col">Vehicle Type</th>
                        <th scope="col">Batch #</th>
                        <th scope="col">Orders</th>
                        <th scope="col">Containers</th>
                        <th scope="col">Status</th>
                    </tr>
                </thead>
                <tbody id="batchBody">
                    <!-- Populated by client-side JS -->
                </tbody>
            </table>
        </section>
        <section class="metric-card" role="region" aria-label="Recent Orders">
            <h3>Recent Orders (Today)</h3>
            <table class="recent-orders-table" aria-describedby="recent-orders-table-desc">
                <caption id="recent-orders-table-desc" class="sr-only">List of recent orders with order ID, date, amount, and status</caption>
                <thead>
                    <tr>
                        <th scope="col">Order ID</th>
                        <th scope="col">Date</th>
                        <th scope="col">Amount</th>
                        <th scope="col">Status</th>
                    </tr>
                </thead>
                <tbody id="recentOrdersBody">
                    <!-- Populated by client-side JS -->
                </tbody>
            </table>
        </section>
        </div>
    </main>
    <script>
        // Check admin authentication on page load
        (function checkAdminAuth() {
            fetch('/WRSOMS/api/auth/session.php', { credentials: 'same-origin' })
                .then(r => r.json())
                .then(res => {
                    if (!res.authenticated || !res.user || !res.user.is_admin) {
                        // Not logged in as admin, redirect to login
                        alert('Admin access required. Please login with admin credentials.');
                        window.location.href = '/WRSOMS/pages/login.html?redirect=admin';
                    } else {
                        // Update admin name in sidebar
                        const adminNameEl = document.querySelector('.admin-name');
                        if (adminNameEl && res.user.username) {
                            adminNameEl.textContent = res.user.username;
                        }
                    }
                })
                .catch(err => {
                    console.error('Auth check failed:', err);
                    alert('Authentication error. Redirecting to login.');
                    window.location.href = '/WRSOMS/pages/login.html?redirect=admin';
                });
        })();

        let originalContent = document.getElementById('mainContent').innerHTML;
        let cachedOrderHistory = null;

        function showDashboard() {
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = originalContent;
            document.getElementById('reportSidebar').classList.remove('active');
            updateActiveNav('showDashboard()');
            // Reload dashboard data after DOM is ready
            setTimeout(() => loadDashboard(), 50);
        }

        function updateActiveNav(targetOnclick) {
            // Remove active from all nav items
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            
            // Add active to the clicked item
            const target = document.querySelector('.nav-link[onclick="' + targetOnclick + '"]');
            if (target && target.parentElement) {
                target.parentElement.classList.add('active');
            }
        }

        function showOrderHistory() {
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `
                <div class="dashboard-inner">
                    <header class="header">
                        <h1 class="title">Order History</h1>
                        <div class="date-time" aria-live="polite">Date: ${new Date().toLocaleDateString()} | Time: ${new Date().toLocaleTimeString()}</div>
                    </header>
                    <section class="quick-actions" aria-label="Quick actions">
                        <button type="button" onclick="loadOrderHistoryData()" aria-label="Refresh order history">Refresh Data</button>
                    </section>
                    <section class="metric-card" role="region" aria-label="Order History">
                        <h3>Complete Order History</h3>
                        <div style="margin-bottom: 12px;">
                            <input type="text" id="searchInput" placeholder="Search by Order ID, Customer Name..." 
                                   style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; width: 100%; max-width: 400px;">
                        </div>
                        <div style="overflow-x: auto;">
                            <table class="order-history-table" aria-describedby="order-history-table-desc">
                                <caption id="order-history-table-desc" class="sr-only">Complete order history with customer details</caption>
                                <thead>
                                    <tr>
                                        <th scope="col">Order ID</th>
                                        <th scope="col">Customer</th>
                                        <th scope="col">Date</th>
                                        <th scope="col">Amount</th>
                                        <th scope="col">Batch</th>
                                        <th scope="col">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="orderHistoryBody">
                                    <tr><td colspan="6" style="text-align: center;">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </section>
                </div>
            `;
            
            // Update active state on sidebar
            updateActiveNav('showOrderHistory()');
            
            // Load order history data
            loadOrderHistoryData();
            
            // Add search functionality
            setTimeout(() => {
                const searchInput = document.getElementById('searchInput');
                if (searchInput) {
                    searchInput.addEventListener('input', filterOrderHistory);
                }
            }, 100);
        }

        function loadOrderHistoryData() {
            fetch('/WRSOMS/api/admin/dashboard.php', { credentials: 'same-origin' })
                .then(r => r.json())
                .then(res => {
                    if (!res.success) throw new Error(res.message || 'Failed to load');
                    const data = res.data || {};
                    cachedOrderHistory = data.order_history || [];
                    renderOrderHistory(cachedOrderHistory);
                })
                .catch(err => {
                    console.error('Order history load error', err);
                    const tbody = document.getElementById('orderHistoryBody');
                    if (tbody) {
                        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #ef4444;">Error loading order history</td></tr>';
                    }
                });
        }

        function renderOrderHistory(orders) {
            const historyBody = document.getElementById('orderHistoryBody');
            if (!historyBody) return;
            
            historyBody.innerHTML = '';
            if (orders.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = '<td colspan="6" style="text-align: center; color: #999;">No order history</td>';
                historyBody.appendChild(tr);
            } else {
                orders.forEach(o => {
                    const customerName = o.first_name && o.last_name ? `${o.first_name} ${o.last_name}` : 'N/A';
                    const batchInfo = o.vehicle_type && o.batch_number ? `${o.vehicle_type} #${o.batch_number}` : 'Unassigned';
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><strong>${escapeHtml(o.reference_id)}</strong></td>
                        <td>${escapeHtml(customerName)}</td>
                        <td>${formatDateTime(o.order_date)}</td>
                        <td>${money(o.total_amount)}</td>
                        <td>${escapeHtml(batchInfo)}</td>
                        <td><span class="badge ${getStatusClass(o.order_status)}">${escapeHtml(o.order_status || 'N/A')}</span></td>
                    `;
                    historyBody.appendChild(tr);
                });
            }
        }

        function filterOrderHistory() {
            const searchInput = document.getElementById('searchInput');
            if (!searchInput || !cachedOrderHistory) return;
            
            const searchTerm = searchInput.value.toLowerCase().trim();
            if (searchTerm === '') {
                renderOrderHistory(cachedOrderHistory);
                return;
            }
            
            const filtered = cachedOrderHistory.filter(o => {
                const customerName = o.first_name && o.last_name ? `${o.first_name} ${o.last_name}`.toLowerCase() : '';
                const refId = (o.reference_id || '').toLowerCase();
                const status = (o.order_status || '').toLowerCase();
                const batchInfo = o.vehicle_type && o.batch_number ? `${o.vehicle_type} ${o.batch_number}`.toLowerCase() : '';
                
                return refId.includes(searchTerm) || 
                       customerName.includes(searchTerm) || 
                       status.includes(searchTerm) ||
                       batchInfo.includes(searchTerm);
            });
            
            renderOrderHistory(filtered);
        }

        function toggleReportSidebar() {
            document.getElementById('reportSidebar').classList.toggle('active');
        }

        function showDailyReport(date = '') {
            const mainContent = document.getElementById('mainContent');
            
            // Show loading state
            mainContent.innerHTML = `
                <div class="dashboard-inner">
                    <header class="header">
                        <h1 class="title">Daily Sales Report</h1>
                        <div class="date-time">Loading...</div>
                    </header>
                    <div style="text-align: center; padding: 40px;">
                        <i class="fa fa-spinner fa-spin" style="font-size: 48px; color: #3b82f6;"></i>
                        <p style="margin-top: 16px; color: #6b7280;">Loading report data...</p>
                    </div>
                </div>
            `;
            
            updateActiveNav('showDailyReport()');
            
            // Fetch daily report data from API
            const apiUrl = '/WRSOMS/api/admin/daily_report.php' + (date ? '?date=' + encodeURIComponent(date) : '');
            
            fetch(apiUrl, { credentials: 'same-origin' })
                .then(r => r.json())
                .then(res => {
                    if (!res.success) throw new Error(res.message || 'Failed to load report');
                    
                    const data = res.data;
                    const stats = data.stats;
                    const charts = data.charts;
                    
                    // Render the daily report UI
                    mainContent.innerHTML = `
                        <div class="dashboard-inner">
                            <header class="header">
                                <h1 class="title">Daily Sales Report</h1>
                                <div class="date-time">${new Date(data.selected_date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</div>
                            </header>
                            
                            <section class="quick-actions" style="justify-content: space-between;">
                                <button type="button" onclick="showDailyReport('${data.prev_date}')" class="btn btn-outline-primary">
                                    <i class="fa fa-arrow-left"></i> Previous Day
                                </button>
                                <button type="button" onclick="showDailyReport()" class="btn btn-primary">
                                    <i class="fa fa-calendar"></i> Today
                                </button>
                                ${!data.is_today ? '<button type="button" onclick="showDailyReport(\'' + data.next_date + '\')" class="btn btn-outline-primary">Next Day <i class="fa fa-arrow-right"></i></button>' : ''}
                            </section>
                            
                            <!-- Stats Cards -->
                            <section class="metrics">
                                <div class="metric-card" data-color="blue">
                                    <div class="metric-card-inner">
                                        <span class="metric-icon"><i class="fa fa-money"></i></span>
                                        <div class="metric-text">
                                            <h3>Total Revenue</h3>
                                            <p>${money(stats.total_revenue)}</p>
                                            <small style="color: #6b7280;">${stats.orders_today} orders</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="metric-card" data-color="green">
                                    <div class="metric-card-inner">
                                        <span class="metric-icon"><i class="fa fa-shopping-cart"></i></span>
                                        <div class="metric-text">
                                            <h3>Orders Today</h3>
                                            <p>${stats.orders_today}</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="metric-card" data-color="purple">
                                    <div class="metric-card-inner">
                                        <span class="metric-icon"><i class="fa fa-users"></i></span>
                                        <div class="metric-text">
                                            <h3>New Customers</h3>
                                            <p>${stats.new_customers_today}</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="metric-card" data-color="teal">
                                    <div class="metric-card-inner">
                                        <span class="metric-icon"><i class="fa fa-check-circle"></i></span>
                                        <div class="metric-text">
                                            <h3>Completed Payments</h3>
                                            <p>${money(stats.completed_payments_today)}</p>
                                        </div>
                                    </div>
                                </div>
                            </section>
                            
                            <!-- Charts Row -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px;">
                                <section class="metric-card">
                                    <h3>Revenue - Last 7 Days</h3>
                                    <canvas id="revenueChart" style="max-height: 300px;"></canvas>
                                </section>
                                <section class="metric-card">
                                    <h3>Orders - Last 7 Days</h3>
                                    <canvas id="ordersChart" style="max-height: 300px;"></canvas>
                                </section>
                            </div>
                            
                            <!-- Tables Row -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <section class="metric-card">
                                    <h3>Recent Orders</h3>
                                    <div style="overflow-x: auto;">
                                        <table class="batch-table">
                                            <thead>
                                                <tr>
                                                    <th>Order ID</th>
                                                    <th>Customer</th>
                                                    <th>Amount</th>
                                                </tr>
                                            </thead>
                                            <tbody id="recentOrdersTable">
                                                ${data.recent_orders.length > 0 ? 
                                                    data.recent_orders.map(o => `
                                                        <tr>
                                                            <td><strong>${escapeHtml(o.reference_id)}</strong></td>
                                                            <td>${escapeHtml(o.customer_name || 'Guest')}</td>
                                                            <td>${money(o.total_amount)}</td>
                                                        </tr>
                                                    `).join('') :
                                                    '<tr><td colspan="3" style="text-align: center; color: #999;">No orders for this date</td></tr>'
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                </section>
                                
                                <section class="metric-card">
                                    <h3>Top Selling Containers (30 Days)</h3>
                                    <div style="overflow-x: auto;">
                                        <table class="batch-table">
                                            <thead>
                                                <tr>
                                                    <th>Container</th>
                                                    <th>Quantity</th>
                                                    <th>Revenue</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${data.top_products.length > 0 ?
                                                    data.top_products.map(p => `
                                                        <tr>
                                                            <td>${escapeHtml(p.container_type)}</td>
                                                            <td>${p.qty}</td>
                                                            <td>${money(p.revenue)}</td>
                                                        </tr>
                                                    `).join('') :
                                                    '<tr><td colspan="3" style="text-align: center; color: #999;">No sales in last 30 days</td></tr>'
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                </section>
                            </div>
                        </div>
                    `;
                    
                    // Render charts
                    setTimeout(() => {
                        renderDailyReportCharts(charts);
                    }, 100);
                })
                .catch(error => {
                    console.error('Error loading daily report:', error);
                    mainContent.innerHTML = `
                        <div class="dashboard-inner">
                            <header class="header">
                                <h1 class="title">Daily Sales Report</h1>
                            </header>
                            <div style="text-align: center; padding: 40px; color: #ef4444;">
                                <i class="fa fa-exclamation-triangle" style="font-size: 48px;"></i>
                                <p style="margin-top: 16px;">Error loading daily report: ${error.message}</p>
                                <button onclick="showDailyReport()" class="btn btn-primary" style="margin-top: 16px;">Try Again</button>
                            </div>
                        </div>
                    `;
                });
        }
        
        function renderDailyReportCharts(charts) {
            const revenueCtx = document.getElementById('revenueChart');
            const ordersCtx = document.getElementById('ordersChart');
            
            if (!revenueCtx || !ordersCtx) return;
            
            // Revenue Line Chart
            new Chart(revenueCtx, {
                type: 'line',
                data: {
                    labels: charts.labels,
                    datasets: [{
                        label: 'Revenue (₱)',
                        data: charts.revenue_data,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '₱' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
            
            // Orders Bar Chart
            new Chart(ordersCtx, {
                type: 'bar',
                data: {
                    labels: charts.labels,
                    datasets: [{
                        label: 'Orders',
                        data: charts.orders_data,
                        backgroundColor: '#10b981'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        function loadManageOrders(e) {
            if (e) e.preventDefault();
            fetch('manage-orders.html')
                .then(response => response.text())
                .then(data => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(data, 'text/html');
                    const container = doc.querySelector('.container');
                    if (!container) {
                        document.getElementById('mainContent').innerHTML = '<p>Error: manage orders content not found.</p>';
                        return;
                    }
                    // Replace main content with the fetched container
                    document.getElementById('mainContent').innerHTML = container.outerHTML;

                    // Execute any inline scripts from the fetched page
                    const scripts = Array.from(doc.querySelectorAll('script'))
                        .map(s => s.textContent)
                        .join('\n');
                    if (scripts) {
                        const scriptElement = document.createElement('script');
                        scriptElement.textContent = scripts;
                        document.getElementById('mainContent').appendChild(scriptElement);
                    }

                    // Update active state on sidebar
                    updateActiveNav('loadManageOrders(event)');
                })
                .catch(error => {
                    console.error('Error loading manage orders:', error);
                    document.getElementById('mainContent').innerHTML = '<p>Error loading Manage Orders. Please try again.</p>';
                });
        }

        function fetchDates() {
            // Daily report is a static HTML page, no date selection needed
            // If you need dynamic date functionality, create an API endpoint
            console.log('Daily report date selection not implemented');
        }

        function showInventoryManagement() {
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `
                <div class="dashboard-inner">
                    <header class="header">
                        <h1 class="title">Inventory Management</h1>
                        <div class="date-time" aria-live="polite">Date: ${new Date().toLocaleDateString()} | Time: ${new Date().toLocaleTimeString()}</div>
                    </header>
                    
                    <!-- Vehicle Capacity Management -->
                    <section class="metric-card" role="region" aria-label="Vehicle Capacity">
                        <h3>Vehicle Capacity Settings</h3>
                        <div style="margin-bottom: 20px;">
                            <table class="batch-table">
                                <thead>
                                    <tr>
                                        <th>Vehicle Type</th>
                                        <th>Capacity (Containers)</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="vehicleCapacityBody">
                                    <tr>
                                        <td>Tricycle</td>
                                        <td><input type="number" id="tricycleCapacity" value="5" min="1" max="20" style="width: 80px; padding: 6px;"></td>
                                        <td><button onclick="saveVehicleCapacity('Tricycle')" class="btn btn-sm btn-primary">Save</button></td>
                                    </tr>
                                    <tr>
                                        <td>Car</td>
                                        <td><input type="number" id="carCapacity" value="10" min="1" max="50" style="width: 80px; padding: 6px;"></td>
                                        <td><button onclick="saveVehicleCapacity('Car')" class="btn btn-sm btn-primary">Save</button></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <p style="color: #6b7280; font-size: 0.9rem;">
                            <i class="fa fa-info-circle"></i> Vehicle capacity determines the maximum number of containers per batch.
                        </p>
                    </section>

                    <!-- Container Stock Management -->
                    <section class="metric-card" role="region" aria-label="Container Stock">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h3 style="margin: 0;">Container Stock Inventory</h3>
                            <button onclick="showAddContainerModal()" class="btn btn-sm btn-primary">
                                <i class="fa fa-plus"></i> Add New Container Type
                            </button>
                        </div>
                        <div style="overflow-x: auto;">
                            <table class="order-history-table">
                                <thead>
                                    <tr>
                                        <th>Container Type</th>
                                        <th>Size</th>
                                        <th>Price</th>
                                        <th>Stock Quantity</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="containerStockBody">
                                    <tr><td colspan="6" style="text-align: center;">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </section>
                </div>

                <!-- Add/Edit Container Modal -->
                <div id="containerModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 24px; border-radius: 12px; max-width: 500px; width: 90%;">
                        <h3 id="modalTitle">Add New Container</h3>
                        <form id="containerForm" onsubmit="saveContainer(event)">
                            <input type="hidden" id="containerId" value="">
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; margin-bottom: 6px; font-weight: 600;">Container Type:</label>
                                <input type="text" id="containerType" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                            </div>
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; margin-bottom: 6px; font-weight: 600;">Size:</label>
                                <input type="text" id="containerSize" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                            </div>
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; margin-bottom: 6px; font-weight: 600;">Price (₱):</label>
                                <input type="number" id="containerPrice" required step="0.01" min="0" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                            </div>
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; margin-bottom: 6px; font-weight: 600;">Stock Quantity:</label>
                                <input type="number" id="containerStock" required min="0" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                            </div>
                            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                <button type="button" onclick="closeContainerModal()" class="btn btn-secondary">Cancel</button>
                                <button type="submit" class="btn btn-primary">Save</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            // Update active state on sidebar
            updateActiveNav('showInventoryManagement()');
            
            // Load vehicle capacity settings
            const tricycleCapacity = localStorage.getItem('vehicleCapacity_Tricycle') || '5';
            const carCapacity = localStorage.getItem('vehicleCapacity_Car') || '10';
            setTimeout(() => {
                const tricycleInput = document.getElementById('tricycleCapacity');
                const carInput = document.getElementById('carCapacity');
                if (tricycleInput) tricycleInput.value = tricycleCapacity;
                if (carInput) carInput.value = carCapacity;
            }, 100);
            
            // Load data from database
            loadInventoryData();
        }

        function loadInventoryData() {
            // Load inventory data from database
            fetch('/WRSOMS/api/admin/inventory.php', { credentials: 'same-origin' })
                .then(r => r.json())
                .then(response => {
                    if (!response.success) {
                        throw new Error(response.message || 'Failed to load inventory');
                    }
                    renderContainerStock(response.data);
                })
                .catch(err => {
                    console.error('Error loading inventory:', err);
                    const tbody = document.getElementById('containerStockBody');
                    if (tbody) tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #ef4444;">Error loading data: ' + err.message + '</td></tr>';
                });
        }

        function renderContainerStock(containers) {
            const tbody = document.getElementById('containerStockBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            if (containers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #999;">No containers in inventory</td></tr>';
                return;
            }
            
            containers.forEach(c => {
                const stock = parseInt(c.stock_quantity || 0);
                const statusBadge = stock > 10 ? 
                    '<span class="badge bg-success">In Stock</span>' : 
                    stock > 0 ? 
                    '<span class="badge bg-warning">Low Stock</span>' : 
                    '<span class="badge bg-danger">Out of Stock</span>';
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${escapeHtml(c.container_type)}</strong></td>
                    <td>${escapeHtml(c.size || 'N/A')}</td>
                    <td>${money(c.price)}</td>
                    <td>${stock}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <button onclick="editContainer(${c.container_id})" class="btn btn-sm btn-info" style="margin-right: 6px;">
                            <i class="fa fa-edit"></i> Edit
                        </button>
                        <button onclick="updateStock(${c.container_id}, '${escapeHtml(c.container_type)}')" class="btn btn-sm btn-success">
                            <i class="fa fa-plus"></i> Add Stock
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function saveVehicleCapacity(vehicleType) {
            const capacity = vehicleType === 'Tricycle' ? 
                document.getElementById('tricycleCapacity').value : 
                document.getElementById('carCapacity').value;
            
            // Store in localStorage for now (you can create an API endpoint later)
            localStorage.setItem('vehicleCapacity_' + vehicleType, capacity);
            alert(vehicleType + ' capacity updated to ' + capacity + ' containers');
        }

        function showAddContainerModal() {
            alert('Adding new container types requires database modification.\n\nCurrent available types:\n- Round (5 Gallons)\n- Slim (3 Gallons)\n\nPlease contact system administrator to add new types.');
        }

        function closeContainerModal() {
            document.getElementById('containerModal').style.display = 'none';
            // Re-enable fields for next time
            document.getElementById('containerType').disabled = false;
            document.getElementById('containerSize').disabled = false;
            document.getElementById('containerPrice').disabled = false;
        }

        function editContainer(containerId) {
            // Fetch container details from the main list already loaded
            fetch('/WRSOMS/api/common/containers.php', { credentials: 'same-origin' })
                .then(r => r.json())
                .then(containers => {
                    if (containers.error) throw new Error(containers.error);
                    const c = containers.find(cont => cont.container_id === containerId);
                    if (!c) throw new Error('Container not found');
                    
                    const stockKey = 'container_stock_' + c.container_id;
                    const stock = parseInt(localStorage.getItem(stockKey) || '0');
                    
                    document.getElementById('modalTitle').textContent = 'Update Stock for ' + c.container_type;
                    document.getElementById('containerId').value = c.container_id;
                    document.getElementById('containerType').value = c.container_type;
                    document.getElementById('containerType').disabled = true; // Read-only
                    document.getElementById('containerSize').value = c.container_type === 'Round' ? '5 Gallons' : '3 Gallons';
                    document.getElementById('containerSize').disabled = true; // Read-only
                    document.getElementById('containerPrice').value = c.price;
                    document.getElementById('containerPrice').disabled = true; // Read-only
                    document.getElementById('containerStock').value = stock;
                    document.getElementById('containerModal').style.display = 'flex';
                })
                .catch(err => alert('Error loading container: ' + err.message));
        }

        function saveContainer(event) {
            event.preventDefault();
            const containerId = document.getElementById('containerId').value;
            const stockQuantity = document.getElementById('containerStock').value;
            
            if (containerId) {
                // For now, we can only update stock via localStorage since the containers table
                // doesn't have a stock_quantity column. In production, you should add this column.
                const stockKey = 'container_stock_' + containerId;
                localStorage.setItem(stockKey, stockQuantity);
                alert('Stock quantity updated successfully');
                closeContainerModal();
                loadInventoryData();
            } else {
                // Adding new containers would require modifying the database
                alert('Adding new container types requires database modification. Please contact system administrator.');
                closeContainerModal();
            }
        }

        function updateStock(containerId, containerType) {
            const quantity = prompt('Enter new stock quantity for ' + containerType + ':', '0');
            if (quantity === null || quantity === '') return;
            
            const qty = parseInt(quantity);
            if (isNaN(qty) || qty < 0) {
                alert('Please enter a valid positive number');
                return;
            }
            
            // Update stock in database
            fetch('/WRSOMS/api/admin/inventory.php', {
                method: 'PUT',
                credentials: 'same-origin',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    container_id: containerId,
                    stock: qty
                })
            })
            .then(r => r.json())
            .then(response => {
                if (response.success) {
                    alert('Stock updated successfully. New stock: ' + qty);
                    loadInventoryData(); // Reload to show updated data
                } else {
                    alert('Error updating stock: ' + response.message);
                }
            })
            .catch(err => {
                console.error('Error updating stock:', err);
                alert('Failed to update stock. Please try again.');
            });
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                fetch('/WRSOMS/api/auth/logout.php', { 
                    method: 'POST',
                    credentials: 'same-origin' 
                })
                .then(r => r.json())
                .then(res => {
                    // Redirect to login page regardless of response
                    window.location.href = '/WRSOMS/pages/login.html';
                })
                .catch(err => {
                    console.error('Logout error:', err);
                    // Still redirect even if there's an error
                    window.location.href = '/WRSOMS/pages/login.html';
                });
            }
        }

        const bootstrapScript = document.createElement('script');
        bootstrapScript.src = 'https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js';
        document.body.appendChild(bootstrapScript);
    
    // Helper functions (global scope)
    function money(v) {
        return '₱' + Number(v).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function escapeHtml(s) {
        if (s === null || s === undefined) return '';
        return String(s)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
    }

    function formatDateTime(dateStr) {
        if (!dateStr) return 'N/A';
        const d = new Date(dateStr);
        return d.toLocaleString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    function getStatusClass(status) {
        if (!status) return 'bg-secondary';
        const s = status.toLowerCase();
        if (s.includes('pending')) return 'bg-warning';
        if (s.includes('delivered') || s.includes('completed')) return 'bg-success';
        if (s.includes('dispatched')) return 'bg-info';
        if (s.includes('failed') || s.includes('cancelled')) return 'bg-danger';
        return 'bg-secondary';
    }

    function getBatchStatusClass(status) {
        if (!status) return 'bg-secondary';
        const s = status.toLowerCase();
        if (s.includes('pending')) return 'bg-warning';
        if (s.includes('dispatched')) return 'bg-info';
        if (s.includes('completed')) return 'bg-success';
        if (s.includes('failed')) return 'bg-danger';
        return 'bg-secondary';
    }

    // Fetch dashboard data from API and populate UI
    function loadDashboard() {
        const apiUrl = '/WRSOMS/api/admin/dashboard.php';

        fetch(apiUrl, { credentials: 'same-origin' })
            .then(r => r.json())
            .then(res => {
                if (!res.success) throw new Error(res.message || 'Failed to load');
                const data = res.data || {};
                const stats = data.stats || {};
                
                // Debug logging
                console.log('Dashboard data received:', {
                    stats: stats,
                    batch_details: data.batch_details,
                    recent_orders: data.recent_orders
                });

                // Update stats with safety checks
                const totalOrdersEl = document.getElementById('totalOrdersVal');
                const pendingOrdersEl = document.getElementById('pendingOrdersVal');
                const completedOrdersEl = document.getElementById('completedOrdersVal');
                const totalRevenueEl = document.getElementById('totalRevenueVal');
                const avgOrderEl = document.getElementById('avgOrderVal');
                const pendingDeliveriesEl = document.getElementById('pendingDeliveriesVal');
                
                if (totalOrdersEl) totalOrdersEl.textContent = stats.total_orders ?? '0';
                if (pendingOrdersEl) pendingOrdersEl.textContent = stats.pending_orders ?? '0';
                if (completedOrdersEl) completedOrdersEl.textContent = stats.completed_orders ?? '0';
                if (totalRevenueEl) totalRevenueEl.textContent = money(stats.total_revenue ?? 0);
                if (avgOrderEl) avgOrderEl.textContent = money(stats.avg_order_value ?? 0);
                if (pendingDeliveriesEl) pendingDeliveriesEl.textContent = stats.pending_deliveries ?? '0';

                // Batch details - only show batches with pending orders
                const batchBody = document.getElementById('batchBody');
                if (!batchBody) return; // Safety check: only proceed if element exists
                
                batchBody.innerHTML = '';
                const batchData = data.batch_details || [];
                const unassignedCount = stats.unassigned_orders || 0;
                
                if (batchData.length === 0 && unassignedCount === 0) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = '<td colspan="5" style="text-align: center; color: #999;">No pending batches or orders today</td>';
                    batchBody.appendChild(tr);
                } else {
                    // Show existing batches
                    batchData.forEach(b => {
                        const capacity = b.vehicle_type === 'Tricycle' ? 5 : 10;
                        const containers = parseInt(b.total_containers || 0);
                        const containerDisplay = `${containers}/${capacity}`;
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${escapeHtml(b.vehicle_type)}</td>
                            <td>#${escapeHtml(b.batch_number)}</td>
                            <td>${escapeHtml(b.order_count)}</td>
                            <td>${escapeHtml(containerDisplay)}</td>
                            <td><span class="badge ${getBatchStatusClass(b.batch_status)}">${escapeHtml(b.batch_status || 'N/A')}</span></td>
                        `;
                        batchBody.appendChild(tr);
                    });
                    
                    // Show unassigned orders if any
                    if (unassignedCount > 0) {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td colspan="2"><em>Unassigned Orders</em></td>
                            <td>${unassignedCount}</td>
                            <td>-</td>
                            <td><span class="badge bg-secondary">Not Batched</span></td>
                        `;
                        batchBody.appendChild(tr);
                    }
                }

                // Recent orders (today)
                const recentBody = document.getElementById('recentOrdersBody');
                if (!recentBody) return; // Safety check: only proceed if element exists
                
                recentBody.innerHTML = '';
                const recentOrders = data.recent_orders || [];
                if (recentOrders.length === 0) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = '<td colspan="4" style="text-align: center; color: #999;">No orders today</td>';
                    recentBody.appendChild(tr);
                } else {
                    recentOrders.forEach(o => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td><strong>${escapeHtml(o.reference_id)}</strong></td>
                            <td>${formatDateTime(o.order_date)}</td>
                            <td>${money(o.total_amount)}</td>
                            <td><span class="badge ${getStatusClass(o.order_status)}">${escapeHtml(o.order_status || 'N/A')}</span></td>
                        `;
                        recentBody.appendChild(tr);
                    });
                }

                // Cache order history for the separate view
                cachedOrderHistory = data.order_history || [];

                // Update header date/time
                const dt = new Date();
                const dateTime = document.querySelector('.header .date-time');
                if (dateTime) dateTime.textContent = `Date: ${dt.toLocaleDateString()} | Time: ${dt.toLocaleTimeString()}`;
            })
            .catch(err => {
                console.error('Dashboard load error', err);
            });
    }

    // Load dashboard on initial page load
    loadDashboard();
    </script>
</body>
</html>