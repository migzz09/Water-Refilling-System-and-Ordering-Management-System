<script>
// Toast notification system for admin
function showAdminToast(message, type = 'info', duration = 3500) {
    let oldToast = document.getElementById('adminToast');
    if (oldToast) oldToast.remove();
    const toast = document.createElement('div');
    toast.id = 'adminToast';
    toast.className = `toast-admin toast-${type}`;
    toast.innerHTML = `<span>${message.replace(/\n/g, '<br>')}</span>`;
    toast.style.position = 'fixed';
    toast.style.bottom = '32px';
    toast.style.left = '50%';
    toast.style.transform = 'translateX(-50%)';
    toast.style.background = type === 'error' ? '#d32f2f' : (type === 'success' ? '#388e3c' : '#1976d2');
    toast.style.color = '#fff';
    toast.style.padding = '16px 32px';
    toast.style.borderRadius = '8px';
    toast.style.boxShadow = '0 2px 12px rgba(0,0,0,0.15)';
    toast.style.fontSize = '1rem';
    toast.style.zIndex = '9999';
    toast.style.opacity = '0';
    toast.style.transition = 'opacity 0.3s';
    document.body.appendChild(toast);
    setTimeout(() => { toast.style.opacity = '1'; }, 50);
    setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => { toast.remove(); }, 350);
    }, duration);
}
</script>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - WATER WORLD</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
    <!-- Reuse site design system and header styles to match index color scheme -->
    <link rel="stylesheet" href="/WRSOMS/assets/css/design-system.css">
    <link rel="stylesheet" href="/WRSOMS/assets/css/header.css">
    <link rel="stylesheet" href="/WRSOMS/assets/css/admin.css">
    
</head>
<body>
    <nav class="sidebar" aria-label="Main navigation">
        <div class="logo-container nav-brand">
            <img src="/WRSOMS/assets/images/ww_logo.png" alt="Water World Logo" class="nav-logo logo-img">
            <span class="brand-name">Water World</span>
        </div>
        <div class="admin-info">
            <i class="fa fa-user-circle"></i>
            <span class="admin-name">Admin Panel</span>
        </div>
        <ul class="nav-menu">
            <li class="nav-item active">
                <button type="button" onclick="showDashboard()" class="nav-link">
                    <i class="fa fa-tachometer nav-icon"></i>
                    <span class="nav-text">Dashboard</span>
                </button>
            </li>
            <li class="nav-item">
                <a href="#" onclick="loadManageOrders(event)" class="nav-link">
                    <i class="fa fa-shopping-cart nav-icon"></i>
                    <span class="nav-text">Manage Orders</span>
                </a>
            </li>
            <li class="nav-item">
                <button type="button" onclick="showOrderHistory()" class="nav-link">
                    <i class="fa fa-history nav-icon"></i>
                    <span class="nav-text">Order History</span>
                </button>
            </li>
            <li class="nav-item">
                <button type="button" onclick="showInventoryManagement()" class="nav-link">
                    <i class="fa fa-cubes nav-icon"></i>
                    <span class="nav-text">Inventory</span>
                </button>
            </li>
            <li class="nav-item">
                <button type="button" onclick="showDailyReport()" class="nav-link">
                    <i class="fa fa-calendar nav-icon"></i>
                    <span class="nav-text">Daily Report</span>
                </button>
            </li>
            <li class="nav-item">
                <button type="button" onclick="showFeedback()" class="nav-link">
                    <i class="fa fa-comments nav-icon"></i>
                    <span class="nav-text">Customer Feedback</span>
                </button>
            </li>
            <li class="nav-item">
                <button type="button" onclick="showBusinessHours()" class="nav-link">
                    <i class="fa fa-clock-o nav-icon"></i>
                    <span class="nav-text">Business Hours</span>
                </button>
            </li>
            <li class="nav-item">
                <button type="button" onclick="showUserManagement()" class="nav-link">
                    <i class="fa fa-users nav-icon"></i>
                    <span class="nav-text">User Management</span>
                </button>
            </li>
            <li class="nav-item">
                <button type="button" onclick="showCashPayments()" class="nav-link">
                    <i class="fa fa-money nav-icon"></i>
                    <span class="nav-text">Cash Payments</span>
                </button>
            </li>
        </ul>
        <div class="sidebar-footer">
            <button type="button" onclick="logout()" class="logout-btn">
                <i class="fa fa-sign-out"></i>
                <span>Logout</span>
            </button>
        </div>
    </nav>
    <div class="sidebar-report" id="reportSidebar">
        <span class="close-btn" onclick="toggleReportSidebar()">&times;</span>
        <ul id="reportDates"></ul>
    </div>
    <main class="content" aria-label="Dashboard content" id="mainContent">
        <div class="dashboard-inner">
        <header class="header">
            <h1 class="title">Dashboard</h1>
            <div class="date-time" aria-live="polite">Date:  | Time: </div>
        </header>
        <section class="quick-actions" aria-label="Quick actions">
            <button type="button" onclick="location.reload();" aria-label="Refresh dashboard data">Refresh Data</button>
        </section>
        <section class="metrics" aria-label="Key metrics">
            <div class="metric-card" data-color="blue" role="region" aria-label="Total Orders">
                <div class="metric-card-inner">
                    <span class="metric-icon"><i class="fa fa-list-alt"></i></span>
                    <div class="metric-text"><h3>Total Orders</h3><p id="totalOrdersVal">—</p></div>
                </div>
            </div>
            <div class="metric-card" data-color="green" role="region" aria-label="Pending Orders">
                <div class="metric-card-inner">
                    <span class="metric-icon"><i class="fa fa-clock-o"></i></span>
                    <div class="metric-text"><h3>Pending Orders</h3><p id="pendingOrdersVal">—</p></div>
                </div>
            </div>
            <div class="metric-card" data-color="purple" role="region" aria-label="Completed Orders">
                <div class="metric-card-inner">
                    <span class="metric-icon"><i class="fa fa-check-circle"></i></span>
                    <div class="metric-text"><h3>Completed Orders</h3><p id="completedOrdersVal">—</p></div>
                </div>
            </div>
            <div class="metric-card" data-color="teal" role="region" aria-label="Total Revenue">
                <div class="metric-card-inner">
                    <span class="metric-icon"><i class="fa fa-money"></i></span>
                    <div class="metric-text"><h3>Total Revenue</h3><p id="totalRevenueVal">—</p></div>
                </div>
            </div>
            <div class="metric-card" data-color="pink" role="region" aria-label="Average Order Value">
                <div class="metric-card-inner">
                    <span class="metric-icon"><i class="fa fa-calculator"></i></span>
                    <div class="metric-text"><h3>Avg Order Value</h3><p id="avgOrderVal">—</p></div>
                </div>
            </div>
            <div class="metric-card" data-color="gray" role="region" aria-label="Pending Deliveries">
                <div class="metric-card-inner">
                    <span class="metric-icon"><i class="fa fa-truck"></i></span>
                    <div class="metric-text"><h3>Pending Deliveries</h3><p id="pendingDeliveriesVal">—</p></div>
                </div>
            </div>
        </section>
        <section class="metric-card" role="region" aria-label="Batch Overview">
            <h3>Batch Overview (Pending Orders Only)</h3>
            <table class="batch-table" aria-describedby="batch-table-desc">
                <caption id="batch-table-desc" class="sr-only">Overview of batches by vehicle type, batch number, order count, and status</caption>
                <thead>
                    <tr>
                        <th scope="col">Vehicle Type</th>
                        <th scope="col">Batch #</th>
                        <th scope="col">Orders</th>
                        <th scope="col">Containers</th>
                        <th scope="col">Status</th>
                    </tr>
                </thead>
                <tbody id="batchBody">
                    <!-- Populated by client-side JS -->
                </tbody>
            </table>
        </section>
        <section class="metric-card" role="region" aria-label="Recent Orders">
            <h3>Recent Orders (Today)</h3>
            <table class="recent-orders-table" aria-describedby="recent-orders-table-desc">
                <caption id="recent-orders-table-desc" class="sr-only">List of recent orders with order ID, date, amount, and status</caption>
                <thead>
                    <tr>
                        <th scope="col">Order ID</th>
                        <th scope="col">Date</th>
                        <th scope="col">Amount</th>
                        <th scope="col">Status</th>
                    </tr>
                </thead>
                <tbody id="recentOrdersBody">
                    <!-- Populated by client-side JS -->
                </tbody>
            </table>
        </section>
        </div>
    </main>
    <script>
        // Check admin authentication on page load
        (function checkAdminAuth() {
            fetch('/WRSOMS/api/auth/session.php', { credentials: 'same-origin' })
                .then(r => r.json())
                .then(res => {
                    if (!res.authenticated || !res.user || !res.user.is_admin) {
                        // Not logged in as admin, redirect to login
                        alert('Admin access required. Please login with admin credentials.');
                        window.location.href = '/WRSOMS/pages/login.html?redirect=admin';
                    } else {
                        // Update admin name in sidebar
                        const adminNameEl = document.querySelector('.admin-name');
                        if (adminNameEl && res.user.username) {
                            adminNameEl.textContent = res.user.username;
                        }
                    }
                })
                .catch(err => {
                    console.error('Auth check failed:', err);
                    alert('Authentication error. Redirecting to login.');
                    window.location.href = '/WRSOMS/pages/login.html?redirect=admin';
                });
        })();

        // Store the original dashboard content on window to avoid redeclaration errors
        if (typeof window.originalContent === 'undefined') {
            const mc = document.getElementById('mainContent');
            window.originalContent = mc ? mc.innerHTML : '';
        }
        let cachedOrderHistory = null;

        function showDashboard() {
            const mainContent = document.getElementById('mainContent');
                mainContent.innerHTML = window.originalContent;
            document.getElementById('reportSidebar').classList.remove('active');
            updateActiveNav('showDashboard()');
            // Reload dashboard data after DOM is ready
            setTimeout(() => loadDashboard(), 50);
        }

        // Delete container
        function deleteContainer(containerId) {
            if (!confirm('Are you sure you want to delete this container type? This will remove inventory data as well.')) return;
            const formData = new FormData();
            formData.append('container_id', containerId);
            formData.append('delete', '1');
            fetch('/WRSOMS/api/common/containers.php', {
                method: 'POST',
                credentials: 'same-origin',
                body: formData
            })
            .then(r => r.json())
            .then(res => {
                if (res.success) {
                    showAdminToast('Container deleted', 'success');
                    loadInventoryData();
                } else {
                    showAdminToast('Error deleting container: ' + (res.message || 'Unknown'), 'error');
                }
            })
            .catch(err => showAdminToast('Failed to delete container: ' + err.message, 'error'));
        }

        function updateActiveNav(targetOnclick) {
            // Remove active from all nav items
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            
            // Add active to the clicked item
            const target = document.querySelector('.nav-link[onclick="' + targetOnclick + '"]');
            if (target && target.parentElement) {
                target.parentElement.classList.add('active');
            }
        }

        function showOrderHistory() {
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `
                <div class="dashboard-inner">
                    <header class="header">
                        <h1 class="title">Order History</h1>
                        <div class="date-time" aria-live="polite">Date: ${new Date().toLocaleDateString()} | Time: ${new Date().toLocaleTimeString()}</div>
                    </header>
                    <section class="quick-actions" aria-label="Quick actions">
                        <button type="button" onclick="loadOrderHistoryData()" aria-label="Refresh order history">Refresh Data</button>
                        <button type="button" onclick="exportOrderHistoryCSV()" style="background: #10b981;">Export CSV</button>
                    </section>
                    
                    <!-- Filters Section -->
                    <section class="metric-card" role="region" aria-label="Filters" style="margin-bottom: 20px;">
                        <h3>Filters</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 5px;">Search Order/Customer</label>
                                <input type="text" id="searchInput" placeholder="Order ID or Customer..." 
                                       style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; width: 100%;">
                            </div>
                            
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 5px;">Batch</label>
                                <select id="filterBatch" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; width: 100%;">
                                    <option value="">All Batches</option>
                                </select>
                            </div>
                            
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 5px;">Status</label>
                                <select id="filterStatus" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; width: 100%;">
                                    <option value="">All Statuses</option>
                                    <option value="active">Active Only</option>
                                    <option value="archived">Archived Only</option>
                                </select>
                            </div>
                            
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 5px;">From Date</label>
                                <input type="date" id="filterDateFrom" 
                                       style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; width: 100%;">
                            </div>
                            
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 5px;">To Date</label>
                                <input type="date" id="filterDateTo" 
                                       style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; width: 100%;">
                            </div>
                            
                            <div style="display: flex; align-items: flex-end; gap: 10px;">
                                <button type="button" onclick="applyOrderHistoryFilters()" 
                                        style="padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                    Apply Filters
                                </button>
                                <button type="button" onclick="resetOrderHistoryFilters()" 
                                        style="padding: 8px 16px; background: #64748b; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                    Reset
                                </button>
                            </div>
                        </div>
                    </section>
                    
                    <section class="metric-card" role="region" aria-label="Order History">
                        <h3>Complete Order History (<span id="orderHistoryCount">0</span> orders)</h3>
                        <div style="overflow-x: auto;">
                            <table class="order-history-table" aria-describedby="order-history-table-desc">
                                <caption id="order-history-table-desc" class="sr-only">Complete order history with customer details</caption>
                                <thead>
                                    <tr>
                                        <th scope="col">Order ID</th>
                                        <th scope="col">Customer</th>
                                        <th scope="col">Date</th>
                                        <th scope="col">Amount</th>
                                        <th scope="col">Batch</th>
                                        <th scope="col">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="orderHistoryBody">
                                    <tr><td colspan="6" style="text-align: center;">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </section>
                </div>
            `;
            
            // Update active state on sidebar
            updateActiveNav('showOrderHistory()');
            
            // Load order history data
            loadOrderHistoryData();
            
            // Add real-time search functionality
            setTimeout(() => {
                const searchInput = document.getElementById('searchInput');
                if (searchInput) {
                    searchInput.addEventListener('input', applyOrderHistoryFilters);
                }
            }, 100);
        }

        function loadOrderHistoryData() {
            fetch('/WRSOMS/api/admin/dashboard.php', { credentials: 'same-origin' })
                .then(r => r.json())
                .then(res => {
                    if (!res.success) throw new Error(res.message || 'Failed to load');
                    const data = res.data || {};
                    cachedOrderHistory = data.order_history || [];
                    
                    // Populate batch filter dropdown
                    populateBatchFilter(cachedOrderHistory);
                    
                    renderOrderHistory(cachedOrderHistory);
                })
                .catch(err => {
                    console.error('Order history load error', err);
                    const tbody = document.getElementById('orderHistoryBody');
                    if (tbody) {
                        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #ef4444;">Error loading order history</td></tr>';
                    }
                });
        }
        
        function populateBatchFilter(orders) {
            const batchFilter = document.getElementById('filterBatch');
            if (!batchFilter) return;
            
            // Get unique batches
            const batches = new Set();
            orders.forEach(o => {
                if (o.vehicle_type && o.batch_number) {
                    batches.add(`${o.vehicle_type} #${o.batch_number}`);
                }
            });
            
            // Clear and repopulate
            batchFilter.innerHTML = '<option value="">All Batches</option>';
            Array.from(batches).sort().forEach(batch => {
                const option = document.createElement('option');
                option.value = batch;
                option.textContent = batch;
                batchFilter.appendChild(option);
            });
        }
        
        function applyOrderHistoryFilters() {
            if (!cachedOrderHistory) return;
            
            const searchTerm = document.getElementById('searchInput')?.value.toLowerCase().trim() || '';
            const batchFilter = document.getElementById('filterBatch')?.value || '';
            const statusFilter = document.getElementById('filterStatus')?.value || '';
            const dateFrom = document.getElementById('filterDateFrom')?.value || '';
            const dateTo = document.getElementById('filterDateTo')?.value || '';
            
            let filtered = cachedOrderHistory.filter(o => {
                // Search filter (order ID or customer name)
                if (searchTerm) {
                    const customerName = `${o.first_name || ''} ${o.last_name || ''}`.toLowerCase();
                    const orderId = (o.reference_id || '').toLowerCase();
                    if (!orderId.includes(searchTerm) && !customerName.includes(searchTerm)) {
                        return false;
                    }
                }
                
                // Batch filter
                if (batchFilter) {
                    const orderBatch = o.vehicle_type && o.batch_number 
                        ? `${o.vehicle_type} #${o.batch_number}` 
                        : '';
                    if (orderBatch !== batchFilter) return false;
                }
                
                // Status filter (active/archived)
                if (statusFilter) {
                    if (statusFilter === 'active' && o.source === 'archived') return false;
                    if (statusFilter === 'archived' && o.source !== 'archived') return false;
                }
                
                // Date range filter
                if (dateFrom || dateTo) {
                    const orderDate = o.order_date ? o.order_date.split(' ')[0] : '';
                    if (dateFrom && orderDate < dateFrom) return false;
                    if (dateTo && orderDate > dateTo) return false;
                }
                
                return true;
            });
            
            renderOrderHistory(filtered);
        }
        
        function resetOrderHistoryFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('filterBatch').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterDateFrom').value = '';
            document.getElementById('filterDateTo').value = '';
            
            renderOrderHistory(cachedOrderHistory);
        }
        
        function exportOrderHistoryCSV() {
            if (!cachedOrderHistory || cachedOrderHistory.length === 0) {
                alert('No data to export');
                return;
            }
            
            // Apply current filters to get the displayed data
            const searchTerm = document.getElementById('searchInput')?.value.toLowerCase().trim() || '';
            const batchFilter = document.getElementById('filterBatch')?.value || '';
            const statusFilter = document.getElementById('filterStatus')?.value || '';
            const dateFrom = document.getElementById('filterDateFrom')?.value || '';
            const dateTo = document.getElementById('filterDateTo')?.value || '';
            
            let filtered = cachedOrderHistory.filter(o => {
                if (searchTerm) {
                    const customerName = `${o.first_name || ''} ${o.last_name || ''}`.toLowerCase();
                    const orderId = (o.reference_id || '').toLowerCase();
                    if (!orderId.includes(searchTerm) && !customerName.includes(searchTerm)) {
                        return false;
                    }
                }
                
                if (batchFilter) {
                    const orderBatch = o.vehicle_type && o.batch_number 
                        ? `${o.vehicle_type} #${o.batch_number}` 
                        : '';
                    if (orderBatch !== batchFilter) return false;
                }
                
                if (statusFilter) {
                    if (statusFilter === 'active' && o.source === 'archived') return false;
                    if (statusFilter === 'archived' && o.source !== 'archived') return false;
                }
                
                if (dateFrom || dateTo) {
                    const orderDate = o.order_date ? o.order_date.split(' ')[0] : '';
                    if (dateFrom && orderDate < dateFrom) return false;
                    if (dateTo && orderDate > dateTo) return false;
                }
                
                return true;
            });
            
            if (filtered.length === 0) {
                alert('No visible data to export');
                return;
            }
            
            // Create CSV with detailed columns
            let csv = 'Order ID,First Name,Last Name,Contact Number,Order Date,Delivery Date,Amount,Payment Method,Payment Status,Batch,Order Status\n';
            
            filtered.forEach(o => {
                const orderId = o.reference_id || 'N/A';
                const firstName = o.first_name || 'N/A';
                const lastName = o.last_name || 'N/A';
                const contact = o.customer_contact || 'N/A';
                const orderDate = o.order_date || 'N/A';
                const deliveryDate = o.delivery_date || 'N/A';
                const amount = o.total_amount || '0';
                const paymentMethod = o.payment_method || 'N/A';
                const paymentStatus = o.payment_status || 'N/A';
                const batch = o.vehicle_type && o.batch_number 
                    ? `${o.vehicle_type} #${o.batch_number}` 
                    : 'Unassigned';
                const status = o.source === 'archived' ? 'Archived' : (o.order_status || 'N/A');
                
                csv += `"${orderId}","${firstName}","${lastName}","${contact}","${orderDate}","${deliveryDate}",${amount},"${paymentMethod}","${paymentStatus}","${batch}","${status}"\n`;
            });
            
            // Download with UTF-8 BOM to fix encoding
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `order_history_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        function renderOrderHistory(orders) {
            const historyBody = document.getElementById('orderHistoryBody');
            if (!historyBody) return;
            
            // Update count
            const countElement = document.getElementById('orderHistoryCount');
            if (countElement) {
                countElement.textContent = orders.length;
            }
            
            historyBody.innerHTML = '';
            if (orders.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td colspan="6" style="padding: 0;">
                        <div class="empty-state">
                            <div class="empty-state-icon">
                                <i class="fa fa-history"></i>
                            </div>
                            <h2 class="empty-state-title">No Order History</h2>
                        </div>
                    </td>
                `;
                historyBody.appendChild(tr);
            } else {
                orders.forEach(o => {
                    const customerName = o.first_name && o.last_name ? `${o.first_name} ${o.last_name}` : 'N/A';
                    const batchInfo = o.vehicle_type && o.batch_number ? `${o.vehicle_type} #${o.batch_number}` : 'Unassigned';
                    
                    // Add archived badge if order is from archived source
                    const isArchived = o.source === 'archived';
                    const statusBadge = isArchived 
                        ? `<span class="badge" style="background: #fef3c7; color: #92400e;">Archived</span>`
                        : `<span class="badge ${getStatusClass(o.order_status)}">${escapeHtml(o.order_status || 'N/A')}</span>`;
                    
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><strong>${escapeHtml(o.reference_id)}</strong></td>
                        <td>${escapeHtml(customerName)}</td>
                        <td>${formatDateTime(o.order_date)}</td>
                        <td>${money(o.total_amount)}</td>
                        <td>${escapeHtml(batchInfo)}</td>
                        <td>${statusBadge}</td>
                    `;
                    historyBody.appendChild(tr);
                });
            }
        }

        function toggleReportSidebar() {
            document.getElementById('reportSidebar').classList.toggle('active');
        }

        function showDailyReport(date = '') {
            const mainContent = document.getElementById('mainContent');
            
            // Show loading state
            mainContent.innerHTML = `
                <div class="dashboard-inner">
                    <header class="header">
                        <h1 class="title">Daily Sales Report</h1>
                        <div class="date-time">Loading...</div>
                    </header>
                    <div style="text-align: center; padding: 40px;">
                        <i class="fa fa-spinner fa-spin" style="font-size: 48px; color: #3b82f6;"></i>
                        <p style="margin-top: 16px; color: #6b7280;">Loading report data...</p>
                    </div>
                </div>
            `;
            
            updateActiveNav('showDailyReport()');
            
            // Fetch daily report data from API
            const apiUrl = '/WRSOMS/api/admin/daily_report.php' + (date ? '?date=' + encodeURIComponent(date) : '');
            
            fetch(apiUrl, { credentials: 'same-origin' })
                .then(r => r.json())
                .then(res => {
                    if (!res.success) throw new Error(res.message || 'Failed to load report');
                    
                    const data = res.data;
                    const stats = data.stats;
                    const charts = data.charts;
                    
                    // Render the daily report UI
                    mainContent.innerHTML = `
                        <div class="dashboard-inner">
                            <header class="header">
                                <h1 class="title">Daily Sales Report</h1>
                                <div class="date-time">${new Date(data.selected_date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</div>
                            </header>
                            
                            <section class="quick-actions" style="justify-content: space-between;">
                                <button type="button" onclick="showDailyReport('${data.prev_date}')" class="btn btn-outline-primary">
                                    <i class="fa fa-arrow-left"></i> Previous Day
                                </button>
                                <button type="button" onclick="showDailyReport()" class="btn btn-primary">
                                    <i class="fa fa-calendar"></i> Today
                                </button>
                                ${!data.is_today ? '<button type="button" onclick="showDailyReport(\'' + data.next_date + '\')" class="btn btn-outline-primary">Next Day <i class="fa fa-arrow-right"></i></button>' : ''}
                            </section>
                            
                            <!-- Stats Cards -->
                            <section class="metrics">
                                <div class="metric-card" data-color="blue">
                                    <div class="metric-card-inner">
                                        <span class="metric-icon"><i class="fa fa-money"></i></span>
                                        <div class="metric-text">
                                            <h3>Total Revenue</h3>
                                            <p>${money(stats.total_revenue)}</p>
                                            <small style="color: #6b7280;">${stats.orders_today} orders</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="metric-card" data-color="green">
                                    <div class="metric-card-inner">
                                        <span class="metric-icon"><i class="fa fa-shopping-cart"></i></span>
                                        <div class="metric-text">
                                            <h3>Orders Today</h3>
                                            <p>${stats.orders_today}</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="metric-card" data-color="purple">
                                    <div class="metric-card-inner">
                                        <span class="metric-icon"><i class="fa fa-users"></i></span>
                                        <div class="metric-text">
                                            <h3>New Customers</h3>
                                            <p>${stats.new_customers_today}</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="metric-card" data-color="teal">
                                    <div class="metric-card-inner">
                                        <span class="metric-icon"><i class="fa fa-check-circle"></i></span>
                                        <div class="metric-text">
                                            <h3>Completed Payments</h3>
                                            <p>${money(stats.completed_payments_today)}</p>
                                        </div>
                                    </div>
                                </div>
                            </section>
                            
                            <!-- Charts Row -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px;">
                                <section class="metric-card">
                                    <h3>Revenue - Last 7 Days</h3>
                                    <canvas id="revenueChart" style="max-height: 300px;"></canvas>
                                </section>
                                <section class="metric-card">
                                    <h3>Orders - Last 7 Days</h3>
                                    <canvas id="ordersChart" style="max-height: 300px;"></canvas>
                                </section>
                            </div>
                            
                            <!-- Tables Row -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <section class="metric-card">
                                    <h3>Recent Orders</h3>
                                    <div style="overflow-x: auto;">
                                        <table class="batch-table">
                                            <thead>
                                                <tr>
                                                    <th>Order ID</th>
                                                    <th>Customer</th>
                                                    <th>Amount</th>
                                                </tr>
                                            </thead>
                                            <tbody id="recentOrdersTable">
                                                ${data.recent_orders.length > 0 ? 
                                                    data.recent_orders.map(o => `
                                                        <tr>
                                                            <td><strong>${escapeHtml(o.reference_id)}</strong></td>
                                                            <td>${escapeHtml(o.customer_name || 'Guest')}</td>
                                                            <td>${money(o.total_amount)}</td>
                                                        </tr>
                                                    `).join('') :
                                                    `<tr><td colspan="3" style="padding: 0;">
                                                        <div class="empty-state" style="padding: 40px 20px;">
                                                            <div class="empty-state-icon" style="width: 80px; height: 80px; margin: 0 auto 16px;">
                                                                <i class="fa fa-calendar-o"></i>
                                                            </div>
                                                            <h2 class="empty-state-title" style="font-size: 1.125rem;">No Orders for This Date</h2>
                                                        </div>
                                                    </td></tr>`
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                </section>
                                
                                <section class="metric-card">
                                    <h3>Top Selling Containers (30 Days)</h3>
                                    <div style="overflow-x: auto;">
                                        <table class="batch-table">
                                            <thead>
                                                <tr>
                                                    <th>Container</th>
                                                    <th>Quantity</th>
                                                    <th>Revenue</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${data.top_products.length > 0 ?
                                                    data.top_products.map(p => `
                                                        <tr>
                                                            <td>${escapeHtml(p.container_type)}</td>
                                                            <td>${p.qty}</td>
                                                            <td>${money(p.revenue)}</td>
                                                        </tr>
                                                    `).join('') :
                                                    `<tr><td colspan="3" style="padding: 0;">
                                                        <div class="empty-state" style="padding: 40px 20px;">
                                                            <div class="empty-state-icon" style="width: 80px; height: 80px; margin: 0 auto 16px;">
                                                                <i class="fa fa-shopping-cart"></i>
                                                            </div>
                                                            <h2 class="empty-state-title" style="font-size: 1.125rem;">No Sales in Last 30 Days</h2>
                                                        </div>
                                                    </td></tr>`
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                </section>
                            </div>
                        </div>
                    `;
                    
                    // Render charts
                    setTimeout(() => {
                        renderDailyReportCharts(charts);
                    }, 100);
                })
                .catch(error => {
                    console.error('Error loading daily report:', error);
                    mainContent.innerHTML = `
                        <div class="dashboard-inner">
                            <header class="header">
                                <h1 class="title">Daily Sales Report</h1>
                            </header>
                            <div style="text-align: center; padding: 40px; color: #ef4444;">
                                <i class="fa fa-exclamation-triangle" style="font-size: 48px;"></i>
                                <p style="margin-top: 16px;">Error loading daily report: ${error.message}</p>
                                <button onclick="showDailyReport()" class="btn btn-primary" style="margin-top: 16px;">Try Again</button>
                            </div>
                        </div>
                    `;
                });
        }
        
        function renderDailyReportCharts(charts) {
            const revenueCtx = document.getElementById('revenueChart');
            const ordersCtx = document.getElementById('ordersChart');
            
            if (!revenueCtx || !ordersCtx) return;
            
            // Revenue Line Chart
            new Chart(revenueCtx, {
                type: 'line',
                data: {
                    labels: charts.labels,
                    datasets: [{
                        label: 'Revenue (₱)',
                        data: charts.revenue_data,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '₱' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
            
            // Orders Bar Chart
            new Chart(ordersCtx, {
                type: 'bar',
                data: {
                    labels: charts.labels,
                    datasets: [{
                        label: 'Orders',
                        data: charts.orders_data,
                        backgroundColor: '#10b981'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        function loadManageOrders(e) {
            if (e) e.preventDefault();
            fetch('manage-orders.html?v=' + Date.now())
                .then(response => response.text())
                .then(data => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(data, 'text/html');
                    const container = doc.querySelector('.container');
                    if (!container) {
                        document.getElementById('mainContent').innerHTML = '<p>Error: manage orders content not found.</p>';
                        return;
                    }
                    // Replace main content with the fetched container
                    document.getElementById('mainContent').innerHTML = container.outerHTML;

                    // Execute any inline scripts from the fetched page
                    const scripts = Array.from(doc.querySelectorAll('script'))
                        .map(s => s.textContent)
                        .join('\n');
                    if (scripts) {
                        const scriptElement = document.createElement('script');
                        scriptElement.textContent = scripts;
                        document.getElementById('mainContent').appendChild(scriptElement);
                    }

                    // Update active state on sidebar
                    updateActiveNav('loadManageOrders(event)');
                })
                .catch(error => {
                    console.error('Error loading manage orders:', error);
                    document.getElementById('mainContent').innerHTML = '<p>Error loading Manage Orders. Please try again.</p>';
                });
        }

        function fetchDates() {
            // Daily report is a static HTML page, no date selection needed
            // If you need dynamic date functionality, create an API endpoint
            console.log('Daily report date selection not implemented');
        }

        function showInventoryManagement() {
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `
                <div class="dashboard-inner">
                    <header class="header">
                        <h1 class="title">Inventory Management</h1>
                        <div class="date-time" aria-live="polite">Date: ${new Date().toLocaleDateString()} | Time: ${new Date().toLocaleTimeString()}</div>
                    </header>
                    <div class="inventory-tabs" style="display: flex; gap: 32px; margin-bottom: 32px; border-bottom: 2px solid #e5e7eb; justify-content: flex-start;">
                        <button class="inventory-tab active" id="product-tab-btn" onclick="switchInventoryTab('product')" style="background: none; border: none; outline: none; font-size: 1.1rem; font-weight: 600; color: #2563eb; padding: 16px 0; border-bottom: 3px solid #2563eb; display: flex; align-items: center; gap: 10px; cursor: pointer; transition: color 0.2s, border-bottom 0.2s;">
                            <i class="fa fa-cube" style="font-size: 1.2em;"></i>
                            Product Inventory
                        </button>
                        <button class="inventory-tab" id="vehicle-tab-btn" onclick="switchInventoryTab('vehicle')" style="background: none; border: none; outline: none; font-size: 1.1rem; font-weight: 600; color: #64748b; padding: 16px 0; border-bottom: 3px solid transparent; display: flex; align-items: center; gap: 10px; cursor: pointer; transition: color 0.2s, border-bottom 0.2s;">
                            <i class="fa fa-truck" style="font-size: 1.2em;"></i>
                            Vehicle Inventory
                        </button>
                    </div>
                    <div id="productInventoryTab" class="inventory-tab-section" style="background: white; border-radius: 20px; padding: 32px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); max-width: 900px;">
                        <section class="metric-card" role="region" aria-label="Container Stock">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                <h3 style="margin: 0;">Container Stock Inventory</h3>
                                <div style="display:flex; gap:12px; align-items:center;">
                                    <button onclick="showAddContainerModal()" class="btn btn-sm btn-primary">
                                        <i class="fa fa-plus"></i> Add New Container Type
                                    </button>
                                    <button onclick="showWaterTypesModal()" class="btn btn-sm btn-secondary">
                                        <i class="fa fa-tint"></i> Manage Water Types
                                    </button>
                                </div>
                            </div>
                            <div id="orderTypePriceCard" style="margin-bottom: 18px; background: #fff; border-radius: 12px; padding: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.04); max-width: 520px;">
                                <h4 style="margin-top: 0;">Order Type Pricing</h4>
                                <div style="display:flex; gap:12px; align-items:center;">
                                    <label style="width: 220px; font-weight:600;">Purchase New Container/s (₱)</label>
                                    <input type="number" id="purchaseNewPriceInput" min="0" step="0.01" style="flex:1; padding:8px; border-radius:6px; border:1px solid #e5e7eb;">
                                    <button class="btn btn-sm btn-primary" id="savePurchaseNewPriceBtn">Save</button>
                                </div>
                                <p style="color:#6b7280; font-size:0.9rem; margin-top:8px;">Set the price customers pay when purchasing a new empty container. Defaults to ₱250.00 if not set.</p>
                            </div>
                            <div id="containerCardGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 32px;">
                                <!-- Cards will be rendered here by JS -->
                            </div>
                        </section>
                    </div>
                    <div id="vehicleInventoryTab" class="inventory-tab-section" style="background: white; border-radius: 20px; padding: 32px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); max-width: 900px; display: none;">
                        <section class="metric-card" role="region" aria-label="Vehicle Capacity">
                            <h3>Vehicle Capacity Settings</h3>
                            <div style="margin-bottom: 20px;">
                                <table class="batch-table">
                                    <thead>
                                        <tr>
                                            <th>Vehicle Type</th>
                                            <th>Capacity (Containers)</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="vehicleCapacityBody">
                                        <tr>
                                            <td>Tricycle</td>
                                            <td><input type="number" id="tricycleCapacity" value="5" min="1" max="20" style="width: 80px; padding: 6px;"></td>
                                            <td><button onclick="saveVehicleCapacity('Tricycle')" class="btn btn-sm btn-primary">Save</button></td>
                                        </tr>
                                        <tr>
                                            <td>Car</td>
                                            <td><input type="number" id="carCapacity" value="10" min="1" max="50" style="width: 80px; padding: 6px;"></td>
                                            <td><button onclick="saveVehicleCapacity('Car')" class="btn btn-sm btn-primary">Save</button></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <p style="color: #6b7280; font-size: 0.9rem;">
                                <i class="fa fa-info-circle"></i> Vehicle capacity determines the maximum number of containers per batch.
                            </p>
                        </section>
                    </div>
                    <!-- Add/Edit Container Modal -->
                    <div id="containerModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
                        <div style="background: white; padding: 24px; border-radius: 12px; max-width: 500px; width: 90%;">
                            <h3 id="modalTitle">Add New Container</h3>
                            <form id="containerForm" onsubmit="saveContainer(event)">
                                <input type="hidden" id="containerId" value="">
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 6px; font-weight: 600;">Container Type:</label>
                                    <input type="text" id="containerType" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 6px; font-weight: 600;">Refill Price (₱):</label>
                                        <input type="number" id="containerPrice" required step="0.01" min="0" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 6px; font-weight: 600;">Stock Quantity:</label>
                                    <input type="number" id="containerStock" required min="0" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 6px; font-weight: 600;">Container Image:</label>
                                    <input type="file" id="containerImage" accept="image/*" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                    <button type="button" onclick="closeContainerModal()" class="btn btn-secondary">Cancel</button>
                                    <button type="submit" class="btn btn-primary">Save</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            // Update active state on sidebar
            updateActiveNav('showInventoryManagement()');
            // Load vehicle capacity settings
            const tricycleCapacity = localStorage.getItem('vehicleCapacity_Tricycle') || '5';
            const carCapacity = localStorage.getItem('vehicleCapacity_Car') || '10';
            setTimeout(() => {
                const tricycleInput = document.getElementById('tricycleCapacity');
                const carInput = document.getElementById('carCapacity');
                if (tricycleInput) tricycleInput.value = tricycleCapacity;
                if (carInput) carInput.value = carCapacity;
            }, 100);
            // Load data from database
            loadInventoryData();
            // Load purchase new price and wire save button
            setTimeout(() => {
                const saveBtn = document.getElementById('savePurchaseNewPriceBtn');
                if (saveBtn) saveBtn.addEventListener('click', savePurchaseNewPrice);
                loadPurchaseNewPrice();
            }, 150);
        }

        // Tab switching logic for inventory
        function switchInventoryTab(tab) {
            const productTab = document.getElementById('productInventoryTab');
            const vehicleTab = document.getElementById('vehicleInventoryTab');
            const productBtn = document.getElementById('product-tab-btn');
            const vehicleBtn = document.getElementById('vehicle-tab-btn');
            if (tab === 'product') {
                productTab.style.display = 'block';
                vehicleTab.style.display = 'none';
                productBtn.classList.add('active');
                productBtn.style.color = '#2563eb';
                productBtn.style.borderBottom = '3px solid #2563eb';
                vehicleBtn.classList.remove('active');
                vehicleBtn.style.color = '#64748b';
                vehicleBtn.style.borderBottom = '3px solid transparent';
            } else {
                productTab.style.display = 'none';
                vehicleTab.style.display = 'block';
                vehicleBtn.classList.add('active');
                vehicleBtn.style.color = '#2563eb';
                vehicleBtn.style.borderBottom = '3px solid #2563eb';
                productBtn.classList.remove('active');
                productBtn.style.color = '#64748b';
                productBtn.style.borderBottom = '3px solid transparent';
            }
        }

        function loadInventoryData() {
            // Load inventory data from database
            fetch('/WRSOMS/api/admin/inventory.php', { credentials: 'same-origin' })
                .then(r => r.json())
                .then(response => {
                    if (!response.success) {
                        throw new Error(response.message || 'Failed to load inventory');
                    }
                    renderContainerStock(response.data);
                    // If every container has a per-container purchase_price set, hide the global Order Type Pricing card
                    try {
                        const card = document.getElementById('orderTypePriceCard');
                        if (card && Array.isArray(response.data)) {
                            const allHavePurchase = response.data.length > 0 && response.data.every(c => c.purchase_price !== null && c.purchase_price !== undefined);
                            card.style.display = allHavePurchase ? 'none' : 'block';
                        }
                    } catch (e) {
                        console.error('Error evaluating purchase_price visibility:', e);
                    }
                })
                .catch(err => {
                    console.error('Error loading inventory:', err);
                    const tbody = document.getElementById('containerStockBody');
                    if (tbody) tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #ef4444;">Error loading data: ' + err.message + '</td></tr>';
                });
        }

        function renderContainerStock(containers) {
            const grid = document.getElementById('containerCardGrid');
            if (!grid) return;
            grid.innerHTML = '';
            if (!containers || containers.length === 0) {
                grid.innerHTML = '<div style="text-align:center; grid-column: 1/-1;">No containers found.</div>';
                return;
            }
            containers.forEach(c => {
                const stock = parseInt(c.stock_quantity || 0);
                const statusBadge = stock > 10 ? 
                    '<span class="badge bg-success">In Stock</span>' : 
                    stock > 0 ? 
                    '<span class="badge bg-warning">Low Stock</span>' : 
                    '<span class="badge bg-danger">Out of Stock</span>';
                // Use default image if not present
                let imgSrc = '';
                if (c.image && c.image.trim() !== '') {
                    imgSrc = c.image;
                } else if (c.container_type.toLowerCase().includes('round')) {
                    imgSrc = '/WRSOMS/assets/images/round_container.jpg';
                } else if (c.container_type.toLowerCase().includes('slim')) {
                    imgSrc = '/WRSOMS/assets/images/slim_container.jpg';
                } else {
                    imgSrc = '/WRSOMS/assets/images/placeholder.svg';
                }
                const card = document.createElement('div');
                card.className = 'container-card';
                card.style = 'background: #f9fafb; border-radius: 16px; box-shadow: 0 2px 12px rgba(0,0,0,0.06); padding: 24px; display: flex; flex-direction: column; align-items: center; gap: 16px;';
                const launchBtnText = c.is_visible ? 'Hide' : 'Launch';
                const launchBtnClass = c.is_visible ? 'btn-warning' : 'btn-primary';
                card.innerHTML = `
                    <img src="${imgSrc}" alt="${escapeHtml(c.container_type)} Container" style="width: 120px; height: 120px; object-fit: contain; margin-bottom: 8px; background: #fff; border: 1px solid #e5e7eb; border-radius: 8px;">
                    <h4 style="margin: 0 0 4px 0; font-size: 1.15rem; color: #334155;">${escapeHtml(c.container_type)} Container</h4>
                    <div style="display: flex; flex-direction: column; gap: 8px; width: 100%;">
                        <label style="font-weight: 500; color: #2563eb;">Price:</label>
                        <input type="number" value="${parseFloat(c.price).toFixed(2)}" min="0" step="0.01" style="width: 100%; padding: 6px 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 1rem;" onchange="updateContainerPrice(${c.container_id}, this.value)">
                        ${c.purchase_price !== null && c.purchase_price !== undefined ? `<div style="margin-top:6px; font-size:0.95rem; color:#0366d6; font-weight:600;">Purchase price: ₱${parseFloat(c.purchase_price).toFixed(2)}</div>` : ''}
                        <label style="font-weight: 500; color: #2563eb;">Stock Quantity:</label>
                        <input type="number" value="${stock}" min="0" style="width: 100%; padding: 6px 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 1rem;" onchange="updateContainerStock(${c.container_id}, this.value)">
                    </div>
                    <div style="margin-top: 8px;">${statusBadge}</div>
                    <div style="display: flex; gap: 10px; margin-top: 12px;">
                        <button class="btn btn-sm btn-info" onclick="editContainer(${c.container_id})"><i class="fa fa-edit"></i> Edit</button>
                        <button class="btn btn-sm btn-success" onclick="updateStock(${c.container_id}, '${escapeHtml(c.container_type)}')"><i class="fa fa-plus"></i> Add Stock</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteContainer(${c.container_id})"><i class="fa fa-trash"></i> Delete</button>
                        <button class="btn btn-sm ${launchBtnClass}" onclick="toggleContainerVisibility(${c.container_id}, ${c.is_visible ? 0 : 1})">
                            <i class="fa fa-eye${c.is_visible ? '-slash' : ''}"></i> ${launchBtnText}
                        </button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }
        // Editable price/stock handlers
        function updateContainerPrice(id, value) {
            // Update container price via containers API (POST multipart)
            const formData = new FormData();
            formData.append('container_id', id);
            formData.append('price', value);
            fetch('/WRSOMS/api/common/containers.php', {
                method: 'POST',
                credentials: 'same-origin',
                body: formData
            })
            .then(r => r.json())
            .then(res => {
                if (res.success) {
                    showAdminToast('Price updated', 'success');
                    loadInventoryData();
                } else {
                    showAdminToast('Error updating price: ' + (res.message || 'Unknown'), 'error');
                }
            })
            .catch(err => {
                showAdminToast('Failed to update price: ' + err.message, 'error');
            });
        }
        function updateContainerStock(id, value) {
            // Persist stock change using admin inventory API (PUT)
            fetch('/WRSOMS/api/admin/inventory.php', {
                method: 'PUT',
                credentials: 'same-origin',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ container_id: id, stock: value })
            })
            .then(r => r.json())
            .then(res => {
                if (res.success) {
                    showAdminToast('Stock updated', 'success');
                    loadInventoryData();
                } else {
                    showAdminToast('Error updating stock: ' + (res.message || 'Unknown'), 'error');
                }
            })
            .catch(err => showAdminToast('Failed to update stock: ' + err.message, 'error'));
        }

        // Load and save purchase-new price from settings via order_types API
        function loadPurchaseNewPrice() {
            fetch('/WRSOMS/api/common/order_types.php', { credentials: 'same-origin' })
                .then(r => r.json())
                .then(types => {
                    const pt = Array.isArray(types) ? types.find(t => String(t.type_name).trim() === 'Purchase New Container/s') : null;
                    const val = pt && pt.price !== null && !isNaN(Number(pt.price)) ? Number(pt.price).toFixed(2) : '250.00';
                    const input = document.getElementById('purchaseNewPriceInput');
                    if (input) input.value = val;
                })
                .catch(err => console.error('Failed to load purchase price:', err));
        }

        function savePurchaseNewPrice() {
            const input = document.getElementById('purchaseNewPriceInput');
            if (!input) return;
            const value = input.value;
            if (value === '' || isNaN(Number(value))) { showAdminToast('Please enter a valid numeric price', 'error'); return; }
            fetch('/WRSOMS/api/admin/update_order_type_price.php', {
                method: 'POST',
                credentials: 'same-origin',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ key: 'purchase_new_price', value: String(Number(value)) })
            })
            .then(r => r.json())
            .then(res => {
                if (res.success) {
                    showAdminToast('Purchase new price updated', 'success');
                } else {
                    showAdminToast('Error: ' + (res.message || 'Unknown'), 'error');
                }
            })
            .catch(err => showAdminToast('Failed to save price: ' + err.message, 'error'));
        }

        function saveVehicleCapacity(vehicleType) {
            const capacity = vehicleType === 'Tricycle' ? 
                document.getElementById('tricycleCapacity').value : 
                document.getElementById('carCapacity').value;
            
            // Store in localStorage for now (you can create an API endpoint later)
            localStorage.setItem('vehicleCapacity_' + vehicleType, capacity);
            alert(vehicleType + ' capacity updated to ' + capacity + ' containers');
        }

        function showAddContainerModal() {
            document.getElementById('modalTitle').textContent = 'Add New Container';
            document.getElementById('containerId').value = '';
            document.getElementById('containerType').value = '';
            document.getElementById('containerType').disabled = false;
            // Removed size field
            document.getElementById('containerPrice').value = '';
            document.getElementById('containerPrice').disabled = false;
            document.getElementById('containerStock').value = '';
            document.getElementById('containerModal').style.display = 'flex';
        }

        function closeContainerModal() {
            document.getElementById('containerModal').style.display = 'none';
            // Re-enable fields for next time
            document.getElementById('containerType').disabled = false;
            // Removed size field
            document.getElementById('containerPrice').disabled = false;
        }

        function editContainer(containerId) {
            // Fetch container details from the admin inventory API (returns full info)
            fetch('/WRSOMS/api/admin/inventory.php', { credentials: 'same-origin' })
                .then(r => r.json())
                .then(response => {
                    if (!response.success) throw new Error(response.message || 'Failed to load inventory');
                    const containers = response.data || [];
                    const c = containers.find(cont => parseInt(cont.container_id, 10) === parseInt(containerId, 10));
                    if (!c) throw new Error('Container not found');

                    document.getElementById('modalTitle').textContent = 'Edit Container - ' + c.container_type;
                    document.getElementById('containerId').value = c.container_id;
                    document.getElementById('containerType').value = c.container_type;
                    // Allow editing container type/name
                    document.getElementById('containerType').disabled = false;
                    document.getElementById('containerPrice').value = parseFloat(c.price).toFixed(2);
                    document.getElementById('containerPrice').disabled = false; // Editable
                    // If this container has its own purchase_price, show it in a dedicated input
                    let purchaseInput = document.getElementById('containerPurchasePrice');
                    if (!purchaseInput) {
                        const parent = document.getElementById('containerForm').querySelector('div:nth-child(4)');
                        const el = document.createElement('div');
                        el.style = 'margin-bottom:16px;';
                        el.innerHTML = `
                            <label style="display: block; margin-bottom: 6px; font-weight: 600;">Purchase Price (₱):</label>
                            <input type="number" id="containerPurchasePrice" step="0.01" min="0" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                        `;
                        parent.parentNode.insertBefore(el, parent.nextSibling);
                        purchaseInput = document.getElementById('containerPurchasePrice');
                    }
                    if (purchaseInput) purchaseInput.value = c.purchase_price !== null ? parseFloat(c.purchase_price).toFixed(2) : '';
                    // Populate stock with current inventory value
                    document.getElementById('containerStock').value = parseInt(c.stock_quantity || 0, 10);
                    // Clear file input (admin can choose a new file to replace)
                    const imgInput = document.getElementById('containerImage');
                    if (imgInput) imgInput.value = '';
                    document.getElementById('containerModal').style.display = 'flex';
                })
                .catch(err => alert('Error loading container: ' + err.message));
        }

        function saveContainer(event) {
            event.preventDefault();
            const containerId = document.getElementById('containerId').value;
            const stockQuantity = document.getElementById('containerStock').value;
            const price = document.getElementById('containerPrice').value;
            if (containerId) {
                // Get previous values for comparison
                fetch('/WRSOMS/api/common/containers.php', { credentials: 'same-origin' })
                    .then(r => r.json())
                    .then(containers => {
                        const c = containers.find(cont => cont.container_id == containerId);
                        const prevPrice = c ? String(c.price) : '';
                        const stockKey = 'container_stock_' + containerId;
                        const prevStock = localStorage.getItem(stockKey) || '';
                        // Prepare update: allow editing container type, price and optionally photo
                        const typeInput = document.getElementById('containerType').value.trim();
                        const imageInput = document.getElementById('containerImage');
                        const imageFile = imageInput && imageInput.files.length > 0 ? imageInput.files[0] : null;

                        const formData = new FormData();
                        formData.append('container_id', containerId);
                        formData.append('container_type', typeInput);
                        formData.append('price', price);
                        if (imageFile) formData.append('photo', imageFile);

                        const updatePromise = (function(){
                            // Append purchase_price if present in modal
                            const purchaseInput = document.getElementById('containerPurchasePrice');
                            if (purchaseInput && purchaseInput.value !== '') {
                                formData.append('purchase_price', purchaseInput.value);
                            }
                            return fetch('/WRSOMS/api/common/containers.php', {
                            method: 'POST',
                            credentials: 'same-origin',
                            body: formData
                        }).then(r => r.json());
                        })();

                        // Update stock in database
                        const stockPromise = fetch('/WRSOMS/api/admin/inventory.php', {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'same-origin',
                            body: JSON.stringify({ container_id: containerId, stock: stockQuantity })
                        }).then(r => r.json());

                        Promise.all([updatePromise, stockPromise]).then(([updateRes, stockRes]) => {
                            let stockChanged = prevStock !== stockQuantity;
                            let success = true;
                            if (!updateRes.success) {
                                showAdminToast('Error updating container: ' + (updateRes.message || 'Unknown'), 'error');
                                success = false;
                            }
                            if (!stockRes.success) {
                                showAdminToast('Error updating stock: ' + stockRes.message, 'error');
                                success = false;
                            }
                            if (success) {
                                localStorage.setItem(stockKey, stockQuantity);
                                showAdminToast('Container updated successfully', 'success');
                                closeContainerModal();
                                loadInventoryData();
                            }
                        }).catch(err => showAdminToast('Error updating container: ' + err.message, 'error'));
                    })
                    .catch(err => showAdminToast('Error loading previous container data: ' + err.message, 'error'));
            } else {
                // Add new container logic
                const type = document.getElementById('containerType').value.trim();
                const price = document.getElementById('containerPrice').value;
                const stock = document.getElementById('containerStock').value;
                const imageInput = document.getElementById('containerImage');
                const imageFile = imageInput && imageInput.files.length > 0 ? imageInput.files[0] : null;

                if (!type || !price || !stock) {
                    showAdminToast('Please fill in all required fields.', 'error');
                    return;
                }

                const formData = new FormData();
                formData.append('container_type', type);
                formData.append('price', price);
                const newPurchaseInput = document.getElementById('containerPurchasePrice');
                if (newPurchaseInput && newPurchaseInput.value !== '') formData.append('purchase_price', newPurchaseInput.value);
                formData.append('stock_quantity', stock);
                if (imageFile) formData.append('photo', imageFile);

                fetch('/WRSOMS/api/common/containers.php', {
                    method: 'POST',
                    credentials: 'same-origin',
                    body: formData
                })
                .then(r => r.json())
                .then(res => {
                    if (res.success) {
                        showAdminToast('New container type added successfully!', 'success');
                        closeContainerModal();
                        loadInventoryData();
                    } else {
                        showAdminToast('Error adding container: ' + (res.message || 'Unknown error'), 'error');
                    }
                })
                .catch(err => {
                    showAdminToast('Failed to add container: ' + err.message, 'error');
                });
            }
        }

        // Custom Add Stock Modal
        function updateStock(containerId, containerType) {
            // Create modal if not exists
            let modal = document.getElementById('addStockModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'addStockModal';
                modal.style.position = 'fixed';
                modal.style.top = '0';
                modal.style.left = '0';
                modal.style.right = '0';
                modal.style.bottom = '0';
                modal.style.background = 'rgba(0,0,0,0.5)';
                modal.style.zIndex = '10000';
                modal.style.display = 'flex';
                modal.style.alignItems = 'center';
                modal.style.justifyContent = 'center';
                modal.innerHTML = `
                    <div style="background: white; padding: 32px 24px; border-radius: 12px; max-width: 350px; width: 100%; box-shadow: 0 2px 12px rgba(0,0,0,0.15);">
                        <h3 style='margin-bottom: 18px;'>Add Stock for <span id='addStockType'></span></h3>
                        <label for='addStockQty' style='font-weight: 600; margin-bottom: 8px; display: block;'>Quantity to Add:</label>
                        <input type='number' id='addStockQty' min='1' value='1' style='width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 18px;'>
                        <div style='display: flex; gap: 12px; justify-content: flex-end;'>
                            <button id='addStockCancel' class='btn btn-secondary'>Cancel</button>
                            <button id='addStockConfirm' class='btn btn-primary'>Add</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            document.getElementById('addStockType').textContent = containerType;
            document.getElementById('addStockQty').value = '1';
            modal.style.display = 'flex';

            // Cancel button
            document.getElementById('addStockCancel').onclick = function() {
                modal.style.display = 'none';
            };

            // Confirm button
            document.getElementById('addStockConfirm').onclick = function() {
                const qty = parseInt(document.getElementById('addStockQty').value);
                if (isNaN(qty) || qty <= 0) {
                    showAdminToast('Please enter a valid positive number', 'error');
                    return;
                }
                // Get current stock from table row
                let currentStock = 0;
                const row = Array.from(document.querySelectorAll('#containerStockBody tr')).find(tr => {
                    return tr.querySelector('button.btn-info') && tr.querySelector('button.btn-info').getAttribute('onclick').includes(containerId);
                });
                if (row) {
                    const stockCell = row.querySelector('td:nth-child(4)');
                    if (stockCell) currentStock = parseInt(stockCell.textContent.trim()) || 0;
                }
                const newStock = currentStock + qty;
                // Update stock in database
                fetch('/WRSOMS/api/admin/inventory.php', {
                    method: 'PUT',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        container_id: containerId,
                        stock: newStock
                    })
                })
                .then(r => r.json())
                .then(response => {
                    if (response.success) {
                        showAdminToast('Stock updated successfully. New stock: ' + newStock, 'success');
                        loadInventoryData();
                        modal.style.display = 'none';
                    } else {
                        showAdminToast('Error updating stock: ' + response.message, 'error');
                    }
                })
                .catch(err => {
                    showAdminToast('Failed to update stock. Please try again.', 'error');
                });
            };
        }
        // ===== FEEDBACK MANAGEMENT =====
        function showFeedback() {
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `
                <div class="dashboard-inner">
                    <header class="header">
                        <h1 class="title">Customer Feedback</h1>
                        <div class="date-time" aria-live="polite">Date: ${new Date().toLocaleDateString()} | Time: ${new Date().toLocaleTimeString()}</div>
                    </header>
                    
                    <!-- Search and Filters Section -->
                    <section class="quick-actions" aria-label="Search and filters" style="margin-bottom: 24px;">
                        <div class="search-container" style="flex: 1; max-width: 600px;">
                            <i class="fa fa-search"></i>
                            <input type="text" id="feedbackSearch" placeholder="Search by customer name, email, or message..." class="search-input">
                        </div>
                        <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
                            <select id="ratingFilter" style="padding: 10px 16px; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 0.875rem; font-weight: 600; color: #475569; background: white; cursor: pointer; transition: all 0.3s ease;">
                                <option value="">All Ratings</option>
                                <option value="5">5 Stars</option>
                                <option value="4">4 Stars</option>
                                <option value="3">3 Stars</option>
                                <option value="2">2 Stars</option>
                                <option value="1">1 Star</option>
                            </select>
                            <select id="categoryFilter" style="padding: 10px 16px; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 0.875rem; font-weight: 600; color: #475569; background: white; cursor: pointer; transition: all 0.3s ease;">
                                <option value="">All Categories</option>
                                <option value="Product">Product</option>
                                <option value="Service">Service</option>
                                <option value="Website">Website</option>
                                <option value="Other">Other</option>
                            </select>
                            <button onclick="loadFeedback()" style="padding: 10px 20px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border: none; border-radius: 12px; font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);">
                                <i class="fa fa-refresh"></i>
                                Refresh
                            </button>
                        </div>
                    </section>
                    
                    <!-- Feedback Stats -->
                    <div class="feedback-stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 32px;">
                        <div class="stat-card" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);">
                            <i class="fa fa-comments" style="font-size: 2rem; opacity: 0.9; margin-bottom: 8px;"></i>
                            <h3 style="margin: 0; font-size: 2rem; font-weight: 700;" id="totalFeedbackCount">0</h3>
                            <p style="margin: 4px 0 0 0; opacity: 0.9; font-size: 0.875rem;">Total Feedback</p>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); color: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3);">
                            <i class="fa fa-star" style="font-size: 2rem; opacity: 0.9; margin-bottom: 8px;"></i>
                            <h3 style="margin: 0; font-size: 2rem; font-weight: 700;" id="avgRating">0.0</h3>
                            <p style="margin: 4px 0 0 0; opacity: 0.9; font-size: 0.875rem;">Average Rating</p>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);">
                            <i class="fa fa-thumbs-up" style="font-size: 2rem; opacity: 0.9; margin-bottom: 8px;"></i>
                            <h3 style="margin: 0; font-size: 2rem; font-weight: 700;" id="positiveCount">0</h3>
                            <p style="margin: 4px 0 0 0; opacity: 0.9; font-size: 0.875rem;">Positive (4-5★)</p>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);">
                            <i class="fa fa-exclamation-circle" style="font-size: 2rem; opacity: 0.9; margin-bottom: 8px;"></i>
                            <h3 style="margin: 0; font-size: 2rem; font-weight: 700;" id="needsAttentionCount">0</h3>
                            <p style="margin: 4px 0 0 0; opacity: 0.9; font-size: 0.875rem;">Needs Attention (1-2★)</p>
                        </div>
                    </div>
                    
                    <div class="feedback-list-container">
                        <div class="loading">
                            <div class="loading-spinner"></div>
                            <p class="loading-text">Loading Feedback</p>
                            <p class="loading-subtext">Please wait while we fetch customer feedback...</p>
                        </div>
                    </div>
                </div>
            `;
            
            // Update active state on sidebar
            updateActiveNav('showFeedback()');
            
            // Load feedback
            loadFeedback();
            
            // Setup search and filters
            setTimeout(() => {
                const searchInput = document.getElementById('feedbackSearch');
                const ratingFilter = document.getElementById('ratingFilter');
                const categoryFilter = document.getElementById('categoryFilter');
                
                if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        loadFeedback(e.target.value);
                    });
                }
                
                if (ratingFilter) {
                    ratingFilter.addEventListener('change', () => {
                        loadFeedback();
                    });
                }
                
                if (categoryFilter) {
                    categoryFilter.addEventListener('change', () => {
                        loadFeedback();
                    });
                }
            }, 100);
        }

        function loadFeedback(searchTerm = '') {
            const container = document.querySelector('.feedback-list-container');
            if (!container) return;
            
            container.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p class="loading-text">Loading Feedback</p>
                    <p class="loading-subtext">Please wait while we fetch customer feedback...</p>
                </div>
            `;
            
            fetch(`/WRSOMS/api/admin/feedback.php?search=${encodeURIComponent(searchTerm)}`, {
                credentials: 'same-origin'
            })
            .then(r => r.json())
            .then(response => {
                if (!response.success) {
                    throw new Error(response.message || 'Failed to load feedback');
                }
                
                renderFeedback(response.feedback);
            })
            .catch(error => {
                console.error('Error loading feedback:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #ef4444;">
                        <i class="fa fa-exclamation-triangle" style="font-size: 48px;"></i>
                        <p style="margin-top: 16px;">Error loading feedback: ${error.message}</p>
                        <button onclick="loadFeedback()" class="btn btn-primary" style="margin-top: 16px;">Try Again</button>
                    </div>
                `;
            });
        }

        function renderFeedback(feedbackList) {
            const container = document.querySelector('.feedback-list-container');
            if (!container) return;
            
            // Apply filters
            const ratingFilter = document.getElementById('ratingFilter');
            const categoryFilter = document.getElementById('categoryFilter');
            
            let filteredList = feedbackList || [];
            
            if (ratingFilter && ratingFilter.value) {
                filteredList = filteredList.filter(fb => fb.rating == ratingFilter.value);
            }
            
            if (categoryFilter && categoryFilter.value) {
                filteredList = filteredList.filter(fb => fb.category === categoryFilter.value);
            }
            
            // Calculate stats
            const totalCount = feedbackList.length;
            const avgRating = totalCount > 0 
                ? (feedbackList.reduce((sum, fb) => sum + fb.rating, 0) / totalCount).toFixed(1)
                : '0.0';
            const positiveCount = feedbackList.filter(fb => fb.rating >= 4).length;
            const needsAttentionCount = feedbackList.filter(fb => fb.rating <= 2).length;
            
            // Update stats
            document.getElementById('totalFeedbackCount').textContent = totalCount;
            document.getElementById('avgRating').textContent = avgRating;
            document.getElementById('positiveCount').textContent = positiveCount;
            document.getElementById('needsAttentionCount').textContent = needsAttentionCount;
            
            if (!filteredList || filteredList.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="fa fa-users"></i>
                        </div>
                        <h2 class="empty-state-title">${feedbackList.length > 0 ? 'No Results Found' : 'No Feedback Yet'}</h2>
                        ${feedbackList.length > 0 ? '<p class="empty-state-description">Try adjusting your filters</p>' : ''}
                    </div>
                `;
                return;
            }
            
            const html = filteredList.map(fb => {
                const ratingWidth = (fb.rating / 5) * 100;
                return `
                <div class="feedback-card" data-id="${fb.feedback_id}" style="--rating-width: ${ratingWidth}%">
                    <div class="feedback-rating-bar"></div>
                    <div class="feedback-content">
                        <div class="feedback-header">
                            <div class="customer-info">
                                <div class="customer-avatar">
                                    <i class="fa fa-user-circle"></i>
                                </div>
                                <div class="customer-details">
                                    <h3 class="customer-name">${escapeHtml(fb.customer_name || 'Unknown Customer')}</h3>
                                    ${fb.username ? `<p class="customer-username">${escapeHtml(fb.username)}</p>` : ''}
                                    <p class="customer-contact">${escapeHtml(fb.email || '')}${fb.customer_contact ? ' • ' + escapeHtml(fb.customer_contact) : ''}</p>
                                </div>
                            </div>
                            <div class="feedback-meta">
                                <div class="rating">
                                    ${renderStars(fb.rating)}
                                    <span class="rating-number">${fb.rating}/5</span>
                                </div>
                                <p class="feedback-date">
                                    <i class="fa fa-clock-o"></i>
                                    ${formatDateTime(fb.feedback_date)}
                                </p>
                            </div>
                        </div>
                        <div class="feedback-body">
                            ${fb.category ? `
                                <div class="feedback-category">
                                    <span class="category-badge">${escapeHtml(fb.category)}</span>
                                </div>
                            ` : ''}
                            ${fb.subject ? `
                                <h4 class="feedback-subject">${escapeHtml(fb.subject)}</h4>
                            ` : ''}
                            <p class="feedback-message">${escapeHtml(fb.message).replace(/\n/g, '<br>')}</p>
                            ${fb.reference_id ? `
                                <div class="feedback-reference">
                                    <i class="fa fa-tag"></i>
                                    Order Reference: <strong>${escapeHtml(fb.reference_id)}</strong>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            }).join('');
            
            container.innerHTML = html;
        }

        function renderStars(rating) {
            const fullStars = Math.floor(rating);
            const hasHalf = rating % 1 >= 0.5;
            let stars = '';
            
            for (let i = 0; i < 5; i++) {
                if (i < fullStars) {
                    stars += '<i class="fa fa-star"></i>';
                } else if (i === fullStars && hasHalf) {
                    stars += '<i class="fa fa-star-half-o"></i>';
                } else {
                    stars += '<i class="fa fa-star-o"></i>';
                }
            }
            
            return stars;
        }

        // ===== BUSINESS HOURS MANAGEMENT =====
        function showBusinessHours() {
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `
                <div class="dashboard-inner">
                    <header class="header">
                        <h1 class="title">Business Hours</h1>
                        <div class="date-time" aria-live="polite">Date: ${new Date().toLocaleDateString()} | Time: ${new Date().toLocaleTimeString()}</div>
                    </header>
                    
                    <!-- Tabs -->
                    <div style="display: flex; gap: 12px; margin-bottom: 24px; border-bottom: 2px solid #e5e7eb;">
                        <button class="hours-tab active" onclick="switchHoursTab('schedule')" style="padding: 12px 24px; border: none; background: none; font-size: 1rem; font-weight: 600; color: #64748b; cursor: pointer; position: relative; transition: all 0.3s ease;">
                            <i class="fa fa-calendar" style="margin-right: 8px;"></i>
                            Weekly Schedule
                        </button>
                        <button class="hours-tab" onclick="switchHoursTab('cutoff')" style="padding: 12px 24px; border: none; background: none; font-size: 1rem; font-weight: 600; color: #64748b; cursor: pointer; position: relative; transition: all 0.3s ease;">
                            <i class="fa fa-clock-o" style="margin-right: 8px;"></i>
                            Order Cutoff Time
                        </button>
                    </div>
                    
                    <div id="scheduleTab" style="background: white; border-radius: 20px; padding: 32px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); max-width: 900px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;">
                            <div>
                                <h2 style="font-size: 1.5rem; font-weight: 700; color: #0f172a; margin: 0 0 8px 0;">
                                    <i class="fa fa-calendar" style="color: #3b82f6; margin-right: 12px;"></i>
                                    Weekly Schedule
                                </h2>
                                <p style="color: #64748b; margin: 0; font-size: 0.9375rem;">Manage your business operating hours for each day</p>
                            </div>
                            <button id="saveBusinessHours" class="btn btn-primary" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border: none; padding: 12px 28px; border-radius: 12px; font-weight: 600; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); display: flex; align-items: center; gap: 8px;">
                                <i class="fa fa-save"></i>
                                Save Changes
                            </button>
                        </div>
                        
                        <div class="loading" style="text-align: center; padding: 60px 20px;">
                            <div class="loading-spinner"></div>
                            <p class="loading-text">Loading Business Hours</p>
                        </div>
                    </div>
                    
                    <div id="cutoffTab" style="display: none; background: white; border-radius: 20px; padding: 32px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); max-width: 900px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;">
                            <div>
                                <h2 style="font-size: 1.5rem; font-weight: 700; color: #0f172a; margin: 0 0 8px 0;">
                                    <i class="fa fa-clock-o" style="color: #ef4444; margin-right: 12px;"></i>
                                    Daily Order Cutoff Time
                                </h2>
                                <p style="color: #64748b; margin: 0; font-size: 0.9375rem;">Set the deadline for accepting orders each day</p>
                            </div>
                            <button id="saveCutoffTime" class="btn btn-primary" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border: none; padding: 12px 28px; border-radius: 12px; font-weight: 600; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3); display: flex; align-items: center; gap: 8px;">
                                <i class="fa fa-save"></i>
                                Save Cutoff Time
                            </button>
                        </div>
                        
                        <div class="loading" style="text-align: center; padding: 60px 20px;">
                            <div class="loading-spinner"></div>
                            <p class="loading-text">Loading Cutoff Time</p>
                        </div>
                    </div>
                </div>
            `;
            
            updateActiveNav('showBusinessHours()');
            loadBusinessHours();
            loadCutoffTime();
        }

        function switchHoursTab(tab) {
            const scheduleTab = document.getElementById('scheduleTab');
            const cutoffTab = document.getElementById('cutoffTab');
            const tabs = document.querySelectorAll('.hours-tab');
            
            tabs.forEach(t => {
                t.classList.remove('active');
                t.style.color = '#64748b';
                t.style.borderBottom = 'none';
            });
            
            if (tab === 'schedule') {
                scheduleTab.style.display = 'block';
                cutoffTab.style.display = 'none';
                tabs[0].classList.add('active');
                tabs[0].style.color = '#3b82f6';
                tabs[0].style.borderBottom = '3px solid #3b82f6';
                vehicleBtn.classList.remove('active');
                vehicleBtn.style.color = '#64748b';
                vehicleBtn.style.borderBottom = '3px solid transparent';
            } else {
                scheduleTab.style.display = 'none';
                cutoffTab.style.display = 'block';
                tabs[1].classList.add('active');
                tabs[1].style.color = '#ef4444';
                tabs[1].style.borderBottom = '3px solid #ef4444';
                productBtn.classList.remove('active');
                productBtn.style.color = '#64748b';
                productBtn.style.borderBottom = '3px solid transparent';
            }
        }

        function loadBusinessHours() {
            console.log('Loading business hours...');
            fetch('/WRSOMS/api/admin/business_hours.php', {
                method: 'GET',
                credentials: 'same-origin'
            })
            .then(r => {
                console.log('Business hours response status:', r.status);
                return r.json();
            })
            .then(response => {
                console.log('Business hours response:', response);
                if (!response.success) {
                    throw new Error(response.message || 'Failed to load business hours');
                }
                renderBusinessHours(response.hours);
            })
            .catch(error => {
                console.error('Error loading business hours:', error);
                const scheduleTab = document.getElementById('scheduleTab');
                if (scheduleTab) {
                    scheduleTab.innerHTML = `
                        <div style="text-align: center; padding: 60px 20px; color: #ef4444;">
                            <i class="fa fa-exclamation-triangle" style="font-size: 48px; color: #ef4444;"></i>
                            <p style="margin-top: 16px; font-size: 1.125rem; font-weight: 600;">Error loading business hours</p>
                            <p style="margin-top: 8px; color: #64748b;">${error.message}</p>
                            <button onclick="loadBusinessHours()" class="btn btn-primary" style="margin-top: 20px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border: none; padding: 12px 24px; border-radius: 12px; font-weight: 600;">
                                <i class="fa fa-refresh" style="margin-right: 8px;"></i>
                                Try Again
                            </button>
                        </div>
                    `;
                }
            });
        }

        function renderBusinessHours(hours) {
            console.log('Rendering business hours:', hours);
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            const dayIcons = {
                'Monday': 'fa-calendar',
                'Tuesday': 'fa-calendar',
                'Wednesday': 'fa-calendar',
                'Thursday': 'fa-calendar',
                'Friday': 'fa-calendar',
                'Saturday': 'fa-calendar-o',
                'Sunday': 'fa-calendar-o'
            };
            
            const html = days.map((day, index) => {
                const dayData = hours.find(h => h.day_of_week === day) || {
                    day_of_week: day,
                    is_open: true,
                    open_time: '08:00',
                    close_time: '17:00'
                };
                
                const isWeekend = day === 'Saturday' || day === 'Sunday';
                
                return `
                    <div class="business-hours-row" data-day="${day}" style="display: flex; flex-direction: column; gap: 16px; padding: 24px; border-radius: 16px; background: white; margin-bottom: 16px; border: 2px solid #e5e7eb; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);">
                        <!-- Day Header -->
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="width: 48px; height: 48px; border-radius: 12px; background: ${isWeekend ? 'linear-gradient(135deg, #fef3c7, #fde68a)' : 'linear-gradient(135deg, #dbeafe, #bfdbfe)'}; display: flex; align-items: center; justify-content: center;">
                                    <i class="fa ${dayIcons[day]}" style="font-size: 1.5rem; color: ${isWeekend ? '#f59e0b' : '#3b82f6'};"></i>
                                </div>
                                <div>
                                    <h3 style="font-size: 1.25rem; font-weight: 700; color: #0f172a; margin: 0;">${day}</h3>
                                    <p style="font-size: 0.875rem; color: #64748b; margin: 4px 0 0 0;" class="day-status-text">${dayData.is_open ? 'Open for business' : 'Closed'}</p>
                                </div>
                            </div>
                            <label class="toggle-switch" style="position: relative; display: inline-block; width: 60px; height: 32px; cursor: pointer;">
                                <input type="checkbox" class="day-status" ${dayData.is_open ? 'checked' : ''} style="opacity: 0; width: 0; height: 0;">
                                <span class="toggle-slider" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; border-radius: 32px; transition: 0.4s;"></span>
                            </label>
                        </div>
                        
                        <!-- Time Inputs -->
                        <div class="time-inputs" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; padding: 16px; background: #f8fafc; border-radius: 12px; border: 2px solid #fee2e2; ${!dayData.is_open ? 'opacity: 0.5;' : ''}">
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                <label style="font-size: 0.8125rem; font-weight: 600; color: #475569; text-transform: uppercase; letter-spacing: 0.5px; display: flex; align-items: center; gap: 6px;">
                                    <i class="fa fa-sun-o" style="color: #f59e0b;"></i>
                                    Opening Time
                                </label>
                                <input type="time" class="open-time" value="${dayData.open_time}" ${!dayData.is_open ? 'disabled' : ''} style="padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 1rem; font-weight: 600; color: #0f172a; background: white; transition: all 0.3s ease;">
                            </div>
                            
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                <label style="font-size: 0.8125rem; font-weight: 600; color: #475569; text-transform: uppercase; letter-spacing: 0.5px; display: flex; align-items: center; gap: 6px;">
                                    <i class="fa fa-moon-o" style="color: #6366f1;"></i>
                                    Closing Time
                                </label>
                                <input type="time" class="close-time" value="${dayData.close_time}" ${!dayData.is_open ? 'disabled' : ''} style="padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 1rem; font-weight: 600; color: #0f172a; background: white; transition: all 0.3s ease;">
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            const scheduleTab = document.getElementById('scheduleTab');
            if (scheduleTab) {
                const loadingDiv = scheduleTab.querySelector('.loading');
                if (loadingDiv) {
                    loadingDiv.outerHTML = `
                        <div class="business-hours-list" style="display: flex; flex-direction: column;">
                            ${html}
                        </div>
                    `;
                    
                    // Setup toggle listeners
                    document.querySelectorAll('.day-status').forEach(checkbox => {
                        checkbox.addEventListener('change', function() {
                            const row = this.closest('.business-hours-row');
                            const openInput = row.querySelector('.open-time');
                            const closeInput = row.querySelector('.close-time');
                            const statusText = row.querySelector('.day-status-text');
                            const timeInputsContainer = row.querySelector('.time-inputs');
                            const isOpen = this.checked;
                            
                            openInput.disabled = !isOpen;
                            closeInput.disabled = !isOpen;
                            
                            statusText.textContent = isOpen ? 'Open for business' : 'Closed';
                            timeInputsContainer.style.opacity = isOpen ? '1' : '0.5';
                        });
                    });
                    
                    // Setup save button
                    document.getElementById('saveBusinessHours').addEventListener('click', saveBusinessHours);
                }
            }
        }

        function saveBusinessHours() {
            const rows = document.querySelectorAll('.business-hours-row');
            const hours = Array.from(rows).map(row => {
                const day = row.dataset.day;
                const isOpen = row.querySelector('.day-status').checked;
                const openTime = row.querySelector('.open-time').value;
                const closeTime = row.querySelector('.close-time').value;
                
                return {
                    day_of_week: day,
                    is_open: isOpen,
                    open_time: openTime,
                    close_time: closeTime
                };
            });
            
            const saveBtn = document.getElementById('saveBusinessHours');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Saving...';
            
            fetch('/WRSOMS/api/admin/business_hours.php', {
                method: 'POST',
                credentials: 'same-origin',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ hours })
            })
            .then(r => r.json())
            .then(response => {
                if (response.success) {
                    saveBtn.innerHTML = '<i class="fa fa-check"></i> Saved!';
                    saveBtn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                    
                    setTimeout(() => {
                        saveBtn.disabled = false;
                        saveBtn.innerHTML = '<i class="fa fa-save"></i> Save Changes';
                        saveBtn.style.background = 'linear-gradient(135deg, #3b82f6, #2563eb)';
                    }, 2000);
                } else {
                    throw new Error(response.message || 'Failed to save business hours');
                }
            })
            .catch(error => {
                console.error('Error saving business hours:', error);
                alert('Error: ' + error.message);
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fa fa-save"></i> Save Changes';
            });
        }

        function loadCutoffTime() {
            fetch('/WRSOMS/api/admin/cutoff_time.php', {
                method: 'GET',
                credentials: 'same-origin'
            })
            .then(r => r.json())
            .then(response => {
                if (!response.success) {
                    throw new Error(response.message || 'Failed to load cutoff time');
                }
                renderCutoffTime(response.cutoff_time);
            })
            .catch(error => {
                console.error('Error loading cutoff time:', error);
                const container = document.querySelector('#cutoffTab');
                if (container) {
                    const loadingDiv = container.querySelector('.loading');
                    if (loadingDiv) {
                        loadingDiv.outerHTML = `
                            <div style="text-align: center; padding: 60px 20px; color: #ef4444;">
                                <i class="fa fa-exclamation-triangle" style="font-size: 48px;"></i>
                                <p style="margin-top: 16px; font-size: 1.125rem; font-weight: 600;">Error loading cutoff time</p>
                                <p style="margin-top: 8px; color: #64748b;">${error.message}</p>
                                <button onclick="loadCutoffTime()" class="btn btn-primary" style="margin-top: 20px;">Try Again</button>
                            </div>
                        `;
                    }
                }
            });
        }

        function renderCutoffTime(cutoffData) {
            const container = document.querySelector('#cutoffTab');
            if (!container) return;
            
            const loadingDiv = container.querySelector('.loading');
            if (!loadingDiv) return;
            
            const cutoffTime = cutoffData?.cutoff_time || '16:00';
            const isEnabled = cutoffData?.is_enabled !== undefined ? cutoffData.is_enabled : true;
            
            loadingDiv.outerHTML = `
                <div style="max-width: 600px;">
                    <!-- Cutoff Time Card -->
                    <div style="background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%); border-radius: 20px; padding: 32px; border: 3px solid #fecaca; margin-bottom: 24px;">
                        <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 24px;">
                            <div style="width: 64px; height: 64px; border-radius: 50%; background: linear-gradient(135deg, #ef4444, #dc2626); display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 20px rgba(239, 68, 68, 0.4);">
                                <i class="fa fa-bell" style="font-size: 2rem; color: white;"></i>
                            </div>
                            <div style="flex: 1;">
                                <h3 style="font-size: 1.375rem; font-weight: 700; color: #0f172a; margin: 0;">Order Cutoff Time</h3>
                                <p style="font-size: 0.9375rem; color: #64748b; margin: 0;">Set the deadline for accepting orders each day</p>
                            </div>
                        </div>
                        
                        <!-- Enable/Disable Toggle -->
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px; background: white; border-radius: 16px; margin-bottom: 20px; border: 2px solid #fee2e2;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <i class="fa fa-power-off" style="font-size: 1.5rem; color: #ef4444;"></i>
                                <div>
                                    <h4 style="font-size: 1.0625rem; font-weight: 700; color: #0f172a; margin: 0;">Enable Cutoff Time</h4>
                                    <p style="font-size: 0.875rem; color: #64748b; margin: 4px 0 0 0;" id="cutoffStatusText">${isEnabled ? 'Cutoff time is active' : 'Cutoff time is disabled'}</p>
                                </div>
                            </div>
                            <label class="toggle-switch" style="position: relative; display: inline-block; width: 60px; height: 32px; cursor: pointer;">
                                <input type="checkbox" id="cutoffEnabled" ${isEnabled ? 'checked' : ''} style="opacity: 0; width: 0; height: 0;">
                                <span class="toggle-slider" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; border-radius: 32px; transition: 0.4s;"></span>
                            </label>
                        </div>
                        
                        <!-- Time Picker -->
                        <div style="padding: 24px; background: white; border-radius: 16px; border: 2px solid #fee2e2;">
                            <label style="display: block; font-size: 0.875rem; font-weight: 700; color: #475569; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                <i class="fa fa-clock-o" style="color: #ef4444;"></i>
                                Daily Cutoff Time
                            </label>
                            <input type="time" id="cutoffTimeInput" value="${cutoffTime}" ${!isEnabled ? 'disabled' : ''} style="width: 100%; padding: 16px 20px; border: 3px solid #e5e7eb; border-radius: 12px; font-size: 1.5rem; font-weight: 700; color: #0f172a; background: white; transition: all 0.3s ease; text-align: center;">
                            <p style="font-size: 0.875rem; color: #64748b; margin: 12px 0 0 0; text-align: center;">
                                <i class="fa fa-info-circle" style="margin-right: 4px;"></i>
                                Orders placed after this time will not be accepted for today
                            </p>
                        </div>
                    </div>
                </div>
            `;
            
            // Setup toggle listener
            document.getElementById('cutoffEnabled').addEventListener('change', function() {
                const input = document.getElementById('cutoffTimeInput');
                const statusText = document.getElementById('cutoffStatusText');
                const isEnabled = this.checked;
                
                input.disabled = !isEnabled;
                statusText.textContent = isEnabled ? 'Cutoff time is active' : 'Cutoff time is disabled';
            });
            
            // Setup save button
            document.getElementById('saveCutoffTime').addEventListener('click', saveCutoffTime);
        }

        function saveCutoffTime() {
            const isEnabled = document.getElementById('cutoffEnabled').checked;
            const cutoffTime = document.getElementById('cutoffTimeInput').value;
            
            if (!cutoffTime) {
                alert('Please select a cutoff time');
                return;
            }
            
            const saveBtn = document.getElementById('saveCutoffTime');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Saving...';
            
            fetch('/WRSOMS/api/admin/cutoff_time.php', {
                method: 'POST',
                credentials: 'same-origin',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    is_enabled: isEnabled,
                    cutoff_time: cutoffTime
                })
            })
            .then(r => r.json())
            .then(response => {
                if (response.success) {
                    saveBtn.innerHTML = '<i class="fa fa-check"></i> Saved!';
                    saveBtn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                    
                    setTimeout(() => {
                        saveBtn.disabled = false;
                        saveBtn.innerHTML = '<i class="fa fa-save"></i> Save Cutoff Time';
                        saveBtn.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                    }, 2000);
                } else {
                    throw new Error(response.message || 'Failed to save cutoff time');
                }
            })
            .catch(error => {
                console.error('Error saving cutoff time:', error);
                alert('Error: ' + error.message);
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fa fa-save"></i> Save Cutoff Time';
            });
        }

        // ===== USER MANAGEMENT =====
        function showUserManagement() {
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `
                <div class="dashboard-inner">
                    <header class="header">
                        <h1 class="title">User Management</h1>
                        <div class="date-time" aria-live="polite">Date: ${new Date().toLocaleDateString()} | Time: ${new Date().toLocaleTimeString()}</div>
                    </header>
                    
                    <section class="quick-actions" aria-label="Quick actions">
                        <button type="button" onclick="loadUsers()" aria-label="Refresh user data">
                            <i class="fa fa-refresh"></i> Refresh Data
                        </button>
                    </section>
                    
                    <section class="metric-card" role="region" aria-label="User List">
                        <h3>Registered Users</h3>
                        <div style="overflow-x: auto;">
                            <table class="batch-table" aria-describedby="user-table-desc">
                                <caption id="user-table-desc" class="sr-only">List of registered users</caption>
                                <thead>
                                    <tr>
                                        <th scope="col">User ID</th>
                                        <th scope="col">Username</th>
                                        <th scope="col">Email</th>
                                        <th scope="col">Role</th>
                                        <th scope="col">Registration Date</th>
                                        <th scope="col">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="userTableBody">
                                    <tr><td colspan="6" style="text-align: center;">Loading users...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </section>
                </div>
            `;
            
            updateActiveNav('showUserManagement()');
            loadUsers();
        }

        function loadUsers() {
            const tbody = document.getElementById('userTableBody');
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;"><i class="fa fa-spinner fa-spin"></i> Loading...</td></tr>';
            }
            
            fetch('/WRSOMS/api/admin/users.php', { credentials: 'same-origin' })
                .then(r => {
                    if (!r.ok) {
                        throw new Error(`HTTP ${r.status}: ${r.statusText}`);
                    }
                    return r.text();
                })
                .then(text => {
                    try {
                        return JSON.parse(text);
                    } catch (e) {
                        console.error('Invalid JSON response:', text);
                        throw new Error('Server returned invalid JSON. The API endpoint may not exist or has an error.');
                    }
                })
                .then(response => {
                    if (!response.success) {
                        throw new Error(response.message || 'Failed to load users');
                    }
                    renderUsers(response.users || []);
                })
                .catch(error => {
                    console.error('Error loading users:', error);
                    const tbody = document.getElementById('userTableBody');
                    if (tbody) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="6" style="padding: 40px; text-align: center;">
                                    <div style="color: #ef4444;">
                                        <i class="fa fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 16px;"></i>
                                        <p style="font-weight: 600; margin-bottom: 8px;">Error loading users</p>
                                        <p style="font-size: 0.875rem; color: #64748b;">${error.message}</p>
                                        <button onclick="loadUsers()" class="btn btn-sm btn-primary" style="margin-top: 16px;">
                                            <i class="fa fa-refresh"></i> Try Again
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }
                });
        }

        function renderUsers(users) {
            const tbody = document.getElementById('userTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (users.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="padding: 0;">
                            <div class="empty-state">
                                <div class="empty-state-icon">
                                    <i class="fa fa-users"></i>
                                </div>
                                <h2 class="empty-state-title">No Users Found</h2>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            users.forEach(user => {
                const tr = document.createElement('tr');
                const roleBadge = user.is_admin ? 
                    '<span class="badge bg-danger">Admin</span>' : 
                    '<span class="badge bg-primary">Customer</span>';
                const statusBadge = user.is_active ? 
                    '<span class="badge bg-success">Active</span>' : 
                    '<span class="badge bg-secondary">Inactive</span>';
                
                tr.innerHTML = `
                    <td>${escapeHtml(user.user_id)}</td>
                    <td><strong>${escapeHtml(user.username)}</strong></td>
                    <td>${escapeHtml(user.email || 'N/A')}</td>
                    <td>${roleBadge}</td>
                    <td>${formatDateTime(user.created_at)}</td>
                    <td>${statusBadge}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ===== CASH PAYMENTS =====
        function showCashPayments() {
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `
                <div class="dashboard-inner">
                    <header class="header">
                        <h1 class="title">Cash Payments</h1>
                        <div class="date-time" aria-live="polite">Date: ${new Date().toLocaleDateString()} | Time: ${new Date().toLocaleTimeString()}</div>
                    </header>
                    
                    <section class="quick-actions" aria-label="Quick actions">
                        <button type="button" onclick="loadCashPayments()" aria-label="Refresh payment data">
                            <i class="fa fa-refresh"></i> Refresh Data
                        </button>
                    </section>
                    
                    <!-- Payment Stats -->
                    <section class="metrics" aria-label="Payment Statistics">
                        <div class="metric-card" data-color="green">
                            <div class="metric-card-inner">
                                <span class="metric-icon"><i class="fa fa-check-circle"></i></span>
                                <div class="metric-text">
                                    <h3>Verified</h3>
                                    <p id="verifiedCount">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="metric-card" data-color="blue">
                            <div class="metric-card-inner">
                                <span class="metric-icon"><i class="fa fa-clock-o"></i></span>
                                <div class="metric-text">
                                    <h3>Pending</h3>
                                    <p id="pendingCount">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="metric-card" data-color="teal">
                            <div class="metric-card-inner">
                                <span class="metric-icon"><i class="fa fa-money"></i></span>
                                <div class="metric-text">
                                    <h3>Total Amount</h3>
                                    <p id="totalAmount">₱0.00</p>
                                </div>
                            </div>
                        </div>
                    </section>
                    
                    <section class="metric-card" role="region" aria-label="Cash Payment Records">
                        <h3>Cash Payment Records</h3>
                        <div style="overflow-x: auto;">
                            <table class="batch-table" aria-describedby="payment-table-desc">
                                <caption id="payment-table-desc" class="sr-only">List of cash payment records</caption>
                                <thead>
                                    <tr>
                                        <th scope="col">Payment ID</th>
                                        <th scope="col">Order ID</th>
                                        <th scope="col">Customer</th>
                                        <th scope="col">Amount</th>
                                        <th scope="col">Payment Date</th>
                                        <th scope="col">Status</th>
                                        <th scope="col">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="paymentTableBody">
                                    <tr><td colspan="7" style="text-align: center;">Loading payments...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </section>
                </div>
            `;
            
            updateActiveNav('showCashPayments()');
            loadCashPayments();
        }

        function loadCashPayments() {
            const tbody = document.getElementById('paymentTableBody');
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;"><i class="fa fa-spinner fa-spin"></i> Loading...</td></tr>';
            }
            
            fetch('/WRSOMS/api/admin/cash_payments.php', { credentials: 'same-origin' })
                .then(r => {
                    if (!r.ok) {
                        throw new Error(`HTTP ${r.status}: ${r.statusText}`);
                    }
                    return r.text();
                })
                .then(text => {
                    try {
                        return JSON.parse(text);
                    } catch (e) {
                        console.error('Invalid JSON response:', text);
                        throw new Error('Server returned invalid JSON. The API endpoint may not exist or has an error.');
                    }
                })
                .then(response => {
                    if (!response.success) {
                        throw new Error(response.message || 'Failed to load cash payments');
                    }
                    renderCashPayments(response.payments || []);
                })
                .catch(error => {
                    console.error('Error loading cash payments:', error);
                    const tbody = document.getElementById('paymentTableBody');
                    if (tbody) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="7" style="padding: 40px; text-align: center;">
                                    <div style="color: #ef4444;">
                                        <i class="fa fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 16px;"></i>
                                        <p style="font-weight: 600; margin-bottom: 8px;">Error loading payments</p>
                                        <p style="font-size: 0.875rem; color: #64748b;">${error.message}</p>
                                        <button onclick="loadCashPayments()" class="btn btn-sm btn-primary" style="margin-top: 16px;">
                                            <i class="fa fa-refresh"></i> Try Again
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }
                });
        }

        function renderCashPayments(payments) {
            const tbody = document.getElementById('paymentTableBody');
            if (!tbody) return;
            
            // Calculate stats - use correct status names from database
            const verified = payments.filter(p => p.payment_status === 'Paid').length;
            const pending = payments.filter(p => p.payment_status === 'Pending').length;
            const total = payments.reduce((sum, p) => sum + parseFloat(p.amount || 0), 0);
            
            // Update stats
            const verifiedEl = document.getElementById('verifiedCount');
            const pendingEl = document.getElementById('pendingCount');
            const totalEl = document.getElementById('totalAmount');
            
            if (verifiedEl) verifiedEl.textContent = verified;
            if (pendingEl) pendingEl.textContent = pending;
            if (totalEl) totalEl.textContent = money(total);
            
            tbody.innerHTML = '';
            
            if (payments.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="padding: 0;">
                            <div class="empty-state">
                                <div class="empty-state-icon">
                                    <i class="fa fa-money"></i>
                                </div>
                                <h2 class="empty-state-title">No Cash Payments</h2>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            payments.forEach(payment => {
                const tr = document.createElement('tr');
                const statusBadge = payment.payment_status === 'Paid' ? 
                    '<span class="badge bg-success">Verified</span>' : 
                    '<span class="badge bg-warning">Pending</span>';
                
                const actionBtn = payment.payment_status === 'Pending' ? 
                    `<button class="btn btn-sm btn-success" onclick="verifyPayment(${payment.payment_id})">
                        <i class="fa fa-check"></i> Verify
                    </button>` : 
                    '<span style="color: #10b981;"><i class="fa fa-check-circle"></i> Verified</span>';
                
                tr.innerHTML = `
                    <td>${escapeHtml(payment.payment_id)}</td>
                    <td><strong>${escapeHtml(payment.reference_id || 'N/A')}</strong></td>
                    <td>${escapeHtml(payment.customer_name || 'N/A')}</td>
                    <td>${money(payment.amount)}</td>
                    <td>${formatDateTime(payment.payment_date)}</td>
                    <td>${statusBadge}</td>
                    <td>${actionBtn}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function verifyPayment(paymentId) {
            if (!confirm('Mark this cash payment as verified?')) return;
            
            fetch('/WRSOMS/api/admin/cash_payments.php', {
                method: 'POST',
                credentials: 'same-origin',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    action: 'verify',
                    payment_id: paymentId 
                })
            })
            .then(r => r.json())
            .then(response => {
                if (response.success) {
                    showAdminToast('Payment verified successfully', 'success');
                    loadCashPayments();
                } else {
                    throw new Error(response.message || 'Failed to verify payment');
                }
            })
            .catch(error => {
                showAdminToast('Error: ' + error.message, 'error');
            });
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                fetch('/WRSOMS/api/auth/logout.php', { 
                    method: 'POST',
                    credentials: 'same-origin' 
                })
                .then(r => r.json())
                .then(res => {
                    // Redirect to login page regardless of response
                    window.location.href = '/WRSOMS/pages/login.html';
                })
                .catch(err => {
                    console.error('Logout error:', err);
                    // Still redirect even if there's an error
                    window.location.href = '/WRSOMS/pages/login.html';
                });
            }
        }

        const bootstrapScript = document.createElement('script');
        bootstrapScript.src = 'https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js';
        document.body.appendChild(bootstrapScript);
    
    // Helper functions (global scope)
    function money(v) {
        return '₱' + Number(v).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function escapeHtml(s) {
        if (s === null || s === undefined) return '';
        return String(s)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
    }

    function formatDateTime(dateStr) {
        if (!dateStr) return 'N/A';
        const d = new Date(dateStr);
        return d.toLocaleString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    function getStatusClass(status) {
        if (!status) return 'bg-secondary';
        const s = status.toLowerCase();
        if (s.includes('pending')) return 'bg-warning';
        if (s.includes('delivered') || s.includes('completed')) return 'bg-success';
        if (s.includes('dispatched')) return 'bg-info';
        if (s.includes('failed') || s.includes('cancelled')) return 'bg-danger';
        return 'bg-secondary';
    }

    function getBatchStatusClass(status) {
        if (!status) return 'bg-secondary';
        const s = status.toLowerCase();
        if (s.includes('pending')) return 'bg-warning';
        if (s.includes('dispatched')) return 'bg-info';
        if (s.includes('completed')) return 'bg-success';
        if (s.includes('failed')) return 'bg-danger';
        return 'bg-secondary';
    }

    // Fetch dashboard data from API and populate UI
    function loadDashboard() {
        const apiUrl = '/WRSOMS/api/admin/dashboard.php';

        fetch(apiUrl, { credentials: 'same-origin' })
            .then(r => r.json())
            .then(res => {
                if (!res.success) throw new Error(res.message || 'Failed to load');
                const data = res.data || {};
                const stats = data.stats || {};
                
                // Debug logging
                console.log('Dashboard data received:', {
                    stats: stats,
                    batch_details: data.batch_details,
                    recent_orders: data.recent_orders
                });

                // Update stats with safety checks
                const totalOrdersEl = document.getElementById('totalOrdersVal');
                const pendingOrdersEl = document.getElementById('pendingOrdersVal');
                const completedOrdersEl = document.getElementById('completedOrdersVal');
                const totalRevenueEl = document.getElementById('totalRevenueVal');
                const avgOrderEl = document.getElementById('avgOrderVal');
                const pendingDeliveriesEl = document.getElementById('pendingDeliveriesVal');
                
                if (totalOrdersEl) totalOrdersEl.textContent = stats.total_orders ?? '0';
                if (pendingOrdersEl) pendingOrdersEl.textContent = stats.pending_orders ?? '0';
                if (completedOrdersEl) completedOrdersEl.textContent = stats.completed_orders ?? '0';
                if (totalRevenueEl) totalRevenueEl.textContent = money(stats.total_revenue ?? 0);
                if (avgOrderEl) avgOrderEl.textContent = money(stats.avg_order_value ?? 0);
                if (pendingDeliveriesEl) pendingDeliveriesEl.textContent = stats.pending_deliveries ?? '0';

                // Batch details - only show batches with pending orders
                const batchBody = document.getElementById('batchBody');
                if (!batchBody) return; // Safety check: only proceed if element exists
                
                batchBody.innerHTML = '';
                const batchData = data.batch_details || [];
                const unassignedCount = stats.unassigned_orders || 0;
                
                if (batchData.length === 0 && unassignedCount === 0) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = '<td colspan="5" style="text-align: center; color: #999;">No pending batches or orders today</td>';
                    batchBody.appendChild(tr);
                } else {
                    // Show existing batches
                    batchData.forEach(b => {
                        const capacity = b.vehicle_type === 'Tricycle' ? 5 : 10;
                        const containers = parseInt(b.total_containers || 0);
                        const containerDisplay = `${containers}/${capacity}`;
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${escapeHtml(b.vehicle_type)}</td>
                            <td>#${escapeHtml(b.batch_number)}</td>
                            <td>${escapeHtml(b.order_count)}</td>
                            <td>${escapeHtml(containerDisplay)}</td>
                            <td><span class="badge ${getBatchStatusClass(b.batch_status)}">${escapeHtml(b.batch_status || 'N/A')}</span></td>
                        `;
                        batchBody.appendChild(tr);
                    });
                    
                    // Show unassigned orders if any
                    if (unassignedCount > 0) {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td colspan="2"><em>Unassigned Orders</em></td>
                            <td>${unassignedCount}</td>
                            <td>-</td>
                            <td><span class="badge bg-secondary">Not Batched</span></td>
                        `;
                        batchBody.appendChild(tr);
                    }
                }

                // Recent orders (today)
                const recentBody = document.getElementById('recentOrdersBody');
                if (!recentBody) return; // Safety check: only proceed if element exists
                
                recentBody.innerHTML = '';
                const recentOrders = data.recent_orders || [];
                if (recentOrders.length === 0) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td colspan="4" style="padding: 0;">
                            <div class="empty-state" style="padding: 40px 20px;">
                                <div class="empty-state-icon" style="width: 80px; height: 80px; margin: 0 auto 16px;">
                                    <i class="fa fa-inbox"></i>
                                </div>
                                <h2 class="empty-state-title" style="font-size: 1.125rem;">No Orders Today</h2>
                            </div>
                        </td>
                    `;
                    recentBody.appendChild(tr);
                } else {
                    recentOrders.forEach(o => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td><strong>${escapeHtml(o.reference_id)}</strong></td>
                            <td>${formatDateTime(o.order_date)}</td>
                            <td>${money(o.total_amount)}</td>
                            <td><span class="badge ${getStatusClass(o.order_status)}">${escapeHtml(o.order_status || 'N/A')}</span></td>
                        `;
                        recentBody.appendChild(tr);
                    });
                }

                // Cache order history for the separate view
                cachedOrderHistory = data.order_history || [];

                // Update header date/time
                const dt = new Date();
                const dateTime = document.querySelector('.header .date-time');
                if (dateTime) dateTime.textContent = `Date: ${dt.toLocaleDateString()} | Time: ${dt.toLocaleTimeString()}`;
            })
            .catch(err => {
                console.error('Dashboard load error', err);
            });
    }

    // Load dashboard on initial page load
    loadDashboard();
</script>
<!-- Ensure admin_dashboard.js is loaded after all inline scripts and before closing body tag -->
<script src="/WRSOMS/assets/js/admin_dashboard.js"></script>
</body>
</html>
