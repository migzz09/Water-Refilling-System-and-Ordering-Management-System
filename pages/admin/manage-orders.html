<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Manage Orders | Admin Panel</title>
    <!-- This fragment is intended to be embedded inside the admin dashboard. Styles are pulled from the shared admin CSS. -->
    <meta name="robots" content="noindex">
    <style>
        /* Keep minimal inline styles for embedding only - primary styles live in admin.css */
        .search-bar { max-width: 420px; }
        .orders-card { padding: 16px; border-radius: 8px; }
        .orders-empty { padding: 40px 0; }
        
        /* Toast Notification Styles */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-width: 400px;
        }
        
        .toast {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15), 0 2px 8px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #3b82f6;
            animation: slideIn 0.3s ease-out;
            min-width: 320px;
            position: relative;
            overflow: hidden;
        }
        
        .toast::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: linear-gradient(90deg, #3b82f6, #60a5fa);
            animation: progressBar 3s linear;
        }
        
        .toast.success {
            border-left-color: #10b981;
        }
        
        .toast.success::before {
            background: linear-gradient(90deg, #10b981, #34d399);
        }
        
        .toast.error {
            border-left-color: #ef4444;
        }
        
        .toast.error::before {
            background: linear-gradient(90deg, #ef4444, #f87171);
        }
        
        .toast-icon {
            font-size: 24px;
            flex-shrink: 0;
        }
        
        .toast.success .toast-icon {
            color: #10b981;
        }
        
        .toast.error .toast-icon {
            color: #ef4444;
        }
        
        .toast.info .toast-icon {
            color: #3b82f6;
        }
        
        .toast-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .toast-title {
            font-weight: 600;
            font-size: 0.95rem;
            color: #111827;
            line-height: 1.3;
        }
        
        .toast-message {
            font-size: 0.875rem;
            color: #6b7280;
            line-height: 1.4;
        }
        
        .toast-close {
            background: none;
            border: none;
            color: #9ca3af;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        
        .toast-close:hover {
            background: #f3f4f6;
            color: #111827;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
        
        @keyframes progressBar {
            from {
                width: 100%;
            }
            to {
                width: 0%;
            }
        }
        
        .toast.closing {
            animation: slideOut 0.3s ease-in forwards;
        }
        
        /* Modal backdrop - FIXED positioning */
.ww-modal-backdrop {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    background: rgba(0, 0, 0, 0.6) !important;
    backdrop-filter: blur(4px);
    z-index: 99999 !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    padding: 20px;
    box-sizing: border-box;
}

/* Modal content - centered */
.ww-modal {
    position: relative !important;
    background: white !important;
    border-radius: 16px !important;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4) !important;
    max-width: 500px !important;
    width: 90% !important;
    max-height: 85vh !important;
    overflow-y: auto !important;
    margin: 0 auto !important;
}

.ww-modal-header {
    padding: 20px 24px;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.ww-modal-header h2 {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 600;
    color: #111827;
}

.ww-modal-body {
    padding: 24px;
}

.ww-modal-body input,
.ww-modal-body textarea {
    width: 100%;
    padding: 12px;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    font-size: 1rem;
    font-family: inherit;
    margin-bottom: 8px;
}

.ww-modal-body input:focus,
.ww-modal-body textarea:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.ww-modal-footer {
    padding: 16px 24px;
    border-top: 1px solid #e5e7eb;
    display: flex;
    gap: 12px;
    justify-content: flex-end;
}

.close-btn {
    background: #f3f4f6;
    border: none;
    color: #111827;
    padding: 8px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.95rem;
    font-weight: 600;
}

.close-btn:hover {
    background: #e5e7eb;
}

.confirm-modal-btn-confirm {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    color: white;
    border: none;
    padding: 10px 24px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.95rem;
    font-weight: 600;
}

.confirm-modal-btn-confirm:hover {
    background: linear-gradient(135deg, #2563eb, #1d4ed8);
}

.confirm-modal-btn-confirm:disabled {
    background: #d1d5db;
    cursor: not-allowed;
}

/* Confirmation Modal Styles */
.confirm-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(4px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    animation: fadeIn 0.2s ease-out;
    padding: 20px;
    box-sizing: border-box;
}

.confirm-modal {
    background: #ffffff;
    border-radius: 16px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    max-width: 500px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    animation: modalSlideIn 0.3s ease-out;
    position: relative;
    margin: auto;
}

.confirm-modal-header {
    padding: 24px 24px 16px;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    align-items: center;
    gap: 16px;
}

.confirm-modal-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.confirm-modal-icon i {
    color: #ffffff;
    font-size: 24px;
}

.confirm-modal-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: #111827;
    margin: 0;
}

.confirm-modal-body {
    padding: 24px;
    color: #374151;
    font-size: 1rem;
    line-height: 1.6;
}

.confirm-modal-body input,
.confirm-modal-body textarea {
    width: 100%;
    padding: 12px;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    font-size: 1rem;
    font-family: inherit;
    transition: border-color 0.2s, box-shadow 0.2s;
    box-sizing: border-box;
    margin-top: 8px;
}

.confirm-modal-body input:focus,
.confirm-modal-body textarea:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.confirm-modal-body textarea {
    resize: vertical;
    min-height: 100px;
}

.confirm-modal-message {
    margin-bottom: 16px;
    padding: 12px;
    background: #f9fafb;
    border-radius: 8px;
    border-left: 4px solid #3b82f6;
}

.confirm-modal-footer {
    padding: 16px 24px;
    border-top: 1px solid #e5e7eb;
    display: flex;
    gap: 12px;
    justify-content: flex-end;
}

.confirm-modal-btn {
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 600;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 100px;
}

.confirm-modal-btn-cancel {
    background: #f3f4f6;
    color: #374151;
}

.confirm-modal-btn-cancel:hover {
    background: #e5e7eb;
}

.confirm-modal-btn-confirm {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    color: #ffffff;
}

.confirm-modal-btn-confirm:hover {
    background: linear-gradient(135deg, #2563eb, #1d4ed8);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
}

.confirm-modal-btn-confirm:active {
    transform: translateY(0);
}

.confirm-modal-btn-confirm:disabled {
    background: #d1d5db;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

@keyframes fadeIn {
    from {
        opacity: 0;
    }
    to {
        opacity: 1;
    }
}

@keyframes scaleIn {
    from {
        transform: scale(0.9);
        opacity: 0;
    }
    to {
        transform: scale(1);
        opacity: 1;
    }
}

@keyframes modalSlideIn {
    from {
        transform: translateY(-30px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .confirm-modal-overlay {
        padding: 16px;
    }
    
    .confirm-modal {
        max-width: 100%;
        max-height: 85vh;
    }
    
    .confirm-modal-header {
        padding: 20px 16px 12px;
    }
    
    .confirm-modal-body {
        padding: 16px;
    }
    
    .confirm-modal-footer {
        padding: 12px 16px;
        flex-direction: column;
    }
    
    .confirm-modal-btn {
        width: 100%;
    }
}

/* Modal z-index overrides (keeps above all app layers) */
.modal,
.modal-backdrop {
    z-index: 11000;
}

.modal-backdrop.show {
    opacity: .55;
}

/* DELETE THIS ENTIRE BLOCK - IT'S BREAKING THE MODAL */
/* 
.ww-modal,
.confirm-modal-overlay,
.confirm-modal {
    position: static;
    inset: auto;
}
*/

/* Optional: tighten inputs inside modals */
.modal input[type=number],
.modal textarea {
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    padding: 10px;
}

.modal input:focus,
.modal textarea:focus {
    border-color: #2563eb;
    box-shadow: 0 0 0 3px rgba(37,99,235,.15);
    outline: none;
}
        </style>
    </head>
    <body>
        <!-- Container expected by admin-dashboard loader -->
        <div class="container">
            <div class="orders-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <form id="ordersSearchForm" class="search-bar" style="display:flex;gap:8px;">
                        <input id="ordersSearchInput" type="search" placeholder="Search reference, customer, address..." class="form-control" />
                        <button type="submit" class="btn btn-primary">Search</button>
                    </form>
                    <div class="text-end d-flex gap-2 align-items-center">
                        <button id="archiveCompletedBtn" class="btn btn-warning" title="Archive all completed orders">
                            <i class="fa fa-archive"></i> Archive Completed
                        </button>
                        <small class="text-muted">Manage today's batches and orders</small>
                    </div>
                </div>
                <div id="batchesContainer">Loading…</div>
                <div id="unassignedContainer" style="margin-top:12px;"></div>
            </div>
        </div>
        <!-- Toast Container -->
        <div class="toast-container" id="toastContainer"></div>
        
        <script>
        (function(){
            // Toast Notification Function
            function showToast(type, title, message) {
                const container = document.getElementById('toastContainer');
                if (!container) return;
                
                const icons = {
                    success: '<i class="fa fa-check-circle"></i>',
                    error: '<i class="fa fa-exclamation-circle"></i>',
                    info: '<i class="fa fa-info-circle"></i>'
                };
                
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = `
                    <div class="toast-icon">${icons[type] || icons.info}</div>
                    <div class="toast-content">
                        <div class="toast-title">${title}</div>
                        <div class="toast-message">${message}</div>
                    </div>
                    <button class="toast-close">&times;</button>
                `;
                
                container.appendChild(toast);
                
                // Close button handler
                const closeBtn = toast.querySelector('.toast-close');
                closeBtn.addEventListener('click', () => {
                    toast.classList.add('closing');
                    setTimeout(() => toast.remove(), 300);
                });
                
                // Auto remove after 3 seconds
                setTimeout(() => {
                    if (toast.parentElement) {
                        toast.classList.add('closing');
                        setTimeout(() => toast.remove(), 300);
                    }
                }, 3000);
            }
            
            // Make showToast globally accessible
            window.showToast = showToast;
            
            // Custom Confirmation Modal Function
            function showConfirm(title, message) {
                return new Promise((resolve) => {
                    // Inject styles if not already present
                    if (!document.getElementById('confirm-modal-styles')) {
                        const styleEl = document.createElement('style');
                        styleEl.id = 'confirm-modal-styles';
                        styleEl.textContent = `
                            .confirm-modal-overlay {
                                position: fixed !important;
                                top: 0 !important;
                                left: 0 !important;
                                right: 0 !important;
                                bottom: 0 !important;
                                width: 100vw !important;
                                height: 100vh !important;
                                background: rgba(0, 0, 0, 0.6) !important;
                                backdrop-filter: blur(4px);
                                z-index: 10000 !important;
                                display: flex !important;
                                align-items: center !important;
                                justify-content: center !important;
                                animation: fadeIn 0.2s ease-out;
                                padding: 20px;
                                box-sizing: border-box;
                            }
                            .confirm-modal {
                                background: #ffffff !important;
                                border-radius: 16px !important;
                                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3) !important;
                                max-width: 500px !important;
                                width: 100% !important;
                                max-height: 90vh !important;
                                overflow-y: auto !important;
                                animation: modalSlideIn 0.3s ease-out;
                                position: relative !important;
                                margin: auto !important;
                            }
                            .confirm-modal-header {
                                padding: 24px 24px 16px !important;
                                border-bottom: 1px solid #e5e7eb !important;
                                display: flex !important;
                                align-items: center !important;
                                gap: 16px !important;
                            }
                            .confirm-modal-icon {
                                width: 48px !important;
                                height: 48px !important;
                                border-radius: 12px !important;
                                background: linear-gradient(135deg, #3b82f6, #2563eb) !important;
                                display: flex !important;
                                align-items: center !important;
                                justify-content: center !important;
                                flex-shrink: 0 !important;
                            }
                            .confirm-modal-icon i {
                                color: #ffffff;
                                font-size: 24px;
                            }
                            .confirm-modal-title {
                                font-size: 1.5rem !important;
                                font-weight: 600 !important;
                                color: #111827 !important;
                                margin: 0;
                            }
                            .confirm-modal-body {
                                padding: 24px !important;
                                color: #374151;
                                font-size: 1rem !important;
                                line-height: 1.6;
                            }
                            .confirm-modal-body input,
                            .confirm-modal-body textarea {
                                width: 100% !important;
                                padding: 12px !important;
                                border: 2px solid #e5e7eb !important;
                                border-radius: 8px !important;
                                font-size: 1rem !important;
                                font-family: inherit !important;
                                transition: border-color 0.2s, box-shadow 0.2s;
                                box-sizing: border-box;
                                margin-top: 8px !important;
                            }
                            .confirm-modal-body input:focus,
                            .confirm-modal-body textarea:focus {
                                outline: none;
                                border-color: #3b82f6;
                                box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
                            }
                            .confirm-modal-body textarea {
                                resize: vertical !important;
                                min-height: 100px !important;
                            }
                            .confirm-modal-message {
                                margin-bottom: 16px;
                                padding: 12px;
                                background: #f9fafb;
                                border-radius: 8px;
                                border-left: 4px solid #3b82f6;
                            }
                            .confirm-modal-footer {
                                padding: 16px 24px !important;
                                border-top: 1px solid #e5e7eb !important;
                                display: flex !important;
                                gap: 12px !important;
                                justify-content: flex-end !important;
                            }
                            .confirm-modal-btn {
                                padding: 12px 24px !important;
                                border-radius: 8px !important;
                                font-size: 1rem !important;
                                font-weight: 600 !important;
                                border: none !important;
                                cursor: pointer !important;
                                transition: all 0.2s !important;
                                display: inline-flex;
                                align-items: center;
                                justify-content: center;
                                min-width: 100px !important;
                            }
                            .confirm-modal-btn-cancel {
                                background: #f3f4f6 !important;
                                color: #374151 !important;
                            }
                            .confirm-modal-btn-cancel:hover {
                                background: #e5e7eb !important;
                            }
                            .confirm-modal-btn-confirm {
                                background: linear-gradient(135deg, #3b82f6, #2563eb) !important;
                                color: #ffffff !important;
                            }
                            .confirm-modal-btn-confirm:hover {
                                background: linear-gradient(135deg, #2563eb, #1d4ed8);
                                transform: translateY(-1px);
                                box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
                            }
                            @keyframes fadeIn {
                                from { opacity: 0; }
                                to { opacity: 1; }
                            }
                            @keyframes scaleIn {
                                from { transform: scale(0.9); opacity: 0; }
                                to { transform: scale(1); opacity: 1; }
                            }
                            @keyframes modalSlideIn {
                                from {
                                    transform: translateY(-30px);
                                    opacity: 0;
                                }
                                to {
                                    transform: translateY(0);
                                    opacity: 1;
                                }
                            }
                        `;
                        document.head.appendChild(styleEl);
                    }
                    
                    const overlay = document.createElement('div');
                    overlay.className = 'confirm-modal-overlay';
                    overlay.innerHTML = `
                        <div class="confirm-modal">
                            <div class="confirm-modal-header">
                                <div class="confirm-modal-icon">
                                    <i class="fa fa-question-circle"></i>
                                </div>
                                <div class="confirm-modal-title">${title}</div>
                            </div>
                            <div class="confirm-modal-body">
                                <div class="confirm-modal-message">${message}</div>
                            </div>
                            <div class="confirm-modal-footer">
                                <button class="confirm-modal-btn confirm-modal-btn-cancel" data-action="cancel">
                                    Cancel
                                </button>
                                <button class="confirm-modal-btn confirm-modal-btn-confirm" data-action="confirm">
                                    Confirm
                                </button>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(overlay);
                    
                    // Focus confirm button
                    setTimeout(() => {
                        overlay.querySelector('.confirm-modal-btn-confirm').focus();
                    }, 100);
                    
                    // Handle button clicks
                    overlay.addEventListener('click', (e) => {
                        const action = e.target.getAttribute('data-action');
                        if (action === 'confirm') {
                            overlay.remove();
                            resolve(true);
                        } else if (action === 'cancel' || e.target === overlay) {
                            overlay.remove();
                            resolve(false);
                        }
                    });
                    
                    // Handle ESC key
                    const handleEsc = (e) => {
                        if (e.key === 'Escape') {
                            overlay.remove();
                            document.removeEventListener('keydown', handleEsc);
                            resolve(false);
                        }
                    };
                    document.addEventListener('keydown', handleEsc);
                });
            }
            
            // Make showConfirm globally accessible
            window.showConfirm = showConfirm;
            
            // Globals and DOM references expected by the script
            var ordersMap = {};
            // Role of current session (Admin, Driver, Sales Manager, Customer Manager, etc.)
            window.CURRENT_STAFF_ROLE = null;
            async function fetchStaffRole() {
                try {
                    const resp = await fetch('/WRSOMS/api/admin/staff-session.php', { credentials: 'same-origin' });
                    const j = await resp.json();
                    if (j && j.success) {
                        window.CURRENT_STAFF_ROLE = j.role || null;
                        console.log('Detected staff role:', window.CURRENT_STAFF_ROLE);
                    }
                } catch (e) {
                    console.warn('Failed to fetch staff role:', e);
                }
            }
            // If these elements are present in the parsed fragment they will be found; otherwise we fall back to querying later
            var batchesContainer = document.getElementById('batchesContainer');
            var unassignedContainer = document.getElementById('unassignedContainer');
            // Fallback API URL helper if not provided by the outer page
            if (typeof getApiUrl !== 'function') {
                function getApiUrl() { return '/WRSOMS/api/admin/manage_orders.php'; }
            }
            function escapeHtml(s) {
                return String(s == null ? '' : s)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;');
            }
            function renderOrderRow(o, batchStatus, batchId) {
                // store order object for modal usage
                if (o && o.reference_id) ordersMap[o.reference_id] = o;
                
                // Get delivery personnel name if available
                const deliveryPersonnel = o.delivery_personnel_name || '—';
                
                // Check if order is already completed or failed (PRIORITY CHECK)
                const orderStatus = (o.order_status || '').toLowerCase();
                const deliveryStatus = (o.delivery_status || '').toLowerCase();
                
                // Check multiple conditions for completed state
                const isCompleted = orderStatus.includes('completed') || 
                                   orderStatus.includes('delivered') ||
                                   deliveryStatus.includes('delivered') ||
                                   deliveryStatus.includes('completed') ||
                                   o.delivery_completed_at != null;
                
                // Check multiple conditions for failed state
                const isFailed = orderStatus.includes('failed') ||
                                deliveryStatus.includes('failed') ||
                                o.delivery_failed_at != null ||
                                o.failed_reason != null;
                
                let deliveryActionsHtml = '';
                
                // PRIORITY 1: Show final status if completed or failed
                if (isCompleted) {
                    deliveryActionsHtml = '<span class="text-success fw-bold" style="font-size:0.9rem;">✓ Complete</span>';
                } else if (isFailed) {
                    const failReason = o.failed_reason ? `<br><span style="font-weight:normal;font-size:0.85rem;color:#6b7280;">Reason: ${escapeHtml(o.failed_reason)}</span>` : '';
                    deliveryActionsHtml = `<span class="text-danger fw-bold" style="display:block;"><span style="display:inline-flex;align-items:center;gap:6px;"><i class="fa fa-times-circle"></i> Failed</span>${failReason}</span>`;
                } 
                // PRIORITY 2: Show action buttons only if delivery has started
                else {
                    const showDeliveryActions = deliveryStatus.includes('out for delivery') || 
                                               deliveryStatus.includes('in progress') ||
                                               deliveryStatus.includes('dispatched');
                    
                    if (showDeliveryActions) {
                        deliveryActionsHtml = `
                            <button class="btn btn-sm btn-success me-1 delivery-action-btn" 
                                    data-ref="${escapeHtml(o.reference_id)}" 
                                    data-action="complete"
                                    onclick="completeDelivery('${escapeHtml(o.reference_id)}', this)">
                                Complete
                            </button>
                            <button class="btn btn-sm btn-danger delivery-action-btn" 
                                    data-ref="${escapeHtml(o.reference_id)}" 
                                    data-action="fail"
                                    onclick="failedDelivery('${escapeHtml(o.reference_id)}', this)">
                                Failed
                            </button>
                        `;
                    } else {
                        deliveryActionsHtml = '<span class="text-muted" style="font-size:0.85rem;">—</span>';
                    }
                }
                
                return `
                    <tr class="order-row" data-ref="${escapeHtml(o.reference_id)}" ${batchId ? `data-batch="${escapeHtml(batchId)}"` : ''}>
                        <td><a href="#" class="order-ref-link" data-ref="${escapeHtml(o.reference_id)}">${escapeHtml(o.reference_id)}</a></td>
                        <td>${escapeHtml(o.order_date)}</td>
                        <td>${escapeHtml(o.payment_method || o.payment || '')}</td>
                        <td>${escapeHtml(Number(o.total_amount).toFixed(2))}</td>
                        <td class="payment-status">${escapeHtml(o.payment_status || '')}</td>
                        <td class="delivery-personnel">${escapeHtml(deliveryPersonnel)}</td>
                        <td class="status">${escapeHtml(o.delivery_status || batchStatus || '')}</td>
                        <td class="delivery-actions">${deliveryActionsHtml}</td>
                    </tr>
                `;
            }
            // Complete Delivery function
            window.completeDelivery = async function(refId, btn) {
                const order = ordersMap[refId];
                if (!order) {
                    showToast('error', 'Error', 'Order not found');
                    return;
                }

                const paymentMethod = (order.payment_method || '').toUpperCase();

                if (paymentMethod === 'COD') {
                    const existingBackdrop = document.getElementById('codAmountBackdrop');
                    if (existingBackdrop) existingBackdrop.remove();
                    
                    const backdrop = document.createElement('div');
                    backdrop.id = 'codAmountBackdrop';
                    backdrop.style.cssText = 'position:fixed!important;top:0!important;left:0!important;right:0!important;bottom:0!important;width:100vw!important;height:100vh!important;background:rgba(0,0,0,0.6)!important;z-index:999999!important;display:flex!important;align-items:center!important;justify-content:center!important;';
                    
                    const modal = document.createElement('div');
                    modal.style.cssText = 'background:white;border-radius:16px;max-width:500px;width:90%;box-shadow:0 25px 50px rgba(0,0,0,0.4);position:relative;';
                    modal.innerHTML = `
                        <div style="padding:20px 24px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;">
                            <h2 style="margin:0;font-size:1.25rem;font-weight:600;">Enter Amount Collected</h2>
                            <button id="codCloseBtn" style="background:#f3f4f6;border:none;width:32px;height:32px;border-radius:8px;font-size:1.5rem;cursor:pointer;line-height:1;">&times;</button>
                        </div>
                        <div style="padding:24px;">
                            <p style="margin-bottom:12px;">Order Total: <strong>₱${Number(order.total_amount).toFixed(2)}</strong></p>
                            <label style="display:block;margin-bottom:8px;font-weight:600;">Amount Received:</label>
                            <input type="number" id="codAmountInput" step="0.01" min="0" placeholder="Enter exact amount" 
                                style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:1rem;">
                            <div id="amountError" style="color:#ef4444;font-size:0.875rem;margin-top:8px;display:none;">
                                Amount must match order total exactly.
                            </div>
                        </div>
                        <div style="padding:16px 24px;border-top:1px solid #e5e7eb;display:flex;gap:12px;justify-content:flex-end;">
                            <button id="codCancelBtn" style="background:#f3f4f6;border:none;padding:10px 24px;border-radius:8px;cursor:pointer;font-weight:600;">Cancel</button>
                            <button id="confirmCodBtn" disabled style="background:#d1d5db;color:white;border:none;padding:10px 24px;border-radius:8px;cursor:not-allowed;font-weight:600;">Confirm</button>
                        </div>
                    `;
                    
                    backdrop.appendChild(modal);
                    document.body.appendChild(backdrop);

                    const input = document.getElementById('codAmountInput');
                    const confirmBtn = document.getElementById('confirmCodBtn');
                    const errorDiv = document.getElementById('amountError');
                    const expectedAmount = parseFloat(order.total_amount);

                    setTimeout(() => input.focus(), 100);

                    input.addEventListener('input', function() {
                        const enteredAmount = parseFloat(this.value);
                        if (!isNaN(enteredAmount) && Math.abs(enteredAmount - expectedAmount) < 0.01) {
                            confirmBtn.disabled = false;
                            confirmBtn.style.background = '#3b82f6';
                            confirmBtn.style.cursor = 'pointer';
                            errorDiv.style.display = 'none';
                            input.style.borderColor = '#10b981';
                        } else {
                            confirmBtn.disabled = true;
                            confirmBtn.style.background = '#d1d5db';
                            confirmBtn.style.cursor = 'not-allowed';
                            if (this.value) {
                                errorDiv.style.display = 'block';
                                input.style.borderColor = '#ef4444';
                            }
                        }
                    });

                    const closeModal = () => backdrop.remove();
                    document.getElementById('codCloseBtn').onclick = closeModal;
                    document.getElementById('codCancelBtn').onclick = closeModal;
                    backdrop.onclick = (e) => { if (e.target === backdrop) closeModal(); };

                    confirmBtn.onclick = async function() {
                        const enteredAmount = parseFloat(input.value);
                        if (Math.abs(enteredAmount - expectedAmount) < 0.01) {
                            backdrop.remove();
                            await proceedWithComplete(refId, btn, enteredAmount);
                        }
                    };
                } else {
                    await proceedWithComplete(refId, btn, null);
                }
            };

            async function proceedWithComplete(refId, btn, amount) {
                if (btn) btn.disabled = true;
                
                try {
                    const response = await fetch('/WRSOMS/api/admin/order_delivery_action.php', {
                        method: 'POST',
                        credentials: 'same-origin',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'complete',
                            reference_id: refId,
                            amount: amount
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (!result.success) throw new Error(result.message || 'Failed to complete delivery');
                    
                    showToast('success', 'Success', 'Delivery completed successfully');
                    
                    // Update UI - CRITICAL: Remove buttons and show status
                    const row = document.querySelector(`tr.order-row[data-ref="${refId}"]`);
                    if (row) {
                        const personnelCell = row.querySelector('.delivery-personnel');
                        const statusCell = row.querySelector('.status');
                        const actionsCell = row.querySelector('.delivery-actions');
                        
                        if (personnelCell) personnelCell.textContent = result.data.delivery_personnel || '—';
                        if (statusCell) statusCell.textContent = 'Delivered';
                        
                        // CRITICAL FIX: Replace buttons with status text
                        if (actionsCell) {
                            actionsCell.innerHTML = '<span class="text-success fw-bold" style="font-size:0.9rem;">✓ Complete</span>';
                        }
                        
                        // Update payment status if COD
                        if (result.data.payment_status) {
                            const paymentCell = row.querySelector('.payment-status');
                            if (paymentCell) paymentCell.textContent = result.data.payment_status;
                        }
                        
                        // Update ordersMap to reflect completion
                        if (ordersMap[refId]) {
                            ordersMap[refId].delivery_completed_at = new Date().toISOString();
                            ordersMap[refId].delivery_personnel_name = result.data.delivery_personnel;
                            ordersMap[refId].order_status = 'Completed';
                            ordersMap[refId].delivery_status = 'Delivered';
                        }
                    }
                    
                    // Reload data to ensure consistency
                    setTimeout(() => loadData(), 500);
                    
                } catch (err) {
                    console.error('Complete delivery error:', err);
                    showToast('error', 'Error', err.message || 'Failed to complete delivery');
                } finally {
                    if (btn) btn.disabled = false;
                }
            }

            // Failed Delivery function
            window.failedDelivery = async function(refId, btn) {
                const existingBackdrop = document.getElementById('failedReasonBackdrop');
                if (existingBackdrop) existingBackdrop.remove();
                
                const backdrop = document.createElement('div');
                backdrop.id = 'failedReasonBackdrop';
                backdrop.style.cssText = 'position:fixed!important;top:0!important;left:0!important;right:0!important;bottom:0!important;width:100vw!important;height:100vh!important;background:rgba(0,0,0,0.6)!important;z-index:999999!important;display:flex!important;align-items:center!important;justify-content:center!important;';
                
                const modal = document.createElement('div');
                modal.style.cssText = 'background:white;border-radius:16px;max-width:500px;width:90%;box-shadow:0 25px 50px rgba(0,0,0,0.4);position:relative;';
                modal.innerHTML = `
                    <div style="padding:20px 24px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;">
                        <h2 style="margin:0;font-size:1.25rem;font-weight:600;color:#ef4444;">
                            <i class="fa fa-exclamation-triangle" style="margin-right:8px;"></i>Mark Delivery Failed
                        </h2>
                        <button id="failedCloseBtn" style="background:#f3f4f6;border:none;width:32px;height:32px;border-radius:8px;font-size:1.5rem;cursor:pointer;line-height:1;">&times;</button>
                    </div>
                    <div style="padding:24px;">
                        <label style="display:block;margin-bottom:8px;font-weight:600;">Reason for Failure:</label>
                        <textarea id="failedReasonInput" rows="4" placeholder="Enter detailed reason..." 
                            style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:1rem;resize:vertical;"></textarea>
                        <div id="reasonError" style="color:#ef4444;font-size:0.875rem;margin-top:8px;display:none;">
                            Please provide a reason for the failure.
                        </div>
                    </div>
                    <div style="padding:16px 24px;border-top:1px solid #e5e7eb;display:flex;gap:12px;justify-content:flex-end;">
                        <button id="failedCancelBtn" style="background:#f3f4f6;border:none;padding:10px 24px;border-radius:8px;cursor:pointer;font-weight:600;">Cancel</button>
                        <button id="confirmFailedBtn" disabled style="background:#d1d5db;color:white;border:none;padding:10px 24px;border-radius:8px;cursor:not-allowed;font-weight:600;">Confirm</button>
                    </div>
                `;
                
                backdrop.appendChild(modal);
                document.body.appendChild(backdrop);

                const textarea = document.getElementById('failedReasonInput');
                const confirmBtn = document.getElementById('confirmFailedBtn');
                const errorDiv = document.getElementById('reasonError');

                setTimeout(() => textarea.focus(), 100);

                textarea.addEventListener('input', function() {
                    const reason = this.value.trim();
                    if (reason.length > 0) {
                        confirmBtn.disabled = false;
                        confirmBtn.style.background = '#ef4444';
                        confirmBtn.style.cursor = 'pointer';
                        errorDiv.style.display = 'none';
                    } else {
                        confirmBtn.disabled = true;
                        confirmBtn.style.background = '#d1d5db';
                        confirmBtn.style.cursor = 'not-allowed';
                    }
                });

                const closeModal = () => backdrop.remove();
                document.getElementById('failedCloseBtn').onclick = closeModal;
                document.getElementById('failedCancelBtn').onclick = closeModal;
                backdrop.onclick = (e) => { if (e.target === backdrop) closeModal(); };

                confirmBtn.onclick = async function() {
                    const reason = textarea.value.trim();
                    if (!reason) {
                        errorDiv.style.display = 'block';
                        textarea.style.borderColor = '#ef4444';
                        return;
                    }
                    backdrop.remove();
                    if (btn) btn.disabled = true;
                    
                    try {
                        const response = await fetch('/WRSOMS/api/admin/order_delivery_action.php', {
                            method: 'POST',
                            credentials: 'same-origin',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ action: 'fail', reference_id: refId, reason: reason })
                        });
                        const result = await response.json();
                        if (!result.success) throw new Error(result.message || 'Failed to mark as failed');
                        
                        showToast('error', 'Marked as Failed', `Delivery marked as failed`);
                        
                        // Update UI - CRITICAL: Remove buttons and show status
                        const row = document.querySelector(`tr.order-row[data-ref="${refId}"]`);
                        if (row) {
                            const personnelCell = row.querySelector('.delivery-personnel');
                            const statusCell = row.querySelector('.status');
                            const actionsCell = row.querySelector('.delivery-actions');
                            
                            if (personnelCell) personnelCell.textContent = result.data.delivery_personnel || '—';
                            if (statusCell) statusCell.textContent = 'Failed';
                            
                            // CRITICAL FIX: Replace buttons with status text
                            if (actionsCell) {
                                actionsCell.innerHTML = `<span class="text-danger fw-bold" style="display:block;"><span style="display:inline-flex;align-items:center;gap:6px;"><i class="fa fa-times-circle"></i> Failed</span><br><span style="font-weight:normal;font-size:0.85rem;color:#6b7280;">Reason: ${escapeHtml(reason)}</span></span>`;
                            }
                            
                            // Update ordersMap to reflect failure
                            if (ordersMap[refId]) {
                                ordersMap[refId].delivery_failed_at = new Date().toISOString();
                                ordersMap[refId].failed_reason = reason;
                                ordersMap[refId].delivery_personnel_name = result.data.delivery_personnel;
                                ordersMap[refId].order_status = 'Failed';
                                ordersMap[refId].delivery_status = 'Failed';
                            }
                        }
                        
                        setTimeout(() => loadData(), 500);
                    } catch (err) {
                        showToast('error', 'Error', err.message || 'Failed to mark delivery as failed');
                    } finally {
                        if (btn) btn.disabled = false;
                    }
                };
            };

            function renderBatch(batch, idx) {
                const orders = batch.orders || [];
                const header = `Vehicle: ${escapeHtml(batch.vehicle_type)} — Batch #${escapeHtml(batch.batch_number)} — Orders: ${orders.length}`;
                const pickupTime = batch.pickup_time || '—';
                const deliveryTime = batch.delivery_time || '—';
                const pickupStatusDisplay = batch.pickup_status || '—';
                const deliveryStatusDisplay = batch.delivery_status || '—';
                const tableRows = orders.length
                    ? orders.map(o => renderOrderRow(o, batch.batch_status, batch.batch_id)).join('')
                    : `<tr><td colspan="8" class="text-center text-muted">No orders in this batch</td></tr>`;

                // Button sequence
                const ps = (batch.pickup_status || '').toLowerCase();
                const ds = (batch.delivery_status || '').toLowerCase();
                let buttonsHtml = '';
                
                // Step 4: Delivery completed (final state)
                if (ds === 'completed' || ds.includes('delivered')) {
                    buttonsHtml = '<div class="text-success fw-semibold" style="font-size:.9rem;">✓ Delivery Completed</div>';
                } 
                // Step 3: Delivery in progress - show complete delivery button
                else if (ds === 'in progress' || ds.includes('out for delivery')) {
                    buttonsHtml = `<button class="btn btn-sm btn-dark action-btn" data-action="complete_delivery"
                        onclick="performBatchAction('${escapeHtml(batch.batch_id)}','complete_delivery',this)">Complete Delivery</button>`;
                } 
                // Step 2: Pickup completed - show start delivery button
                else if (ps === 'completed') {
                    buttonsHtml = `<button class="btn btn-sm btn-warning action-btn" data-action="start_delivery"
                        onclick="performBatchAction('${escapeHtml(batch.batch_id)}','start_delivery',this)">Start Delivery</button>`;
                } 
                // Step 1.5: Pickup in progress - show complete pickup button
                else if (ps === 'in progress') {
                    buttonsHtml = `<button class="btn btn-sm btn-success action-btn" data-action="complete_pickup"
                        onclick="performBatchAction('${escapeHtml(batch.batch_id)}','complete_pickup',this)">Complete Pickup</button>`;
                } 
                // Step 1: Initial state (pickup pending or no status) - show start pickup button
                else {
                    buttonsHtml = `<button class="btn btn-sm btn-primary action-btn" data-action="start_pickup"
                        onclick="performBatchAction('${escapeHtml(batch.batch_id)}','start_pickup',this)">Start Pickup</button>`;
                }

                // Driver role restriction
                try {
                    const role = (window.CURRENT_STAFF_ROLE || '').toLowerCase();
                    if (role.includes('driver') || role.includes('rider')) {
                        // Drivers can only see and use delivery-related actions
                        if (ds === 'completed' || ds.includes('delivered')) {
                            // Keep the completed status display
                        } else if (ds === 'in progress' || ds.includes('out for delivery')) {
                            // Keep the Complete Delivery button
                        } else if (ps === 'completed') {
                            // Keep the Start Delivery button
                        } else {
                            // Hide all pickup actions for drivers
                            buttonsHtml = '<div class="text-muted small">No delivery actions available</div>';
                        }
                    }
                } catch(e){}

                return `
                <div class="metric-card mb-3" data-batch-id="${escapeHtml(batch.batch_id)}">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <strong>${header}</strong>
                            <div class="text-muted small">
                                Pickup: <span class="pickup-time">${escapeHtml(pickupTime)}</span> |
                                Delivery: <span class="delivery-time">${escapeHtml(deliveryTime)}</span>
                            </div>
                            <div class="text-muted small">
                                Pickup status: <span class="pickup-status">${escapeHtml(pickupStatusDisplay)}</span> |
                                Delivery status: <span class="delivery-status">${escapeHtml(deliveryStatusDisplay)}</span>
                            </div>
                        </div>
                        <div class="batch-actions d-flex gap-2" data-batch-id="${escapeHtml(batch.batch_id)}">
                            ${buttonsHtml}
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="recent-orders-table mb-0">
                            <thead>
                                <tr>
                                    <th>Reference ID</th>
                                    <th>Order Date</th>
                                    <th>Payment Method</th>
                                    <th>Total</th>
                                    <th>Payment Status</th>
                                    <th>Delivery Personnel</th>
                                    <th>Delivery Status</th>
                                    <th>Delivery Actions</th>
                                </tr>
                            </thead>
                            <tbody>${tableRows}</tbody>
                        </table>
                    </div>
                </div>`;
            }
            function renderUnassigned(list) {
                if (!list.length) {
                    unassignedContainer.innerHTML = '';
                    return;
                }
                const rows = list.map(o => renderOrderRow(o, '', null)).join('');
                unassignedContainer.innerHTML = `
                    <div class="metric-card">
                        <h4>Unassigned Orders</h4>
                        <div class="table-responsive">
                            <table class="recent-orders-table mb-0">
                                <thead>
                                    <tr>
                                        <th>Reference ID</th>
                                        <th>Order Date</th>
                                        <th>Payment Method</th>
                                        <th>Total</th>
                                        <th>Payment Status</th>
                                        <th>Delivery Personnel</th>
                                        <th>Delivery Status</th>
                                        <th>Delivery Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${rows}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }
            
            // Store archived order IDs for client-side filtering
            let archivedOrderIds = new Set();
            
            // Fetch archived order IDs
            async function fetchArchivedIds() {
                try {
                    const resp = await fetch('/WRSOMS/api/admin/get_archived_ids.php', { credentials: 'same-origin' });
                    const result = await resp.json();
                    if (result.success && result.data && Array.isArray(result.data.archived_ids)) {
                        archivedOrderIds = new Set(result.data.archived_ids);
                        console.log(`Loaded ${archivedOrderIds.size} archived order IDs for filtering`);
                    }
                } catch (err) {
                    console.error('Failed to fetch archived IDs:', err);
                }
            }
            
            // Initial fetch
            function loadData() {
                const apiUrl = getApiUrl();
                batchesContainer.innerHTML = '<p class="text-muted">Loading batches and orders…</p>';
                unassignedContainer.innerHTML = '';
                
                // Fetch archived IDs first, then load orders
                fetchArchivedIds().then(() => {
                    fetch(apiUrl, { credentials: 'same-origin' })
                    .then(r => r.json())
                    .then(res => {
                        if (!res.success) throw new Error(res.message || 'Failed to load');
                        const data = res.data || {};
                        let batches = data.batches || [];
                        let unassigned = data.unassigned || [];
                        
                        // CLIENT-SIDE FILTERING: Remove archived orders
                        batches.forEach(batch => {
                            if (batch.orders && Array.isArray(batch.orders)) {
                                batch.orders = batch.orders.filter(order => !archivedOrderIds.has(order.reference_id));
                            }
                        });
                        unassigned = unassigned.filter(order => !archivedOrderIds.has(order.reference_id));
                        
                        // Remove empty batches
                        batches = batches.filter(batch => batch.orders && batch.orders.length > 0);
                    if (!batches.length && !unassigned.length) {
                        batchesContainer.innerHTML = '<p class="text-muted orders-empty">No batches or orders found for today.</p>';
                        return;
                    }
                    // Group batches by vehicle type so Car and Tricycle batches render in separate sections
                    const tricycleBatches = batches.filter(b => (b.vehicle_type || '').toLowerCase() === 'tricycle');
                    const carBatches = batches.filter(b => (b.vehicle_type || '').toLowerCase() === 'car');
                    const isCompleted = (b) => {
                        // Treat batch as completed when its delivery_status indicates 'Delivered' or batch_status contains 'completed'
                        const ds = (b.delivery_status || '') + '';
                        const bs = (b.batch_status || '') + '';
                        if (ds.toLowerCase().indexOf('delivered') !== -1) return true;
                        if (bs.toLowerCase().indexOf('completed') !== -1) return true;
                        return false;
                    };
                    // Split active vs completed
                    const activeTricycle = tricycleBatches.filter(b => !isCompleted(b));
                    const completedTricycle = tricycleBatches.filter(b => isCompleted(b));
                    const activeCar = carBatches.filter(b => !isCompleted(b));
                    const completedCar = carBatches.filter(b => isCompleted(b));
                    // Compute aggregates per vehicle type (active only)
                    const sumQuantity = (arr) => arr.reduce((s, x) => s + (Number(x.total_quantity) || 0), 0);
                    const sumCapacity = (arr) => arr.reduce((s, x) => s + (Number(x.capacity) || 0), 0);
                    const tricycleTotalAssigned = sumQuantity(activeTricycle);
                    const tricycleTotalCapacity = sumCapacity(activeTricycle) || (activeTricycle.length ? activeTricycle.length * 5 : 0);
                    const carTotalAssigned = sumQuantity(activeCar);
                    const carTotalCapacity = sumCapacity(activeCar) || (activeCar.length ? activeCar.length * 10 : 0);
                    // Build tabbed controls for filtering (include Completed tab)
                    let out = '';
                    out += `<div class="mb-3">
                        <ul class="nav nav-tabs" role="tablist" id="vehicleTabs">
                            <li class="nav-item"><button class="nav-link active vehicle-tab-btn" data-target="all" type="button" style="color: #111827 !important; background: #ffffff !important;">All</button></li>
                            <li class="nav-item"><button class="nav-link vehicle-tab-btn" data-target="tricycle" type="button" style="color: #111827 !important; background: #ffffff !important;">Tricycle</button></li>
                            <li class="nav-item"><button class="nav-link vehicle-tab-btn" data-target="car" type="button" style="color: #111827 !important; background: #ffffff !important;">Car</button></li>
                            <li class="nav-item"><button class="nav-link vehicle-tab-btn" data-target="completed" type="button" style="color: #111827 !important; background: #ffffff !important;">Completed</button></li>
                        </ul>
                    </div>`;
                    // Active sections
                    if (activeTricycle.length) {
                        out += '<section class="vehicle-section mb-3" data-vehicle="tricycle">';
                        out += `<h4 class="mb-2">Tricycle <small class="text-muted">(Assigned: ${escapeHtml(String(tricycleTotalAssigned))}/${escapeHtml(String(tricycleTotalCapacity))} containers)</small></h4>`;
                        out += `<div class="batches-grid">${activeTricycle.map((b, i) => renderBatch(b, 'tricycle-' + i)).join('')}</div>`;
                        out += '</section>';
                    }
                    if (activeCar.length) {
                        out += '<section class="vehicle-section mb-3" data-vehicle="car">';
                        out += `<h4 class="mb-2">Car <small class="text-muted">(Assigned: ${escapeHtml(String(carTotalAssigned))}/${escapeHtml(String(carTotalCapacity))} containers)</small></h4>`;
                        out += `<div class="batches-grid">${activeCar.map((b, i) => renderBatch(b, 'car-' + i)).join('')}</div>`;
                        out += '</section>';
                    }
                    // Completed sections: render separate vehicle-type completed groups (Tricycle and Car)
                    if (completedTricycle.length) {
                        out += '<section class="vehicle-section mb-3 completed-section" data-vehicle="tricycle">';
                        out += `<h4 class="mb-2">Tricycle (Completed) <small class="text-muted">(${escapeHtml(String(completedTricycle.length))} batch${completedTricycle.length>1?'es':''})</small></h4>`;
                        out += `<div class="batches-grid">${completedTricycle.map((b, i) => renderBatch(b, 'completed-tricycle-' + i)).join('')}</div>`;
                        out += '</section>';
                    }
                    if (completedCar.length) {
                        out += '<section class="vehicle-section mb-3 completed-section" data-vehicle="car">';
                        out += `<h4 class="mb-2">Car (Completed) <small class="text-muted">(${escapeHtml(String(completedCar.length))} batch${completedCar.length>1?'es':''})</small></h4>`;
                        out += `<div class="batches-grid">${completedCar.map((b, i) => renderBatch(b, 'completed-car-' + i)).join('')}</div>`;
                        out += '</section>';
                    }
                    // If no batches for either active types or completed groups, render a fallback empty message
                    if (!activeTricycle.length && !activeCar.length && !completedTricycle.length && !completedCar.length) out += '<p class="text-muted orders-empty">No batches or orders found for today.</p>';
                    batchesContainer.innerHTML = out;
                    // Wire up vehicle tab buttons with proper filtering
                    document.querySelectorAll('.vehicle-tab-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            console.log('Tab clicked:', this.getAttribute('data-target'));
                            
                            // Remove active class from all tabs and reset to inactive colors
                            document.querySelectorAll('.vehicle-tab-btn').forEach(n => {
                                n.classList.remove('active');
                                n.style.color = '#111827';
                                n.style.background = '#ffffff';
                                n.style.borderColor = '#d1d5db';
                            });
                            
                            // Set active tab with blue background and white text
                            this.classList.add('active');
                            this.style.color = '#ffffff';
                            this.style.background = '#3b82f6';
                            this.style.borderColor = '#3b82f6';
                            
                            const target = this.getAttribute('data-target');
                            
                            if (target === 'all') {
                                // Show all active sections (hide completed)
                                document.querySelectorAll('.vehicle-section').forEach(s => {
                                    if (s.classList.contains('completed-section')) {
                                        s.style.display = 'none';
                                    } else {
                                        s.style.display = 'block';
                                    }
                                });
                            } else if (target === 'completed') {
                                // Show only completed sections (hide active)
                                document.querySelectorAll('.vehicle-section').forEach(s => {
                                    if (s.classList.contains('completed-section')) {
                                        s.style.display = 'block';
                                    } else {
                                        s.style.display = 'none';
                                    }
                                });
                            } else {
                                // Show only the selected vehicle type (tricycle or car), hide completed
                                document.querySelectorAll('.vehicle-section').forEach(s => {
                                    const vehicleType = s.getAttribute('data-vehicle');
                                    const isCompleted = s.classList.contains('completed-section');
                                    
                                    if (vehicleType === target && !isCompleted) {
                                        s.style.display = 'block';
                                    } else {
                                        s.style.display = 'none';
                                    }
                                });
                            }
                        });
                    });
                    renderUnassigned(unassigned);
                    // Wire up simple collapse toggles (Bootstrap's JS should already be loaded by the parent page)
                    // Wire up collapse toggles for batch cards
                    document.querySelectorAll('[data-toggle="collapse"]').forEach(btn => {
                        btn.addEventListener('click', (ev) => {
                            const target = btn.getAttribute('data-target');
                            const el = document.querySelector(target);
                            if (!el) return;
                            el.classList.toggle('show');
                            // rotate icon if present
                            btn.classList.toggle('active');
                        });
                    });
                    // Wire up entire row click to open modal (including the link)
                    document.querySelectorAll('tr.order-row').forEach(row => {
                        row.addEventListener('click', function(e) {
                            // Don't trigger if clicking on a button (but allow links)
                            if (e.target.tagName === 'BUTTON') return;
                           
                            // Prevent default for links
                            if (e.target.tagName === 'A') {
                                e.preventDefault();
                            }
                           
                            const ref = this.getAttribute('data-ref');
                            const ord = ordersMap[ref];
                            if (ord) showOrderModal(ord);
                        });
                    });
                    })
                    .catch(err => {
                        console.error('Manage orders load error', err);
                        batchesContainer.innerHTML = '<p class="text-danger">Error loading orders. Check the API or session.</p>';
                    });
                });
            }
            // initial call: fetch staff role first so UI can apply role-based filtering
            fetchStaffRole().then(() => {
                loadData();
            });
            // Perform batch action: start/complete pickup/delivery
            // CRITICAL: Must be on window for inline onclick handlers to work
            if (typeof window.performBatchAction !== 'undefined') {
                console.log('performBatchAction already exists, overwriting...');
            }
            window.performBatchAction = async function(batchId, action, btn) {
                console.log('performBatchAction called:', { batchId, action, btn });
                const actionTitles = {
                    start_pickup: "Start Pickup",
                    complete_pickup: "Complete Pickup",
                    start_delivery: "Start Delivery",
                    complete_delivery: "Complete Delivery"
                };
                const actionMessages = {
                    start_pickup: "Are you sure you want to start pickup for this batch?",
                    complete_pickup: "Are you sure you want to mark pickup as completed for this batch?",
                    start_delivery: "Are you sure you want to start delivery for this batch?",
                    complete_delivery: "Are you sure you want to mark delivery as completed for this batch?"
                };
                
                const confirmed = await showConfirm(
                    actionTitles[action] || 'Confirm Action',
                    actionMessages[action] || 'Are you sure you want to proceed?'
                );
                
                if (!confirmed) {
                    console.log('Action cancelled by user');
                    return;
                }
                console.log('Action confirmed, making API call...');
                if (btn) btn.disabled = true;
               
                fetch('/WRSOMS/api/admin/batch_action.php', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: action, batch_id: batchId })
                })
                .then(r => {
                    console.log('Batch action HTTP status:', r.status);
                    return r.text();
                })
                .then(text => {
                    console.log('Batch action response text:', text);
                    try {
                        return JSON.parse(text);
                    } catch(e) {
                        throw new Error('Invalid JSON response: ' + text.substring(0, 200));
                    }
                })
                .then(res => {
                    console.log('Batch action parsed response:', res);
                    if (!res.success) throw new Error(res.message || 'Action failed');
                   
                    // Show success message immediately
                    const successMessages = {
                        start_pickup: "Pickup started successfully",
                        complete_pickup: "Pickup completed successfully",
                        start_delivery: "Delivery started successfully",
                        complete_delivery: "Delivery completed successfully"
                    };
                    showToast('success', 'Success', successMessages[action] || 'Action completed successfully');
                    
                    const card = document.querySelector(`.metric-card[data-batch-id="${batchId}"]`);
                    if (card) {
                        const pickupStatusEl = card.querySelector('.pickup-status');
                        const deliveryStatusEl = card.querySelector('.delivery-status');
                        const pickupTimeEl = card.querySelector('.pickup-time');
                        const deliveryTimeEl = card.querySelector('.delivery-time');
                        const actionsDiv = card.querySelector('.batch-actions');
                        // Update status and buttons based on action
                        switch(action) {
                            case 'start_pickup':
                                if (pickupStatusEl) pickupStatusEl.textContent = 'In Progress';
                                if (actionsDiv) {
                                    actionsDiv.innerHTML = `
                                        <button class="btn btn-sm btn-success action-btn" data-action="complete_pickup"
                                            onclick="performBatchAction('${batchId}', 'complete_pickup', this)">Complete Pickup</button>
                                    `;
                                }
                                break;
                               
                            case 'complete_pickup':
                                if (pickupStatusEl) pickupStatusEl.textContent = 'Completed';
                                if (pickupTimeEl) pickupTimeEl.textContent = new Date().toLocaleString();
                                if (actionsDiv) {
                                    actionsDiv.innerHTML = `
                                        <button class="btn btn-sm btn-warning action-btn" data-action="start_delivery"
                                            onclick="performBatchAction('${batchId}', 'start_delivery', this)">Start Delivery</button>
                                    `;
                                }
                                break;
                               
                            case 'start_delivery':
                                if (deliveryStatusEl) deliveryStatusEl.textContent = 'In Progress';
                                if (actionsDiv) {
                                    actionsDiv.innerHTML = `
                                        <button class="btn btn-sm btn-dark action-btn" data-action="complete_delivery"
                                            onclick="performBatchAction('${batchId}', 'complete_delivery', this)">Complete Delivery</button>
                                    `;
                                }
                                break;
                               
                            case 'complete_delivery':
                                if (deliveryStatusEl) deliveryStatusEl.textContent = 'Delivered';
                                if (deliveryTimeEl) deliveryTimeEl.textContent = new Date().toLocaleString();
                                if (actionsDiv) {
                                    actionsDiv.innerHTML = '<div class="text-muted small">Completed</div>';
                                }
                                break;
                        }
                        // Update all order statuses within the batch
                        const orderRows = card.querySelectorAll('tr.order-row');
                        orderRows.forEach(row => {
                            const statusCell = row.querySelector('.status');
                            if (statusCell) {
                                switch(action) {
                                    case 'start_pickup':
                                        statusCell.textContent = 'Pickup In Progress';
                                        break;
                                    case 'complete_pickup':
                                        statusCell.textContent = 'Pickup Completed';
                                        break;
                                    case 'start_delivery':
                                        statusCell.textContent = 'Out for Delivery';
                                        break;
                                    case 'complete_delivery':
                                        statusCell.textContent = 'Delivered';
                                        break;
                                }
                            }
                        });
                        
                        // Reload data after complete_delivery to refresh payment status for COD orders
                        if (action === 'complete_delivery') {
                            setTimeout(() => {
                                loadData();
                            }, 500);
                        }
                    } else {
                        console.warn('Batch card not found for batch_id:', batchId);
                    }
                })
                .catch(err => {
                    console.error('Batch action error', err);
            
            // Test that the function is accessible
            console.log('window.performBatchAction defined:', typeof window.performBatchAction);
            
            // FALLBACK: Add event delegation for action buttons in case inline onclick doesn't work
            document.addEventListener('click', function(e) {
                const actionBtn = e.target.closest('.action-btn');
                if (actionBtn) {
                    const action = actionBtn.getAttribute('data-action');
                    const card = actionBtn.closest('.metric-card');
                    const batchId = card ? card.getAttribute('data-batch-id') : null;
                    
                    if (action && batchId) {
                        console.log('Event delegation triggered:', { action, batchId });
                        e.preventDefault();
                        e.stopPropagation();
                        window.performBatchAction(batchId, action, actionBtn);
                    }
                }
            }, true); // Use capture phase to catch event before inline handlers
            
            console.log('Event delegation for action buttons installed');
            // Modal builder & display
            function formatItemsHtml(items) {
                if (!items || !items.length) return '<div style="text-align:center; padding:30px; color:#9ca3af; font-size:0.95rem;">No items in this order</div>';
               
                return `<table style="width:100%; border-collapse:collapse;">
                    <thead>
                        <tr style="background:#f9fafb;">
                            <th style="padding:12px 18px; text-align:left; font-size:0.75rem; color:#6b7280; font-weight:700; text-transform:uppercase; letter-spacing:0.5px; border-bottom:2px solid #e5e7eb;">Item</th>
                            <th style="padding:12px 18px; text-align:left; font-size:0.75rem; color:#6b7280; font-weight:700; text-transform:uppercase; letter-spacing:0.5px; border-bottom:2px solid #e5e7eb;">Type</th>
                            <th style="padding:12px 18px; text-align:center; font-size:0.75rem; color:#6b7280; font-weight:700; text-transform:uppercase; letter-spacing:0.5px; border-bottom:2px solid #e5e7eb;">Qty</th>
                            <th style="padding:12px 18px; text-align:right; font-size:0.75rem; color:#6b7280; font-weight:700; text-transform:uppercase; letter-spacing:0.5px; border-bottom:2px solid #e5e7eb;">Price</th>
                            <th style="padding:12px 18px; text-align:right; font-size:0.75rem; color:#6b7280; font-weight:700; text-transform:uppercase; letter-spacing:0.5px; border-bottom:2px solid #e5e7eb;">Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>${items.map(it => `
                        <tr style="border-bottom:1px solid #f3f4f6;">
                            <td style="padding:14px 18px; font-weight:700; color:#111827; font-size:0.95rem;">${escapeHtml(it.container_type || ('#'+(it.container_id||'')))}</td>
                            <td style="padding:14px 18px; color:#6b7280; font-size:0.9rem;">${escapeHtml(it.order_type_display || it.order_type || '-')}</td>
                            <td style="padding:14px 18px; text-align:center;">
                                <span style="display:inline-block; background:#dbeafe; color:#1e40af; padding:3px 10px; border-radius:5px; font-weight:700; font-size:0.9rem;">${escapeHtml(it.quantity)}</span>
                            </td>
                            <td style="padding:14px 18px; text-align:right; color:#6b7280; font-size:0.9rem;">₱${Number(it.price||0).toFixed(2)}</td>
                            <td style="padding:14px 18px; text-align:right; font-weight:700; color:#111827; font-size:0.95rem;">₱${Number(it.subtotal||0).toFixed(2)}</td>
                        </tr>
                    `).join('')}</tbody>
                </table>`;
            }
            function showOrderModal(o) {
                // Render a receipt-style modal using the existing checkout/receipt layout
                let backdrop = document.getElementById('wwOrderModalBackdrop');
               
                // Determine status badge color
                const status = o.delivery_status || o.order_status || 'Unknown';
                let statusColor = '#6b7280';
                if (status.toLowerCase().includes('delivered') || status.toLowerCase().includes('completed')) statusColor = '#10b981';
                else if (status.toLowerCase().includes('pending')) statusColor = '#f59e0b';
                else if (status.toLowerCase().includes('dispatched')) statusColor = '#3b82f6';
               
                const receiptHtml = `
                    <div class="ww-modal" role="dialog" aria-modal="true" style="position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); max-width:850px; width:92%; max-height:calc(100vh - 40px); overflow:hidden; display:flex; flex-direction:column; background:white; border-radius:16px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.2);">
                        <!-- Header -->
                        <div class="ww-modal-header" style="padding:24px 28px; border-bottom:none; background:white; border-radius:16px 16px 0 0;">
                            <div style="flex: 1;">
                                <div style="display:flex; align-items:center; gap:12px; margin-bottom:6px;">
                                    <h3 style="margin:0; font-size:1.6rem; color:#111827; font-weight:800;">Order ${escapeHtml(o.reference_id || 'N/A')}</h3>
                                    <span style="display:inline-block; padding:5px 12px; border-radius:20px; background:${statusColor}; color:white; font-size:0.75rem; font-weight:800; letter-spacing:0.8px; text-transform:uppercase;">
                                        ${escapeHtml(status)}
                                    </span>
                                </div>
                                <div style="color:#9ca3af; font-size:0.9rem; font-weight:500;">Order details and information</div>
                            </div>
                            <button class="close-btn" id="wwModalCloseBtn" style="font-size:2rem; width:40px; height:40px; padding:0; display:flex; align-items:center; justify-content:center; border-radius:8px; line-height:1; background:#f3f4f6; color:#111827; box-shadow:none;">×</button>
                        </div>
                       
                        <!-- Body -->
                        <div class="ww-modal-body" style="flex: 1; overflow-y:auto; padding:0 28px 20px 28px; background:white;">
                            <!-- Order Info Grid -->
                            <div style="background:linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); padding:20px; border-radius:10px; margin-bottom:16px;">
                                <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:20px; color:white;">
                                    <div>
                                        <div style="font-size:0.75rem; opacity:0.85; margin-bottom:4px; font-weight:600; text-transform:uppercase; letter-spacing:0.5px;">Order Date</div>
                                        <div style="font-size:1rem; font-weight:700;">${escapeHtml(o.order_date || 'N/A')}</div>
                                    </div>
                                    <div>
                                        <div style="font-size:0.75rem; opacity:0.85; margin-bottom:4px; font-weight:600; text-transform:uppercase; letter-spacing:0.5px;">Delivery</div>
                                        <div style="font-size:1rem; font-weight:700;">${escapeHtml(o.delivery_date || 'N/A')}</div>
                                    </div>
                                    <div>
                                        <div style="font-size:0.75rem; opacity:0.85; margin-bottom:4px; font-weight:600; text-transform:uppercase; letter-spacing:0.5px;">Batch</div>
                                        <div style="font-size:1rem; font-weight:700;">${o.batch_id ? '#' + escapeHtml(o.batch_id) : 'Unassigned'}</div>
                                    </div>
                                </div>
                            </div>
                           
                            <!-- Customer & Address in Single Row -->
                                                       <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:16px;">
                                <div style="background:#f9fafb; padding:18px; border-radius:10px; border:1px solid #e5e7eb;">
                                    <h4 style="font-size:0.85rem; margin:0 0 12px 0; color:#6b7280; font-weight:700; text-transform:uppercase; letter-spacing:0.5px;">Customer</h4>
                                    <div style="margin-bottom:8px;">
                                        <div style="font-weight:700; color:#111827; font-size:1.05rem; margin-bottom:4px;">${escapeHtml(o.customer_name || 'N/A')}</div>
                                        <div style="color:#6b7280; font-size:0.9rem;">${escapeHtml(o.customer_contact || 'N/A')}</div>
                                    </div>
                                </div>
                                <div style="background:#f9fafb; padding:18px; border-radius:10px; border:1px solid #e5e7eb;">
                                    <h4 style="font-size:0.85rem; margin:0 0 12px 0; color:#6b7280; font-weight:700; text-transform:uppercase; letter-spacing:0.5px;">Delivery Address</h4>
                                    <div style="color:#111827; font-weight:600; line-height:1.5; font-size:0.95rem;">
                                        ${escapeHtml([o.street, o.barangay, o.city, o.province].filter(Boolean).join(', ') || 'Not provided')}
                                    </div>
                                </div>
                            </div>
                           
                            <!-- Order Items -->
                            <div style="background:#ffffff; border-radius:10px; border:1px solid #e5e7eb; overflow:hidden;">
                                <div style="background:#111827; padding:14px 18px;">
                                    <h4 style="font-size:0.85rem; margin:0; color:white; font-weight:700; text-transform:uppercase; letter-spacing:0.8px;">Order Items</h4>
                                </div>
                                ${formatItemsHtml(o.items)}
                            </div>
                        </div>
                       
                        <!-- Footer -->
                        <div class="ww-modal-footer" style="padding:18px 28px; display:flex; justify-content:space-between; align-items:center; border-top:2px solid #e5e7eb; background:white; border-radius:0 0 16px 16px;">
                            <div style="font-size:1.4rem; font-weight:800; color:#111827;">Total: <span style="color:#3b82f6;">₱${Number(o.total_amount||0).toFixed(2)}</span></div>
                            <button class="close-btn" id="wwModalCloseBtn2" style="padding:10px 24px; font-size:0.95rem;">Close</button>
                        </div>
                    </div>`;
                if (!backdrop) {
                    backdrop = document.createElement('div');
                    backdrop.id = 'wwOrderModalBackdrop';
                    backdrop.className = 'ww-modal-backdrop';
                    backdrop.style.position = 'fixed';
                    backdrop.style.top = '0';
                    backdrop.style.zIndex = '2147483647';
                    backdrop.style.display = 'none';
                    backdrop.style.alignItems = 'center';
                    backdrop.style.justifyContent = 'center';
                    backdrop.style.padding = '20px';
                    backdrop.style.boxSizing = 'border-box';
                    backdrop.style.background = 'rgba(0,0,0,0.45)';
                    backdrop.innerHTML = receiptHtml;

                    document.body.appendChild(backdrop);
                }
                backdrop.style.display = 'flex';
                
                // Close buttons handler
                document.querySelectorAll('#wwModalCloseBtn, #wwModalCloseBtn2').forEach(btn => {
                    btn.onclick = function() {
                        backdrop.style.display = 'none';
                        setTimeout(() => {
                            backdrop.remove();
                        }, 300);
                    };
                });
            }
            
            // Archive button handler (top right)
            const archiveBtn = document.getElementById('archiveCompletedBtn');
            if (archiveBtn) {
                archiveBtn.addEventListener('click', async function() {
                    const confirmed = await showConfirm(
                        'Archive Completed Orders',
                        'Are you sure you want to archive all completed orders for today? This will move them to the archive table and clear them from the active list. You can still view them in reports and order history.'
                    );
                    if (!confirmed) {
                        return;
                    }
                    
                    archiveBtn.disabled = true;
                    archiveBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Archiving...';
                    
                    const formData = new FormData();
                    formData.append('archive_type', 'manual');
                    // Use local date (YYYY-MM-DD) to avoid UTC offset issues
                    (function(){
                        const d = new Date();
                        const y = d.getFullYear();
                        const m = String(d.getMonth() + 1).padStart(2, '0');
                        const day = String(d.getDate()).padStart(2, '0');
                        formData.append('date_filter', `${y}-${m}-${day}`);
                    })();
                    
                    fetch('/WRSOMS/api/admin/archive_completed.php', {
                        method: 'POST',
                        credentials: 'same-origin',
                        body: formData
                    })
                    .then(r => {
                        console.log('Archive response status:', r.status);
                        return r.text();
                    })
                    .then(text => {
                        console.log('Archive response text:', text);
                        try {
                            return JSON.parse(text);
                        } catch(e) {
                            throw new Error('Invalid JSON response: ' + text.substring(0, 200));
                        }
                    })
                    .then(async res => {
                        console.log('Archive response:', res);
                        
                        // If server returned diagnostics and zero archived, show diagnostics
                        if (res.data && res.data.orders_archived === 0 && res.data.diagnostics) {
                                console.log('Archive diagnostics:', res.data.diagnostics);
                                const d = res.data.diagnostics;
                                const diagMsg = `Orders on date: ${d.orders_on_date_count}\nSample: ${Array.isArray(d.orders_on_date_sample)?d.orders_on_date_sample.join(', '):d.orders_on_date_sample}\nBatches: ${JSON.stringify(d.batches)}\nDeliveries: ${JSON.stringify(d.deliveries)}`;

                                // If no orders exist for the local date, try UTC date as a fallback
                                if ((d.orders_on_date_count || 0) === 0) {
                                    // Try UTC date fallback once
                                    const utcDate = new Date().toISOString().split('T')[0];
                                    console.log('No orders for local date, retrying with UTC date:', utcDate);
                                    const fd2 = new FormData();
                                    fd2.append('archive_type', 'manual');
                                    fd2.append('date_filter', utcDate);

                                    try {
                                        const resp2 = await fetch('/WRSOMS/api/admin/archive_completed.php', { method: 'POST', credentials: 'same-origin', body: fd2 });
                                        const res2 = await resp2.json();
                                        if (!res2.success) throw new Error(res2.message || 'UTC fallback archive failed');
                                        const ordersCount2 = res2.data.orders_archived;
                                        showToast('success', 'Archive Complete', `${ordersCount2} ${ordersCount2 === 1 ? 'order' : 'orders'} archived successfully!`);
                                        loadData();
                                        return;
                                    } catch (err2) {
                                        console.error('Archive UTC fallback error:', err2);
                                        showToast('error', 'Archive Failed', err2.message || 'Failed to archive orders. Please try again.');
                                        return;
                                    }
                                }

                                // Otherwise just show diagnostics to help debugging
                                const ordersCount3 = res.data.orders_archived;
                                showToast('success', 'Archive Complete', `${ordersCount3} ${ordersCount3 === 1 ? 'order' : 'orders'} archived successfully!`);
                                loadData();
                                return;
                            }

                            // Normal success path
                            const ordersCount = res.data.orders_archived;
                            showToast('success', 'Archive Complete', `${ordersCount} ${ordersCount === 1 ? 'order' : 'orders'} archived successfully!`);
                            loadData();
                        })
                        .catch(err => {
                            console.error('Archive error:', err);
                            showToast('error', 'Archive Failed', err.message || 'Failed to archive orders. Please try again.');
                        })
                        .finally(() => {
                            archiveBtn.disabled = false;
                            archiveBtn.innerHTML = '<i class="fa fa-archive"></i> Archive Completed';
                        });
                });
            }
                }); // Close fetchArchivedIds().then() callback
            }; // Close loadData function
        })();
    </script>
</body>
</html>